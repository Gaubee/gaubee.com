<!doctype html><html lang=zh-CN><meta charset=utf-8><title>nodejs的自定义全局模块 · Gaubee</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/css/main.css rel=stylesheet><link href=/webmanifest.json rel=manifest><meta content=#ec407a name=theme-color><link href=/articles.atom rel=alternate title="Gaubee's Articles Atom feed" type=application/atom+xml><link href=/events.atom rel=alternate title="Gaubee's Events Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><header id=header><h1><a href=/ >Gaubee</a></h1><a href=#navigation-toggle id=nav-toggle>显示导航 Show navigation</a><nav><ul><li><a href=/ >主页 Home</a><li class=current><a href=/articles>文章 Articles</a><li><a href=/events>小事件 Events</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>nodejs的自定义全局模块</h1><p class=meta>发布于 <time datetime=2/23/2015 itemprop=datePublished>2/23/2015</time> · 最后修改时间 <time datetime=10/11/2018 itemprop=dateModified>10/11/2018</time> · 标签： <a href=/blog/tags/javascript class=tag>javascript</a> <a href=/blog/tags/cogitation class=tag>cogitation</a></header><div itemprop=articleBody><p>需求如下：<br>写了一个类：<code>function A(){/*...*/}</code>，然后想给他暴露到全局中，作为一个可require的模块，无需再通过路径查找获取。<br>这里推荐三种方法：<br><s>1. 重写require函数，加一层请求拦截的包裹。</s><br>2. 根据process.mainModule.filename来获取对应的node_modules文件夹，在里面创建对应的临时文件来进行链接。<br>3. 将对象注册到底层模块列表中。<br>无论哪种方法，最重要的还是要避免跟系统模块名字冲突。其中第二种有点投机取巧，因为设计到文件的读写，进程意外中断导致文件残留等等不方便的因素导致我并不推荐。<br>而第一种和第三种都要涉及到一个对象：<code>process.binding("natives")</code>；这里返回的将是原生模块的代码。<br>第三种无疑效率最高，实现方法如下：<pre class=language-js><code class=language-js><span class="token keyword">var</span> natives_modules <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">binding</span><span class="token punctuation">(</span><span class="token string">"natives"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">defineAs</span><span class="token punctuation">(</span><span class="token parameter">module_name<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>natives_modules<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>module_name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Module Name has be defined"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> __module_uuid <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    global<span class="token punctuation">[</span>__module_uuid<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">var</span> scriptContent <span class="token operator">=</span> <span class="token string">'module.exports = global["'</span><span class="token operator">+</span>__module_uuid<span class="token operator">+</span><span class="token string">'"]'</span><span class="token punctuation">;</span>
    natives_modules<span class="token punctuation">[</span>module_name<span class="token punctuation">]</span> <span class="token operator">=</span> scriptContent<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//PS：如果你用iojs，__module_uuid可以换成Symbol对象会更好。</span></code></pre><hr><p>不过话说回来，不用require函数名，为这些模块的加载方法另外取名字无疑是最简单粗暴的选择，只是说，使用统一的API，即便是后来你把代码封装发布到npm上，也能使原本的代码好好工作，不是很好么。</div><footer></footer></article></main><footer id=footer><div><nav><a href=https://twitter.com/gaubeebangeel rel="me nofollow" target=_blank>Twitter</a> · <a href=https://github.com/gaubee/gaubee.com/tree/main/./src/articles/nodejs的自定义全局模块.md rel=nofollow target=_blank>Edit this page on GitHub</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>除非有特别的说明, 该站点所有直接内容都使用许可证：<a href=https://creativecommons.org/licenses/by/4.0/deed.zh>署名 4.0 国际 (CC BY 4.0)</a></small><blockquote><small>本网站不收集任何访问者的行为与信息，不做任何商业运作，仅仅为个人使用</small> <small style=display:block><a href=https://beian.miit.gov.cn/#/Integrated/recordQuery>闽ICP备17026139号-1</a></small></blockquote></footer><script src=/js/dark-mode-toggle.mjs type=module></script><script src=/js/time-elements.mjs type=module></script><script src=/js/main.mjs type=module></script>
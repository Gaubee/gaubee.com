<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Promise.race会带来内存泄露 · Gaubee</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/css/main.css rel=stylesheet><link href=/webmanifest.json rel=manifest><meta content=#ec407a name=theme-color><link href=/articles.atom rel=alternate title="Gaubee's Articles Atom feed" type=application/atom+xml><link href=/events.atom rel=alternate title="Gaubee's Events Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><header id=header><h1><a href=/ >Gaubee</a></h1><a href=#navigation-toggle id=nav-toggle>显示导航 Show navigation</a><nav><ul><li><a href=/ >主页 Home</a><li class=current><a href=/articles>文章 Articles</a><li><a href=/events>小事件 Events</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>Promise.race会带来内存泄露</h1><p class=meta>发布于 <time datetime=4/23/2020 itemprop=datePublished>4/23/2020</time> · 最后修改时间 <time datetime=4/23/2020 itemprop=dateModified>4/23/2020</time></header><div itemprop=articleBody><p>假若有两个promise: a, b，现在它们都<code>Promise.race([a,b])</code>所包裹。<br>此时，如果a先完成了resolve，race也就有了返回值。<br>然而，b却迟迟没有被resolve或者reject……<br>结果会带来隐式的内存问题，就是a看上去被释放了，但其实没有。<br>v8论坛上有类似的bug提交：https://bugs.chromium.org/p/v8/issues/detail?id=9858<p>简单地模拟一下实现：<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">race</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>promises</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> p <span class="token keyword">of</span> promises<span class="token punctuation">)</span><span class="token punctuation">{</span>
      p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><p>我实际测试了一下，一些不同版本的v8似乎会有不同的表现，但终归是内存泄漏了，只是好像v12的是直接泄漏了捕捉不到，v13是能在内存堆栈里头看到。<br>我在工作的时候发现这个问题也是靠async_hooks的异步资源监控下才看到这个问题的存在。<p>解决方案其实也不难，核心问题就是消除引用：<ol><li>首先我们需要一个<code>Promise.prototype.safeThen</code>的实现，因为<code>Promise.prototype.then</code>是会返回出一个新的promise的。做法其实就是只使用一次then来代理实现。其返回值就是<code>thened: { resolves: Set&lt;Function>, rejects: Set&lt;Function>, isFinished: boolean }</code><li>接着我们基于<code>safeThen</code>来实现<code>Promise.safePromiseRace</code>，重点在于收集thened对象，并主动进行释放：</ol><pre><code>function safePromiseRace(...promises){
  return new Promise((resolve, reject)=>{
    const thenedList = []
    const finished = ()=>{
      thenedList.forEach(thened=>{
        thened.resolves.delete(safeResolve);
        thened.rejects.delete(safeReject);
      })
    }
    const safeResolve = (v)=>{resolve(v); finished();}
    const safeReject = (v)=>{reject(v); finished();}
    for(const p of promises){
      thenedList.push(p.safeThen(safeResolve, safeReject))
    }
  })
}
</code></pre></div><footer></footer></article></main><footer id=footer><div><nav><a href=https://twitter.com/gaubeebangeel rel="me nofollow" target=_blank>Twitter</a> · <a href=https://github.com/gaubee/gaubee.com/tree/main/./src/articles/Promise.race会带来内存泄露.md rel=nofollow target=_blank>Edit this page on GitHub</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>除非有特别的说明, 该站点所有直接内容都使用许可证：<a href=https://creativecommons.org/licenses/by/4.0/deed.zh>署名 4.0 国际 (CC BY 4.0)</a></small><blockquote><small>本网站不收集任何访问者的行为与信息，不做任何商业运作，仅仅为个人使用</small> <small style=display:block><a href=https://beian.mps.gov.cn/#/query/webSearch>闽ICP备17026139号-1</a></small></blockquote></footer><script src=/js/dark-mode-toggle.mjs type=module></script><script src=/js/time-elements.mjs type=module></script><script src=/js/main.mjs type=module></script>
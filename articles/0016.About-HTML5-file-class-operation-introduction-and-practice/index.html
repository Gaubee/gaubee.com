<!doctype html><html><head><meta charset="utf-8"><meta name="description" content=""><meta name="keywords" content="Appn, WebComponent, article"><meta name="author" content="Gaubee, gaubeebangeel@gmail.com"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=5"><title>关于HTML5的文件类操作入门与实践</title><link rel="shortcut icon" href="/assets/favicon-wB3RD3gX.ico"><link rel="stylesheet" href="/index.css">  <link rel="stylesheet" crossorigin href="/assets/prism-okaidia-D95GE6Gn.css">
<link rel="manifest" href="/manifest.webmanifest"><script id="vite-plugin-pwa:register-sw" src="/registerSW.js"></script></head><body><header class="bg-ani"><style>.nav{padding:0 2em;border-radius:2em;backdrop-filter:contrast(0.5) brightness(2);width:fit-content;max-width:100%}.nav{display:grid;grid-template-columns:repeat(auto-fit,180px);justify-content:center;gap:12px}.nav>a{display:block;flex:1;font-size:18px;padding:16px;text-align:center}.nav>a{color:#e91e63}@supports (-webkit-background-clip:text){.nav>a{background:-webkit-linear-gradient(#e91e63,#673ab7);color:transparent;-webkit-background-clip:text;-webkit-text-fill-color:transparent}}</style><nav class="nav"><a class="" href="/">Home</a> <a class="target" href="/articles/">Articles</a> <a class="" href="/events/">Events</a> <a class="" href="/timeline/">Timeline</a> <a class="" href="/projects/">Projects</a></nav></header><div id="main-wrapper" class="article-wrapper"><main><h1>关于HTML5的文件类操作入门与实践</h1><blockquote><p>文件类的提供使得 JS 能够操作所能获取的各种文件的操作提供支持。 比如 Ajax 获取的文件，input[type='file']选中的文件，或者是用户自己生成的文件等等……。</p></blockquote><p>推荐阅读：<a href="http://www.zhangxinxu.com/wordpress/2013/10/understand-domstring-document-formdata-blob-file-arraybuffer/">理解 DOMString、Document、FormData、Blob、File、ArrayBuffer 数据类型——张鑫旭</a></p><p>本文针对文件读取以及 Blob 对象的简单使用做一个事例。</p><h2>文件读取</h2><ul><li>readAsText：以文字方式读文档內容，放到 result 属性，默认编码 UTF-8。</li><li>readAsDataURL：读取到的內容会编码成 data URL，放到 result 属性。</li><li>readAsArrayBuffer：result 属性会包含一個 ArrayBuffer 物件。</li><li>readAsBinaryString：以二进制方式读文档內容，放到 result 属性。</li></ul><p>上面所说的 result 属性，指的是<a href="https://developer.mozilla.org/en-US/docs/Web/API/FileReader.result"><code>FileReader.result</code></a>。比如下面代码：</p><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span>target <span class="token operator">===</span> reader<span class="token punctuation">;</span>

  reader<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>javaScript 关于异步 API 其实都差不多一个样子。因为本身就是<strong>事件机制</strong>。所以回调中的第一个属性也是 Event 对象。这边属于<a href="https://developer.mozilla.org/en-US/docs/Web/API/ProgressEvent"><code>ProgressEvent</code></a>。而 e.target，指的就是触发发起者，也就是前面定义的 reader。</p><p>如果你要读取一个文本文件。比如说 XML、js、css 文件等等。直接用<code>readAsText</code>，它会把返回的数据用指定编码或者默认编码进行解析，<code>reader.result</code>等同于 Ajax 返回对象的<code>responseText</code>属性。</p><p>readAsDataURL 的话，就是帮你把二进制转化成<code>base64</code>的格式。为此可以<code>reader.result</code>当成图片的 src 直接用、CSS 的 url 属性用等等。</p><p>readAsArrayBuffer 返回的<a href="https://developer.mozilla.org/en-US/docs/Web/API/ArrayBuffer">ArrayBuffer</a>其实也就是最原始的二进制数据。在所给的链接中的文档说介绍的一样，系统并没有提供什么方法来操作二进制文件，连遍历的方法都没有给。 因为是底层的产物，可能它所能做的除了存储数据，就是告诉你数据大小了（比如<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Base64_encoding_and_decoding#Appendix.3A_Decode_a_Base64_string_to_Uint8Array_or_ArrayBuffer">base64DecToArr 的使用</a>），当然，它最多的用途就是用来做其它 API 的参数使用，比如 Ajax 异步上传文件。</p><p>而 readAsBinaryString，则将 ArrayBuffer 转化为原生的 String 类型，为此能够操纵文件的具体内容。而不再只是孤零零地盯着 ArrayBuffer 什么也干不了。为此你可以用来做文件的安全性检测，检查文件类型时候正确等等等等，比如说我可以查找一个图片的信息，如果有 PS 处理过的痕迹，可以很清晰地看到想关信息：</p><p><img src="/assets/capture-1-DrTslAOb.png" alt="image"></p><h2>Blob 对象</h2><p>在文章最前面的<strong>推荐阅读</strong>中就已经很清晰地介绍了 Blob 对象，在我眼中，它就是一个文件。 为此我得到了<strong>创建一个文件的权限</strong>。 比如在 Web Worker 中，它需要一个 js 文件地址，而你不想真的用一个文件去记录这些代码，兴许太麻烦了，毕竟不利于压缩什么的各种借口。这时你就可以用 Blob 来实现。（注意：以前你可能看过 BlobBuilder 之类的 API，但已经被废弃，请用标准的 API，类似的 shim 也是有的）</p><p>下面就用一个简单的<strong>综合应用</strong>来展示 Blob 的使用</p><h2>综合应用</h2><p>这代码是来自我的一个项目，因为要用到<strong>字体的上传与预览</strong>，为此在选中字体文件后需要做一个预览字体一样的功能，就像预览图片一样。</p><p>但是不同的是，字体的预览需要动态生成样式表。</p><p>所以你可以使用 Blob 来生成一个新的 css 文件，而后通过<code>&lt;link&gt;</code>标签引入使用。</p><p>这边介绍直接在 head 中插入 style 标签的方法，思路一样：</p><pre class="language-js"><code class="language-js"><span class="token comment">//file对象来自input的change事件中event.target.files的元素</span>

<span class="token keyword">var</span> fontInfo <span class="token operator">=</span> file<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> postfix <span class="token operator">=</span> fontInfo<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fontName <span class="token operator">=</span> fontInfo<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> postfix<span class="token punctuation">;</span>
<span class="token comment">// 这边支持两种字体格式 ttf 和 woff</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>postfix <span class="token operator">===</span> <span class="token string">"ttf"</span> <span class="token operator">||</span> postfix <span class="token operator">===</span> <span class="token string">"woff"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// type: "application/x-font-" + postfix</span>
      <span class="token comment">// type: "font/" + postfix</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"application/octet-stream"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> tempStyleElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"style"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//w3c</span>
    tempStyleElement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"text/css"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">"head"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>tempStyleElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//样式表内容</span>
    <span class="token keyword">var</span> formatType <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">ttf</span><span class="token operator">:</span> <span class="token string">"truetype"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">woff</span><span class="token operator">:</span> <span class="token string">"woff"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> styleText <span class="token operator">=</span>
      <span class="token string">"\
@font-face { \
    font-family:"</span> <span class="token operator">+</span>
      <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>fontName<span class="token punctuation">)</span> <span class="token operator">+</span>
      <span class="token string">"; \
    src: url("</span> <span class="token operator">+</span>
      url <span class="token operator">+</span>
      <span class="token string">") format('"</span> <span class="token operator">+</span>
      formatType<span class="token punctuation">[</span>postfix<span class="token punctuation">]</span> <span class="token operator">+</span>
      <span class="token string">"'); \
    font-weight: normal; \
    font-style: normal; \
} \
            "</span><span class="token punctuation">;</span>
    tempStyleElement<span class="token punctuation">.</span>textContent <span class="token operator">=</span> styleText<span class="token punctuation">;</span>
    vm<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"content.layerAttr.fontFamily"</span><span class="token punctuation">,</span> fontName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vm<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"$PRIVATE.reDrawLayer"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  reader<span class="token punctuation">.</span><span class="token function">readAsBinaryString</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"只允许字体文件！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>补注：reader.readAsDataURL 所生成的 base64 格式是<code>src:url</code>所能直接支持的。但是如果字体文件过大，styleText 也会非常庞大，内存消耗不说，<code>tempStyleElement.textContent = styleText;</code>这段代码就要卡上一两秒。所以需要用 Blob 生成一个 blog-url 来替代庞大的文件数据。</p></blockquote></main></div><style>footer a{line-height:1}footer nav{display:flex;gap:1rem}</style><footer class="bg-ani"><nav><a target="_blank" href="https://github.com/gaubee/gaubee.com">Github</a> <a target="_blank" href="https://beian.miit.gov.cn/#/Integrated/recordQuery">闽ICP备17026139号-1</a></nav></footer></body></html>
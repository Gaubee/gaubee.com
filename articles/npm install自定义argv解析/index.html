<!doctype html><html lang=zh-CN><meta charset=utf-8><title>npm install自定义argv解析 · Gaubee</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/css/main.css rel=stylesheet><link href=/webmanifest.json rel=manifest><meta content=#ec407a name=theme-color><link href=/articles.atom rel=alternate title="Gaubee's Articles Atom feed" type=application/atom+xml><link href=/events.atom rel=alternate title="Gaubee's Events Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><header id=header><h1><a href=/ >Gaubee</a></h1><a href=#navigation-toggle id=nav-toggle>显示导航 Show navigation</a><nav><ul><li><a href=/ >主页 Home</a><li class=current><a href=/articles>文章 Articles</a><li><a href=/events>小事件 Events</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>npm install自定义argv解析</h1><p class=meta>发布于 <time datetime=2/28/2016 itemprop=datePublished>2/28/2016</time> · 最后修改时间 <time datetime=2/28/2016 itemprop=dateModified>2/28/2016</time></header><div itemprop=articleBody><h2 id=%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0%E4%B8%8E%E8%A7%A3%E5%86%B3%E7%9A%84%E6%96%B9%E5%90%91 tabindex=-1><a href=#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0%E4%B8%8E%E8%A7%A3%E5%86%B3%E7%9A%84%E6%96%B9%E5%90%91 class=header-anchor>问题描述与解决的方向</a></h2><p>问题来着一下这种需求出现的时候：<p>一个包，要面对不同的用户：Client 与 Server。<p>由于这个包中 Client 与 Server 共用部分代码，如果要拆分成 Client 包与 Server 包的话，那么就还要有一个公共 Common 包。<p>所以要实现以下效果：<p>默认为安装 Client 的包<pre><code>npm install my_npm_pkg
</code></pre><p>增加<code>--server</code>参数为安装 Server 的包<pre><code>npm instal my_npm_pkg --server
</code></pre><h2 id=%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3 tabindex=-1><a href=#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3 class=header-anchor>参考文档</a></h2><p>在<a href=https://docs.npmjs.com/misc/scripts#environment>ENVIRONMENT</a>环节中有讲到 package.json 文件在 npm 命令运行的时候，相关的配置以及参数会被拍扁，变成环境变量。<figure><img alt="" height=184 loading=lazy src=/img/npm-install-with-argv/package-json-vars.png width=696><figcaption>image</figcaption></figure><p>其中就包括这个字段：<code>npm_config_argv</code><br>这个是一个 JSON 数据，里面包含了<code>npm</code>指令执行时的参数：<pre class=language-js><code class=language-js><span class="token keyword">const</span> npm_argv <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>npm_config_argv<span class="token punctuation">)</span><span class="token punctuation">;</span><br>npm_argv <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">;</span> <span class="token comment">//true  ["npm", "instal", "my_npm_pkg", "--server"]</span></code></pre><h2 id=demo-%E4%BB%A3%E7%A0%81%EF%BC%9A tabindex=-1><a href=#demo-%E4%BB%A3%E7%A0%81%EF%BC%9A class=header-anchor>DEMO 代码：</a></h2><figure><img alt="" height=264 loading=lazy src=/img/npm-install-with-argv/demo-capture-1.png width=397><figcaption>image</figcaption></figure><figure><img alt="" height=87 loading=lazy src=/img/npm-install-with-argv/demo-capture-2.png width=495><figcaption>image</figcaption></figure><figure><img alt="" height=227 loading=lazy src=/img/npm-install-with-argv/demo-capture-3.png width=764><figcaption>image</figcaption></figure><h2 id=%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98%E4%BB%A3%E7%A0%81%EF%BC%9A tabindex=-1><a href=#%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98%E4%BB%A3%E7%A0%81%EF%BC%9A class=header-anchor>解决问题代码：</a></h2><pre class=language-js><code class=language-js><span class="token keyword">const</span> exec <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"child_process"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exec<span class="token punctuation">;</span><br><span class="token keyword">const</span> npm_argv <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>npm_config_argv <span class="token operator">||</span> <span class="token string">"{}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>npm_argv <span class="token operator">&&</span> npm_argv<span class="token punctuation">.</span>original <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">throw</span> <span class="token function">TypeError</span><span class="token punctuation">(</span><span class="token string">"npm argv Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异常的抛出会终止npm install命令</span><br><span class="token punctuation">}</span><br><span class="token keyword">if</span> <span class="token punctuation">(</span>npm_argv<span class="token punctuation">.</span>original<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"--server"</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"install dependencies: mongodb."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string template-punctuation">`</span><span class="token string">cd </span><span class="token interpolation"><span class="token punctuation interpolation-punctuation">${</span>__dirname<span class="token punctuation interpolation-punctuation">}</span></span><span class="token string"> && npm install mongodb</span><span class="token string template-punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 安装依赖</span><br>  child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  child<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre></div><footer></footer></article></main><footer id=footer><div><nav><a href=https://twitter.com/gaubeebangeel rel="me nofollow" target=_blank>Twitter</a> · <a href="https://github.com/gaubee/gaubee.com/tree/main/./src/articles/npm install自定义argv解析.md" rel=nofollow target=_blank>Edit this page on GitHub</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>除非有特别的说明, 该站点所有直接内容都使用许可证：<a href=https://creativecommons.org/licenses/by/4.0/deed.zh>署名 4.0 国际 (CC BY 4.0)</a></small><blockquote><small>本网站不收集任何访问者的行为与信息，不做任何商业运作，仅仅为个人使用</small></blockquote></footer><script src=/js/dark-mode-toggle.mjs type=module></script><script src=/js/time-elements.mjs type=module></script><script src=/js/main.mjs type=module></script>
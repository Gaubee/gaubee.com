<!doctype html><html lang=zh-CN><meta charset=utf-8><title>推荐一个同步两地代码的东西 · Gaubee</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/css/main.css rel=stylesheet><link href=/webmanifest.json rel=manifest><meta content=#ec407a name=theme-color><link href=/articles.atom rel=alternate title="Gaubee's Articles Atom feed" type=application/atom+xml><link href=/events.atom rel=alternate title="Gaubee's Events Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><header id=header><h1><a href=/ >Gaubee</a></h1><a href=#navigation-toggle id=nav-toggle>显示导航 Show navigation</a><nav><ul><li><a href=/ >主页 Home</a><li class=current><a href=/articles>文章 Articles</a><li><a href=/events>小事件 Events</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>推荐一个同步两地代码的东西</h1><p class=meta>发布于 <time datetime=10/13/2016 itemprop=datePublished>10/13/2016</time> · 最后修改时间 <time datetime=10/13/2016 itemprop=dateModified>10/13/2016</time></header><div itemprop=articleBody><p>以前开发，是使用金山快盘，但是这软件停止了维护。后来就没用了。<br>这个同步需求发生在最近写Typescript的时候，感觉本地编译很吃CPU，有时候浏览器开着运行Canvas就要吃掉我双核四线程60%+的CPU了，这时候再编译Typescript，搞得两边都很卡。<br>所以就想着能不能用另外一台电脑单纯替代我本地的编译这一方面的工作。<p>一开始的想法是自己写一个服务同步两台电脑的脚本，后来想想预感会踩很多坑，所以就果断放弃这个想法， Google搜不出我要的软件，就上Github搜索了以下，结果就找到了这个：<a href=https://github.com/syncthing/syncthing/ >syncthing</a><p>跑起来后试用感觉很不错，唯一的不满就是，它是以轮询的方式来查看文件变动。不过开源软件给出API，所以就写了一个nodejs脚本来自动触发同步选项。<p>代码下面贴出，我默认是<strong>放在代码所在目录</strong>下：<pre class=language-js><code class=language-js><span class="token comment">// .syncthing.js</span><br><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"child_process"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> ignore_keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"/ace"</span><span class="token punctuation">,</span> <span class="token string">"/js/lib"</span><span class="token punctuation">,</span> <span class="token string">"/typings"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 不参与监听的，注意这里不是目录，只是简单的字符串匹配，也就是说如果目录名有这个字符串的话就不监听。</span><br><span class="token keyword">var</span> watch_deep <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// 监听的目录深度，int > 1。为了缩减代码所以就没有用fs的API</span><br><span class="token keyword">var</span> watch_dirs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"./"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> ls_exec <span class="token operator">=</span> <span class="token string">"ls -d ."</span><span class="token punctuation">;</span><span class="token comment">// 如果你的代码目录不深，或者需要监听所有的目录，可以直接用ls -R，不过你要自己编写代码处理输出的格式，这里不赘述（PS：我就是偷懒不想多写代码）</span><br><span class="token keyword">do</span> <span class="token punctuation">{</span><br>    ls_exec <span class="token operator">+=</span> <span class="token string">"/*"</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> dirs <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">execSync</span><span class="token punctuation">(</span>ls_exec<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">foldername</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>foldername<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ignore_keys<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">ignore_key</span> <span class="token operator">=></span> foldername<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>ignore_key<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token keyword">return</span> <span class="token boolean">false</span><br>            <span class="token punctuation">}</span><br>            <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">lstatSync</span><span class="token punctuation">(</span>foldername<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    watch_dirs <span class="token operator">=</span> watch_dirs<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>dirs<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>watch_deep <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string template-punctuation">`</span><span class="token string">监听以下目录：\n  </span><span class="token interpolation"><span class="token punctuation interpolation-punctuation">${</span>watch_dirs<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"\n  "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation interpolation-punctuation">}</span></span><span class="token string template-punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> syncthing_exec_server <span class="token operator">=</span> <span class="token template-string"><span class="token string template-punctuation">`</span><span class="token string">curl -X POST -H "X-API-Key:Tqp***********到设置中找******und" http://[服务端或者局域网IP，记得到设置中设置]:8384/rest/db/scan?folder=[文件夹 ID]</span><span class="token string template-punctuation">`</span></span><span class="token punctuation">;</span><br><span class="token keyword">const</span> syncthing_exec_client <span class="token operator">=</span> <span class="token template-string"><span class="token string template-punctuation">`</span><span class="token string">curl -X POST -H "X-API-Key:E5x***********到设置中找*****7o5J" http://localhost:8384/rest/db/scan?folder=[文件夹 ID]</span><span class="token string template-punctuation">`</span></span><span class="token punctuation">;</span><br><span class="token keyword">var</span> is_server <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">;</span><br><span class="token keyword">if</span> <span class="token punctuation">(</span>is_server<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"s"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"启用服务端同步指令"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> syncthing_exec <span class="token operator">=</span> syncthing_exec_server<br><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"启用客户端同步指令"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    syncthing_exec <span class="token operator">=</span> syncthing_exec_client<br><span class="token punctuation">}</span><br>watch_dirs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">dir</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    fs<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        child_process<span class="token punctuation">.</span><span class="token function">execSync</span><span class="token punctuation">(</span>syncthing_exec<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><hr><p>准备工作做好后就可以，剩下要做的就是：<br>1, 开启_客户端_和_编译端_的syncthing<br>2. 运行上面的代码：<code>node .syncthing.js</code><br>3. 编译端启动编译：运行<code>tsc -w -p .</code>。或者你可以执行自己的sass编译等等类似的烧CPU工作。</div><footer></footer></article></main><footer id=footer><div><nav><a href=https://twitter.com/gaubeebangeel rel="me nofollow" target=_blank>Twitter</a> · <a href=https://github.com/gaubee/gaubee.com/tree/main/./src/articles/推荐一个同步两地代码的东西.md rel=nofollow target=_blank>Edit this page on GitHub</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>除非有特别的说明, 该站点所有直接内容都使用许可证：<a href=https://creativecommons.org/licenses/by/4.0/deed.zh>署名 4.0 国际 (CC BY 4.0)</a></small><blockquote><small>本网站不收集任何访问者的行为与信息，不做任何商业运作，仅仅为个人使用</small></blockquote></footer><script src=/js/dark-mode-toggle.mjs type=module></script><script src=/js/time-elements.mjs type=module></script><script src=/js/main.mjs type=module></script>
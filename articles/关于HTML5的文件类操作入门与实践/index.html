<!doctype html><html lang=zh-CH><meta charset=utf-8><title>关于HTML5的文件类操作入门与实践 · Gaubee</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/css/main.css rel=stylesheet><link href=/webmanifest.json rel=manifest><meta content=#ec407a name=theme-color><link href=/articles.atom rel=alternate title="Gaubee's Articles Atom feed" type=application/atom+xml><link href=/events.atom rel=alternate title="Gaubee's Events Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><header id=header><h1><a href=/ >Gaubee</a></h1><a href=#navigation-toggle id=nav-toggle>显示导航 Show navigation</a><nav><ul><li><a href=/ >主页 Home</a><li class=current><a href=/articles>文章 Articles</a><li><a href=/events>小事件 Events</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>关于HTML5的文件类操作入门与实践</h1><p class=meta>发布于 <time datetime=2/17/2014 itemprop=datePublished>2/17/2014</time> · 最后修改时间 <time datetime=2/17/2014 itemprop=dateModified>2/17/2014</time></header><div itemprop=articleBody><blockquote><p>文件类的提供使得 JS 能够操作所能获取的各种文件的操作提供支持。<br>比如 Ajax 获取的文件，input[type='file']选中的文件，或者是用户自己生成的文件等等……。</blockquote><p>推荐阅读：<a href=http://www.zhangxinxu.com/wordpress/2013/10/understand-domstring-document-formdata-blob-file-arraybuffer/ >理解 DOMString、Document、FormData、Blob、File、ArrayBuffer 数据类型——张鑫旭</a><p>本文针对文件读取以及 Blob 对象的简单使用做一个事例。<h2 id=%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96 tabindex=-1><a href=#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96 class=header-anchor>文件读取</a></h2><ul><li>readAsText：以文字方式读文档內容，放到 result 属性，默认编码 UTF-8。<li>readAsDataURL：读取到的內容会编码成 data URL，放到 result 属性。<li>readAsArrayBuffer：result 属性会包含一個 ArrayBuffer 物件。<li>readAsBinaryString：以二进制方式读文档內容，放到 result 属性。</ul><p>上面所说的 result 属性，指的是<a href=https://developer.mozilla.org/en-US/docs/Web/API/FileReader.result><code>FileReader.result</code></a>。比如下面代码：<pre class=language-js><code class=language-js><span class="token keyword">var</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>reader<span class="token punctuation">.</span><span class="token function function-variable">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  e<span class="token punctuation">.</span>target <span class="token operator">===</span> reader<span class="token punctuation">;</span><br><br>  reader<span class="token punctuation">.</span>result<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>javaScript 关于异步 API 其实都差不多一个样子。因为本身就是<strong>事件机制</strong>。所以回调中的第一个属性也是 Event 对象。这边属于<a href=https://developer.mozilla.org/en-US/docs/Web/API/ProgressEvent><code>ProgressEvent</code></a>。而 e.target，指的就是触发发起者，也就是前面定义的 reader。<p>如果你要读取一个文本文件。比如说 XML、js、css 文件等等。直接用<code>readAsText</code>，它会把返回的数据用指定编码或者默认编码进行解析，<code>reader.result</code>等同于 Ajax 返回对象的<code>responseText</code>属性。<p>readAsDataURL 的话，就是帮你把二进制转化成<code>base64</code>的格式。为此可以<code>reader.result</code>当成图片的 src 直接用、CSS 的 url 属性用等等。<p>readAsArrayBuffer 返回的<a href=https://developer.mozilla.org/en-US/docs/Web/API/ArrayBuffer>ArrayBuffer</a>其实也就是最原始的二进制数据。在所给的链接中的文档说介绍的一样，系统并没有提供什么方法来操作二进制文件，连遍历的方法都没有给。<br>因为是底层的产物，可能它所能做的除了存储数据，就是告诉你数据大小了（比如<a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Base64_encoding_and_decoding#Appendix.3A_Decode_a_Base64_string_to_Uint8Array_or_ArrayBuffer>base64DecToArr 的使用</a>），当然，它最多的用途就是用来做其它 API 的参数使用，比如 Ajax 异步上传文件。<p>而 readAsBinaryString，则将 ArrayBuffer 转化为原生的 String 类型，为此能够操纵文件的具体内容。而不再只是孤零零地盯着 ArrayBuffer 什么也干不了。为此你可以用来做文件的安全性检测，检查文件类型时候正确等等等等，比如说我可以查找一个图片的信息，如果有 PS 处理过的痕迹，可以很清晰地看到想关信息：<figure><img alt="" height=167 loading=lazy src=/img/html5-file-api-intro/capture-1.png width=536><figcaption>image</figcaption></figure><h2 id=blob-%E5%AF%B9%E8%B1%A1 tabindex=-1><a href=#blob-%E5%AF%B9%E8%B1%A1 class=header-anchor>Blob 对象</a></h2><p>在文章最前面的<strong>推荐阅读</strong>中就已经很清晰地介绍了 Blob 对象，在我眼中，它就是一个文件。<br>为此我得到了<strong>创建一个文件的权限</strong>。<br>比如在 Web Worker 中，它需要一个 js 文件地址，而你不想真的用一个文件去记录这些代码，兴许太麻烦了，毕竟不利于压缩什么的各种借口。这时你就可以用 Blob 来实现。（注意：以前你可能看过 BlobBuilder 之类的 API，但已经被废弃，请用标准的 API，类似的 shim 也是有的）<p>下面就用一个简单的<strong>综合应用</strong>来展示 Blob 的使用<h2 id=%E7%BB%BC%E5%90%88%E5%BA%94%E7%94%A8 tabindex=-1><a href=#%E7%BB%BC%E5%90%88%E5%BA%94%E7%94%A8 class=header-anchor>综合应用</a></h2><p>这代码是来自我的一个项目，因为要用到<strong>字体的上传与预览</strong>，为此在选中字体文件后需要做一个预览字体一样的功能，就像预览图片一样。<p>但是不同的是，字体的预览需要动态生成样式表。<p>所以你可以使用 Blob 来生成一个新的 css 文件，而后通过<code>&lt;link></code>标签引入使用。<p>这边介绍直接在 head 中插入 style 标签的方法，思路一样：<pre class=language-js><code class=language-js><span class="token comment">//file对象来自input的change事件中event.target.files的元素</span><br><br><span class="token keyword">var</span> fontInfo <span class="token operator">=</span> file<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> postfix <span class="token operator">=</span> fontInfo<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> fontName <span class="token operator">=</span> fontInfo<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> postfix<span class="token punctuation">;</span><br><span class="token comment">// 这边支持两种字体格式 ttf 和 woff</span><br><span class="token keyword">if</span> <span class="token punctuation">(</span>postfix <span class="token operator">===</span> <span class="token string">"ttf"</span> <span class="token operator">||</span> postfix <span class="token operator">===</span> <span class="token string">"woff"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  reader<span class="token punctuation">.</span><span class="token function function-variable">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>      <span class="token comment">// type: "application/x-font-" + postfix</span><br>      <span class="token comment">// type: "font/" + postfix</span><br>      type<span class="token operator">:</span> <span class="token string">"application/octet-stream"</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> tempStyleElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"style"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//w3c</span><br>    tempStyleElement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"text/css"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">"head"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>tempStyleElement<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">//样式表内容</span><br>    <span class="token keyword">var</span> formatType <span class="token operator">=</span> <span class="token punctuation">{</span><br>      ttf<span class="token operator">:</span> <span class="token string">"truetype"</span><span class="token punctuation">,</span><br>      woff<span class="token operator">:</span> <span class="token string">"woff"</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> styleText <span class="token operator">=</span><br>      <span class="token string">"\<br>@font-face { \<br>    font-family:"</span> <span class="token operator">+</span><br>      <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>fontName<span class="token punctuation">)</span> <span class="token operator">+</span><br>      <span class="token string">"; \<br>    src: url("</span> <span class="token operator">+</span><br>      url <span class="token operator">+</span><br>      <span class="token string">") format('"</span> <span class="token operator">+</span><br>      formatType<span class="token punctuation">[</span>postfix<span class="token punctuation">]</span> <span class="token operator">+</span><br>      <span class="token string">"'); \<br>    font-weight: normal; \<br>    font-style: normal; \<br>} \<br>            "</span><span class="token punctuation">;</span><br>    tempStyleElement<span class="token punctuation">.</span>textContent <span class="token operator">=</span> styleText<span class="token punctuation">;</span><br>    vm<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"content.layerAttr.fontFamily"</span><span class="token punctuation">,</span> fontName<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    vm<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"$PRIVATE.reDrawLayer"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  reader<span class="token punctuation">.</span><span class="token function">readAsBinaryString</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"只允许字体文件！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><blockquote><p>补注：reader.readAsDataURL 所生成的 base64 格式是<code>src:url</code>所能直接支持的。但是如果字体文件过大，styleText 也会非常庞大，内存消耗不说，<code>tempStyleElement.textContent = styleText;</code>这段代码就要卡上一两秒。所以需要用 Blob 生成一个 blog-url 来替代庞大的文件数据。</blockquote></div><footer></footer></article></main><footer id=footer><div><nav><a href=https://twitter.com/gaubeebangeel rel="me nofollow" target=_blank>Twitter</a> · <a href=https://github.com/gaubee/gaubee.com/tree/main/./src/articles/关于HTML5的文件类操作入门与实践.md rel=nofollow target=_blank>Edit this page on GitHub</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>除非有特别的说明, 该站点所有直接内容都使用许可证：<a href=https://creativecommons.org/licenses/by/4.0/deed.zh>署名 4.0 国际 (CC BY 4.0)</a></small><blockquote><small>本网站不收集任何访问者的行为与信息，不做任何商业运作，仅仅为个人使用</small></blockquote></footer><script src=/js/dark-mode-toggle.mjs type=module></script><script src=/js/time-elements.mjs type=module></script><script src=/js/main.mjs type=module></script>
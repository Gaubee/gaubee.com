<!doctype html><html lang=zh-CH><meta charset=utf-8><title>PIXI实现粗虚线绘制 · Gaubee</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/css/main.css rel=stylesheet><link href=/webmanifest.json rel=manifest><meta content=#ec407a name=theme-color><link href=/articles.atom rel=alternate title="Gaubee's Articles Atom feed" type=application/atom+xml><link href=/events.atom rel=alternate title="Gaubee's Events Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><header id=header><h1><a href=/ >Gaubee</a></h1><a href=#navigation-toggle id=nav-toggle>显示导航 Show navigation</a><nav><ul><li><a href=/ >主页 Home</a><li class=current><a href=/articles>文章 Articles</a><li><a href=/events>小事件 Events</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>PIXI实现粗虚线绘制</h1><p class=meta>发布于 <time datetime=7/29/2016 itemprop=datePublished>7/29/2016</time> · 最后修改时间 <time datetime=7/29/2016 itemprop=dateModified>7/29/2016</time></header><div itemprop=articleBody><p>好久没写博文，今天打卡。<br>主题关于 canvas 虚线的绘制，或者说是一定路径的无限循环贴图的绘制，比如龙、蛇的身体绘制等等，网上都没有相关的实现，外国论坛也没有，所以索性就总结一下难点重点。<p>这里是围绕 PIXI 的接口来实现。<p>首先是准备的有：<ol><li>一条线的一组点<li>要进行无限循环的贴图</ol><p>实现需要基于<a href=https://pixijs.github.io/docs/PIXI.mesh.Mesh.html>PIXI.mesh.Mesh</a>这个类来实现。<br>需要传入的参数有：texture, vertices, uvs, indices。（drawMode 使用原本默认即可）<ul><li>texture 贴图对象 PIXI.Texutre<li>vertices 顶点对象 Float32Array，默认是[0, 0, 100, 0, 100, 100, 0, 100]<li>uvs 顶点贴图信息 Float32Array，0~1，代表贴图两个边缘，默认是[0, 0, 1, 0, 1, 1, 0, 1]<li>indices 顶点顺序 Uint16Array，默认是[0，1，3，2]，代表一个长方形的绘制，那么会被绘制成两个三角形，分别是 0,1,2 和 1,3,2 。而这里的顶点顺序则拿去代表 vertices 数据的顺序，简单用程序表示那就是：<code>indices.map((v,i)=>[ indices[i],indices[i+1],indices[i+2] ])</code>，有这个数据我们通常用来把重复点的数据合并成一个重复使用。</ul><h2 id=vertices-%E7%9A%84%E8%8E%B7%E5%8F%96 tabindex=-1><a href=#vertices-%E7%9A%84%E8%8E%B7%E5%8F%96 class=header-anchor>vertices 的获取</a></h2><p>看这样一张图来说明 vertices, indices 这两个变量的默认值：<figure><img alt="" height=309 loading=lazy src=/img/pixi-dash-line/vertices-and-indices.png width=333><figcaption>Figure 1: vertices and indices</figcaption></figure><p>如图，首先把 vertices 的数据中的顶点 4 个坐标点出，每两个数据为一组数据点 x,y，这里一共四个点。<br>然后这四个点如何连成三角形？上面提到点的顺序必须是 0,1,2 然后 1,2,3。如果还有更多，那就是 2,3,4，如此下去，就形成三角网状结构。而 indices 参数就是用来指出这四个点的顺序。默认是[0，1，3，2]，那么就得到一下顺序：<figure><img alt="" height=260 loading=lazy src=/img/pixi-dash-line/connect-vertices.png width=419><figcaption>Figure:connect vertices</figcaption></figure><p>而 uvs，则是指出这个点在贴图中的百分比，和 vertices 一样，没两个数据为一组数据点 x,y。<p>所以根据这个规律，来实现贴图的无限循环。<br>为了简单，我们这里将 indices 直接定为 0,1,2,3,4,5,6,7,8.....<br>接下来会涉及到大量算法代码，我不贴出代码了，就说一下重点难点的思路：<br>其中最重要的是线段加粗算法，比如下图的三个点所组成的线段：<figure><img alt="" height=241 loading=lazy src=/img/pixi-dash-line/point-to-segment.png width=417><figcaption>Figure:point to segment</figcaption></figure><p>我们 可以很直接的得出这样的贴图顶点。<br>这里推荐一种思路：点画圆：<figure><img alt="" height=454 loading=lazy src=/img/pixi-dash-line/circle-to-line.png width=607><figcaption>Figure:circle to line</figcaption></figure><p>如图，除了首位两个点是取与相邻点的法线与圆的交点外，其余的点，取法如图所示，直接取两圆交点所在弧 间点，化成数学就是这样的算法：左右两点的法线所在线上取两点，这两点与中间点的距离相等<figure><img alt="" height=349 loading=lazy src=/img/pixi-dash-line/circle-to-line-math.png width=419><figcaption>Figure:circle to line</figcaption></figure><blockquote><p>不过我有一个不是很理解的问题，就是贴图交织的问题，不知道如何解决：如果遇到这种情况呢？<figure><img alt="" height=254 loading=lazy src=/img/pixi-dash-line/texture-mess-up.png width=373><figcaption>Figure:texture mess up</figcaption></figure><p>图片估计看得很奇怪，奇怪就够了，因为贴图已经不是按照我想要的交织在一起，因为蛇、龙的身体在扭曲后，并不是后面的贴图把前面的覆盖了，而是把扭曲的部分合并在一起了。这里的问题就是这条线加粗后，如何正确的取到它两边的点。</blockquote><h2 id=uvs-%E7%9A%84%E8%8E%B7%E5%8F%96 tabindex=-1><a href=#uvs-%E7%9A%84%E8%8E%B7%E5%8F%96 class=header-anchor>uvs 的获取</a></h2><p>说完 vertices 这个变量的取值方法，还有一个难点就是 uvs 的问题，uvs 取值 0~1，如何是我们需求提到的虚线、蛇、龙等，那么 y 方向的都是 0，1 即可。x 方向就变成要根据点与点的距离来手动计算了。<br>要注意的是如果在从 0 递增到 1 后，接下来，要进行一次反转，然后才能从 0 再重新开始，如下面图：<figure><img alt="" height=318 loading=lazy src=/img/pixi-dash-line/vertices-order.png width=451><figcaption>Figure:vertices order</figcaption></figure><p>如果不进行反转，那么就会发生 1,0 | 1,1 | 0,0 三个点画了一个三角形，这个三角形明显就是贴图镜像效果，如何避免，我们可以在 1,0 | 1,1 这两个点的坐标上面直接加上 0,0 | 1,0。效果就等于在看不到的地方直接进行了反转，避免镜像贴图的出现，如图：（PS：这里的重复点可以用 indices 来实现）<figure><img alt="" height=299 loading=lazy src=/img/pixi-dash-line/vertices-fixed-order.png width=445><figcaption>Figure:vertices fixed order</figcaption></figure><p>还有一个问题就是补点的问题，两点之间的距离不一定，我们要保持贴图的比例，就要确保两 uvs 的值要和两点之间的距离来确定。当 uvs 累计到>=1 的时候，就要在 uvs 为 1 的地方补点。如何实现我就不赘述了，实现不难。<br>我这里讲一个另外一种脏方法，可以免去补点的问题。就是用 svg 的 path 对象，我们将线绘制到 path 对象上后调用接口就是 getPointAtLength(number)。贴图宽高知道的情况下，可以获取指定长度来取到对应的点的坐标。这样就免去补点的麻烦了。<blockquote><h2 id=%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%9A%84%E5%85%89%E6%BB%91 tabindex=-1><a href=#%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%9A%84%E5%85%89%E6%BB%91 class=header-anchor>实现线的光滑</a></h2><p>既然用到了 svg，这里顺便贴出点光滑的实现代码：<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">getAnchors</span><span class="token punctuation">(</span><span class="token parameter">p1x<span class="token punctuation">,</span> p1y<span class="token punctuation">,</span> p2x<span class="token punctuation">,</span> p2y<span class="token punctuation">,</span> p3x<span class="token punctuation">,</span> p3y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> is_turn <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>p3x <span class="token operator">&lt;</span> p1x<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    is_turn <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">var</span> l1 <span class="token operator">=</span> <span class="token punctuation">(</span>p2x <span class="token operator">-</span> p1x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span><br>    l2 <span class="token operator">=</span> <span class="token punctuation">(</span>p3x <span class="token operator">-</span> p2x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span><br>    a <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">atan</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p2x <span class="token operator">-</span> p1x<span class="token punctuation">)</span> <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>p2y <span class="token operator">-</span> p1y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    b <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">atan</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p3x <span class="token operator">-</span> p2x<span class="token punctuation">)</span> <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>p2y <span class="token operator">-</span> p3y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  a <span class="token operator">=</span> p1y <span class="token operator">&lt;</span> p2y <span class="token operator">?</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">-</span> a <span class="token operator">:</span> a<span class="token punctuation">;</span><br>  b <span class="token operator">=</span> p3y <span class="token operator">&lt;</span> p2y <span class="token operator">?</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">-</span> b <span class="token operator">:</span> b<span class="token punctuation">;</span><br>  <span class="token keyword">var</span> alpha <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span><br>    dx1 <span class="token operator">=</span> l1 <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>alpha <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    dy1 <span class="token operator">=</span> l1 <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>alpha <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    dx2 <span class="token operator">=</span> l2 <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>alpha <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    dy2 <span class="token operator">=</span> l2 <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>alpha <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">{</span><br>    x1<span class="token operator">:</span> p2x <span class="token operator">-</span> dx1 <span class="token operator">*</span> is_turn<span class="token punctuation">,</span><br>    y1<span class="token operator">:</span> p2y <span class="token operator">+</span> dy1 <span class="token operator">*</span> is_turn<span class="token punctuation">,</span><br>    x2<span class="token operator">:</span> p2x <span class="token operator">+</span> dx2 <span class="token operator">*</span> is_turn<span class="token punctuation">,</span><br>    y2<span class="token operator">:</span> p2y <span class="token operator">+</span> dy2 <span class="token operator">*</span> is_turn<span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token keyword">var</span> pathNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElementNS</span><span class="token punctuation">(</span><span class="token string">"http://www.w3.org/2000/svg"</span><span class="token punctuation">,</span> <span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>pathNode<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><br>  <span class="token string">"d"</span><span class="token punctuation">,</span><br>  points<br>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">point<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token punctuation">(</span><br>          <span class="token string">"M "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token string">"C "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>y<br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">var</span> pre_point <span class="token operator">=</span> points<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>        <span class="token keyword">var</span> nex_point <span class="token operator">=</span> points<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>        <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">getAnchors</span><span class="token punctuation">(</span><br>          pre_point<span class="token punctuation">.</span>x<span class="token punctuation">,</span><br>          pre_point<span class="token punctuation">.</span>y<span class="token punctuation">,</span><br>          point<span class="token punctuation">.</span>x<span class="token punctuation">,</span><br>          point<span class="token punctuation">.</span>y<span class="token punctuation">,</span><br>          nex_point<span class="token punctuation">.</span>x<span class="token punctuation">,</span><br>          nex_point<span class="token punctuation">.</span>y<br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span> <span class="token punctuation">(</span><br>          a<span class="token punctuation">.</span>x1 <span class="token operator">+</span><br>          <span class="token string">" "</span> <span class="token operator">+</span><br>          a<span class="token punctuation">.</span>y1 <span class="token operator">+</span><br>          <span class="token string">" "</span> <span class="token operator">+</span><br>          point<span class="token punctuation">.</span>x <span class="token operator">+</span><br>          <span class="token string">" "</span> <span class="token operator">+</span><br>          point<span class="token punctuation">.</span>y <span class="token operator">+</span><br>          <span class="token string">" "</span> <span class="token operator">+</span><br>          a<span class="token punctuation">.</span>x2 <span class="token operator">+</span><br>          <span class="token string">" "</span> <span class="token operator">+</span><br>          a<span class="token punctuation">.</span>y2<br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token comment">//最后一个点</span><br>        <span class="token keyword">return</span> point<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>y<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></blockquote></div><footer></footer></article></main><footer id=footer><div><nav><a href=https://twitter.com/gaubeebangeel rel="me nofollow" target=_blank>Twitter</a> · <a href=https://github.com/gaubee/gaubee.com/tree/main/./src/articles/PIXI实现粗虚线绘制.md rel=nofollow target=_blank>Edit this page on GitHub</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>除非有特别的说明, 该站点所有直接内容都使用许可证：<a href=https://creativecommons.org/licenses/by/4.0/deed.zh>署名 4.0 国际 (CC BY 4.0)</a></small><blockquote><small>本网站不收集任何访问者的行为与信息，不做任何商业运作，仅仅为个人使用</small></blockquote></footer><script src=/js/dark-mode-toggle.mjs type=module></script><script src=/js/time-elements.mjs type=module></script><script src=/js/main.mjs type=module></script>
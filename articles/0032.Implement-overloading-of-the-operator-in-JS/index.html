<!doctype html><html><head><meta charset="utf-8"><meta name="description" content=""><meta name="keywords" content="Appn, WebComponent, article"><meta name="author" content="Gaubee, gaubeebangeel@gmail.com"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=5"><title>在JS中实现+=/-=操作符的重载</title><link rel="shortcut icon" href="/assets/favicon-wB3RD3gX.ico"><link rel="stylesheet" href="/index.css">  <link rel="stylesheet" crossorigin href="/assets/prism-okaidia-D95GE6Gn.css">
<link rel="manifest" href="/manifest.webmanifest"><script id="vite-plugin-pwa:register-sw" src="/registerSW.js"></script></head><body><header class="bg-ani"><style>.nav{padding:0 2em;border-radius:2em;backdrop-filter:contrast(0.5) brightness(2);width:fit-content;max-width:100%}.nav{display:grid;grid-template-columns:repeat(auto-fit,180px);justify-content:center;gap:12px}.nav>a{display:block;flex:1;font-size:18px;padding:16px;text-align:center}.nav>a{color:#e91e63}@supports (-webkit-background-clip:text){.nav>a{background:-webkit-linear-gradient(#e91e63,#673ab7);color:transparent;-webkit-background-clip:text;-webkit-text-fill-color:transparent}}</style><nav class="nav"><a class="" href="/">Home</a> <a class="target" href="/articles/">Articles</a> <a class="" href="/events/">Events</a> <a class="" href="/timeline/">Timeline</a> <a class="" href="/projects/">Projects</a></nav></header><div id="main-wrapper" class="article-wrapper"><main><h1>在JS中实现+=/-=操作符的重载</h1><h2>运用场景</h2><p>这是一个语法糖，只是为了简化一些API的写法，比如：</p><pre class="language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">+=</span> item <span class="token comment">// array push</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">-=</span> item <span class="token comment">// array remove</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>events <span class="token operator">+=</span> cb<span class="token punctuation">;</span> <span class="token comment">// add event</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>events <span class="token operator">-=</span> cb<span class="token punctuation">;</span> <span class="token comment">// remove event</span></code></pre><h2>如何实现</h2><p>JS原生支持<code>=</code>操作符号的重载，即getter/setter：</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span> <span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">666</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>而+=操作符号，是针对于string、number这两种类型来做拼接与累加操作的。 如果只是单纯实现+=，我建议使用string来做实现，因为js对于number类型的操作有一些精度问题，所以还是要小心规避，我没去关注不同浏览器在精度方面的差异。 但因为要操作-=，这就无法规避number类型了。所以我统一使用number来实现。</p><p>因为+=/-=后面接受的都是一个数字或者能转换成数字的对象，才能避免出现NaN。 下面我以实现一个PromisePool来作为实现的例子：</p><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">PromisePool</span> <span class="token keyword">extends</span> <span class="token class-name">Array</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 使用小数来作为ID标识</span>
		Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"_base"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
			<span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0.4572015816549748</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// -= 的时候使用</span>
		Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"_base_res"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
			<span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_base
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">get</span> <span class="token function">pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_base<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">set</span> <span class="token function">pool</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> cv <span class="token operator">=</span> <span class="token string">"0."</span> <span class="token operator">+</span> v<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">// 从缓存取获取对象</span>
		<span class="token keyword">const</span> obj <span class="token operator">=</span> global<span class="token punctuation">.</span>__op_temp__<span class="token punctuation">;</span>
		<span class="token comment">// console.log(obj)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cv <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_base<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 使用了+=运算符</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cv <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_base_res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 使用了-=运算符</span>
			<span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// 忽略，或者抛出异常</span>
			console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>cv<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PromisePool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
global<span class="token punctuation">.</span>__op_temp__ <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"test"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
pp<span class="token punctuation">.</span>pool <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>length<span class="token punctuation">,</span> pp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"-------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pp<span class="token punctuation">.</span>pool <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>length<span class="token punctuation">,</span> pp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这段DEMO的<strong>重点</strong>是：</p><ol><li>使用一个固有小数作为ID标识</li><li>+= -= 只接受自然数，避免和ID冲突</li><li>使用一个全局变量<code>__op_temp__</code>来存储要传入的对象 输出结果为：</li></ol><pre><code>1 { name: 'test' }
-------------
0 undefined
</code></pre><p>接下来要解决的就是如何把一个非Number对象传入PromisePool里头了，以及如果规避使用<code>__op_temp__</code>带来的内存隐患。 其实现的核心方法是：在执行+=或者-=算术运算的时候，js引擎会去调用一个对象的valueOf方法，所以我们要重载这个方法。</p><pre class="language-js"><code class="language-js">Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Promise<span class="token punctuation">,</span> <span class="token string">"__OP_VAL__"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">valueOf</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	global<span class="token punctuation">.</span>__op_temp__ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> Promise<span class="token punctuation">.</span>__OP_VAL__<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> pitem <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pp<span class="token punctuation">.</span>pool <span class="token operator">+=</span> pitem<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>length<span class="token punctuation">,</span> pp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"-------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pp<span class="token punctuation">.</span>pool <span class="token operator">-=</span> pitem<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>length<span class="token punctuation">,</span> pp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>以上代码中，我重写了Promise原型链中的valueOf方法，我使用<code>0</code>值来作为返回值，这个返回值不能乱来，我建议就是直接用0，否则会直接引发精度问题。</p><p>这些代码基本就已经实现了我们要的效果了。接下来就是补充内存管理的问题了，就是<code>__op_temp__</code>这个对象一直缓存着最后一个Promise对象，怎么给它释放掉？ 很简单，在我们运行<code>pp.pool+=pitem</code>的时候，这时候的js引擎执行的就是<code>valueOf( set op_temp ) =&gt; setter( get op_temp )</code>。也就是说<code>__op_temp__</code>在赋值后，只执行了一次“取值”就没用了。我们可以在这个取值之后直接释放掉引用。</p><pre class="language-js"><code class="language-js"><span class="token comment">// __op_temp_null_: 说明缓存取中没有东西</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> <span class="token string">"__op_temp_null_"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">"Operators Object NULL"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> op_temp_key <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">"Operators Object TEMP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> <span class="token string">"__op_temp__"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
	<span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>op_temp_key<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">// 取值后马上移除引用关系</span>
		<span class="token keyword">this</span><span class="token punctuation">[</span>op_temp_key<span class="token punctuation">]</span> <span class="token operator">=</span> global<span class="token punctuation">.</span>__op_temp_null_<span class="token punctuation">;</span>
		<span class="token keyword">return</span> res<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token function">set</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">[</span>op_temp_key<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>如此内存方面的隐患就解决了。</p><hr><p>以上源码位于：https://gist.github.com/Gaubee/91b34fc56f3890bdbad681d4a8f47424</p></main></div><style>footer a{line-height:1}footer nav{display:flex;gap:1rem}</style><footer class="bg-ani"><nav><a target="_blank" href="https://github.com/gaubee/gaubee.com">Github</a> <a target="_blank" href="https://beian.miit.gov.cn/#/Integrated/recordQuery">闽ICP备17026139号-1</a></nav></footer></body></html>
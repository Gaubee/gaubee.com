<!doctype html><html lang=zh-CH><meta charset=utf-8><title>Firebase在国内使用的一些方法 · Gaubee</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/css/main.css rel=stylesheet><link href=/webmanifest.json rel=manifest><meta content=#ec407a name=theme-color><link href=/articles.atom rel=alternate title="Gaubee's Articles Atom feed" type=application/atom+xml><link href=/events.atom rel=alternate title="Gaubee's Events Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><header id=header><h1><a href=/ >Gaubee</a></h1><a href=#navigation-toggle id=nav-toggle>显示导航 Show navigation</a><nav><ul><li><a href=/ >主页 Home</a><li class=current><a href=/articles>文章 Articles</a><li><a href=/events>小事件 Events</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>Firebase在国内使用的一些方法</h1><p class=meta>发布于 <time datetime=3/13/2017 itemprop=datePublished>3/13/2017</time> · 最后修改时间 <time datetime=8/2/2017 itemprop=dateModified>8/2/2017</time></header><div itemprop=articleBody><p>Firebase在国内有些地区是可用的，但只是有些，没法保证全国通用，这篇文章谈的是服务端（Node.js）的使用。<p>前提是电脑跑起来了代理软件，这个怎么搞我就不说了，代理服务器方面我建议用香港的代理服务器，那就很快很稳了。<p>首先是Firebase-tool这个命令行工具，源码中使用的是request这个库，所以只要在源码里头加上<code>proxy</code>属性就行了。<p>目前版本来说这个文件是<code>api.js</code>，找到<code>_request</code>这个函数，在里头加上一句：<pre class=language-js><code class=language-js>  options<span class="token punctuation">.</span>proxy <span class="token operator">=</span> <span class="token string">"http://127.0.0.1:8118"</span><span class="token punctuation">;</span></code></pre><hr><p>比较麻烦的是Firbase-admin这个库，用的是原生的http/https这两个核心的，核心服务都是走https的，所以这篇文章主要就谈一谈原生库如何走代理。我已经将这个库整理到<a href=https://github.com/Gaubee/firebase-admin-proxyable>firebase-admin-proxyable</a>这里了，国内用户可以安装这个并看着文档中DEMO的写法来配置自己的代理。<ol><li><p>核心原理就是使用<a href=https://nodejs.org/api/http.html#http_class_http_agent>agent</a>这个属性，具体看官方文档。<li><p>在npm里头，绝大多数的代理，核心都是这个库：<a href=https://www.npmjs.com/package/tunnel-agent>tunnel-agent</a>，点链接进去没文档，没关系，直接看源码，源码就单文件不到300行。<li><p>然后推荐用<a href=https://www.npmjs.com/package/caw>caw</a>这个库。源码也是很简单的，读过觉得很靠谱，所以才在这里推荐使用。</ol><p>以上就是相关的核心基本知识了。<br>下面是实践：<hr><h3 id=%E7%AC%AC%E4%B8%80%E6%AD%A5 tabindex=-1><a href=#%E7%AC%AC%E4%B8%80%E6%AD%A5 class=header-anchor>第一步</a></h3><pre class=language-js><code class=language-js><span class="token keyword">const</span> caw <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'caw'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"https"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>https<span class="token punctuation">.</span>globalAgent <span class="token operator">=</span> <span class="token function">caw</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:8118"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>	protocol<span class="token operator">:</span> <span class="token string">'https'</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>设置全局代理，agent的只有在keep-alive的情况下才会自动触发，去使用globalAgent。<blockquote><p>注意，这里：<code>"http://</code>这个代理的协议头不能少，看源码就知道为什么，因为源码很精简，没有去做那些不必要的智能判断，所以包括后面的<code>protocol: 'https'</code>也不能少，这点很重要。</blockquote><h3 id=%E7%AC%AC%E4%BA%8C%E6%AD%A5 tabindex=-1><a href=#%E7%AC%AC%E4%BA%8C%E6%AD%A5 class=header-anchor>第二步</a></h3><pre class=language-js><code class=language-js><span class="token keyword">const</span> admin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./firebase-admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>要把node_modules里头的firebase-admin文件夹拿出来，改源码，当然你也可以手动去跟随维护一个走代理版本的库。<h3 id=%E7%AC%AC%E4%B8%89%E6%AD%A5 tabindex=-1><a href=#%E7%AC%AC%E4%B8%89%E6%AD%A5 class=header-anchor>第三步</a></h3><p>找到api-request.js文件中https请求的options的定义，添加以下属性。<pre class=language-js><code class=language-js><span class="token comment">// firebase-admin\lib\utils\api-request.js</span><br> <span class="token operator">|</span>  <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><br> <span class="token operator">|</span>      method<span class="token operator">:</span> httpMethod<span class="token punctuation">,</span><br> <span class="token operator">|</span>      host<span class="token operator">:</span> host<span class="token punctuation">,</span><br> <span class="token operator">|</span>      port<span class="token operator">:</span> port<span class="token punctuation">,</span><br> <span class="token operator">|</span>      path<span class="token operator">:</span> path<span class="token punctuation">,</span><br> <span class="token operator">|</span>      headers<span class="token operator">:</span> headers<span class="token punctuation">,</span><br><span class="token operator">+</span><span class="token operator">|</span>      agent<span class="token operator">:</span> https<span class="token punctuation">.</span>globalAgent<span class="token punctuation">,</span><br> <span class="token operator">|</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>找到credential.js文件中requestAccessToken函数，在函数头部添加以下代码<pre class=language-js><code class=language-js><span class="token comment">// firebase-admin\lib\auth\credential.js</span><br> <span class="token operator">|</span><span class="token keyword">function</span> <span class="token function">requestAccessToken</span><span class="token punctuation">(</span><span class="token parameter">transit<span class="token punctuation">,</span> options<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><span class="token operator">+</span><span class="token operator">|</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>transit <span class="token operator">===</span> https<span class="token punctuation">)</span><span class="token punctuation">{</span><br><span class="token operator">+</span><span class="token operator">|</span>        options<span class="token punctuation">.</span>agent <span class="token operator">=</span> https<span class="token punctuation">.</span>globalAgent<span class="token punctuation">;</span><br><span class="token operator">+</span><span class="token operator">|</span>    <span class="token punctuation">}</span><br> <span class="token operator">|</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code></pre><hr><p>2017-8-2补充：<br>上面说的代理，是针对Google身份校验方面的代理。而在身份校验通过后，就是要开始用<code>wss</code>协议连接到服务器了，这点我补充一下如何配置：<br>在源码中有这么一段：<pre><code>0 == this.Wd.indexOf("wss://") ? d.HTTPS_PROXY || d.https_proxy : d.HTTP_PROXY || d.http_proxy;
</code></pre><p>意思是，wss的代理走的不是nodejs的，而是自己的一套，默认从命令行的环境中获取代理参数，所以如果wss连接不稳定，需要走代理的话：<pre><code>set https_proxy=http://127.0.0.1:8118
</code></pre><p>注意，这里头<code>http://</code>这个协议前缀一定要加。</div><footer></footer></article></main><footer id=footer><div><nav><a href=https://twitter.com/gaubeebangeel rel="me nofollow" target=_blank>Twitter</a> · <a href=https://github.com/gaubee/gaubee.com/tree/main/./src/articles/Firebase在国内使用的一些方法.md rel=nofollow target=_blank>Edit this page on GitHub</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>除非有特别的说明, 该站点所有直接内容都使用许可证：<a href=https://creativecommons.org/licenses/by/4.0/deed.zh>署名 4.0 国际 (CC BY 4.0)</a></small><blockquote><small>本网站不收集任何访问者的行为与信息，不做任何商业运作，仅仅为个人使用</small></blockquote></footer><script src=/js/dark-mode-toggle.mjs type=module></script><script src=/js/time-elements.mjs type=module></script><script src=/js/main.mjs type=module></script>
<!doctype html><html><head><meta charset="utf-8"><meta name="description" content=""><meta name="keywords" content="Appn, WebComponent, article"><meta name="author" content="Gaubee, gaubeebangeel@gmail.com"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=5"><title>Promise.race会带来内存泄露</title><link rel="shortcut icon" href="/assets/favicon-wB3RD3gX.ico"><link rel="stylesheet" href="/index.css">  <link rel="stylesheet" crossorigin href="/assets/prism-okaidia-D95GE6Gn.css">
</head><body><header class="bg-ani"><style>.nav{padding:0 2em;border-radius:2em;backdrop-filter:contrast(0.5) brightness(2);width:fit-content;max-width:100%}.nav{display:grid;grid-template-columns:repeat(auto-fit,180px);justify-content:center;gap:12px}.nav>a{display:block;flex:1;font-size:18px;padding:16px;text-align:center}.nav>a{color:#e91e63}@supports (-webkit-background-clip:text){.nav>a{background:-webkit-linear-gradient(#e91e63,#673ab7);color:transparent;-webkit-background-clip:text;-webkit-text-fill-color:transparent}}</style><nav class="nav"><a class="" href="/">Home</a> <a class="target" href="/articles/">Articles</a> <a class="" href="/events/">Events</a> <a class="" href="/timeline/">Timeline</a> <a class="" href="/projects/">Projects</a></nav></header><div id="main-wrapper" class="article-wrapper"><main><h1>Promise.race会带来内存泄露</h1><p>假若有两个promise: a, b，现在它们都<code>Promise.race([a,b])</code>所包裹。 此时，如果a先完成了resolve，race也就有了返回值。 然而，b却迟迟没有被resolve或者reject…… 结果会带来隐式的内存问题，就是a看上去被释放了，但其实没有。 v8论坛上有类似的bug提交：https://bugs.chromium.org/p/v8/issues/detail?id=9858</p><p>简单地模拟一下实现：</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">race</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>promises</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> p <span class="token keyword">of</span> promises<span class="token punctuation">)</span><span class="token punctuation">{</span>
      p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><p>我实际测试了一下，一些不同版本的v8似乎会有不同的表现，但终归是内存泄漏了，只是好像v12的是直接泄漏了捕捉不到，v13是能在内存堆栈里头看到。 我在工作的时候发现这个问题也是靠async_hooks的异步资源监控下才看到这个问题的存在。</p><p>解决方案其实也不难，核心问题就是消除引用：</p><ol><li>首先我们需要一个<code>Promise.prototype.safeThen</code>的实现，因为<code>Promise.prototype.then</code>是会返回出一个新的promise的。做法其实就是只使用一次then来代理实现。其返回值就是<code>thened: { resolves: Set&lt;Function&gt;, rejects: Set&lt;Function&gt;, isFinished: boolean }</code></li><li>接着我们基于<code>safeThen</code>来实现<code>Promise.safePromiseRace</code>，重点在于收集thened对象，并主动进行释放：</li></ol><pre><code>function safePromiseRace(...promises){
  return new Promise((resolve, reject)=&gt;{
    const thenedList = []
    const finished = ()=&gt;{
      thenedList.forEach(thened=&gt;{
        thened.resolves.delete(safeResolve);
        thened.rejects.delete(safeReject);
      })
    }
    const safeResolve = (v)=&gt;{resolve(v); finished();}
    const safeReject = (v)=&gt;{reject(v); finished();}
    for(const p of promises){
      thenedList.push(p.safeThen(safeResolve, safeReject))
    }
  })
}
</code></pre></main></div><style>footer a{line-height:1}footer nav{display:flex;gap:1rem}</style><footer class="bg-ani"><nav><a target="_blank" href="https://github.com/gaubee/gaubee.com">Github</a> <a target="_blank" href="https://beian.miit.gov.cn/#/Integrated/recordQuery">闽ICP备17026139号-1</a></nav></footer></body></html>
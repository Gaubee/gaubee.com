<!doctype html><html lang=zh-CN><meta charset=utf-8><title>gRPC实践案例 · Gaubee</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/css/main.css rel=stylesheet><link href=/webmanifest.json rel=manifest><meta content=#ec407a name=theme-color><link href=/articles.atom rel=alternate title="Gaubee's Articles Atom feed" type=application/atom+xml><link href=/events.atom rel=alternate title="Gaubee's Events Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><header id=header><h1><a href=/ >Gaubee</a></h1><a href=#navigation-toggle id=nav-toggle>显示导航 Show navigation</a><nav><ul><li><a href=/ >主页 Home</a><li class=current><a href=/articles>文章 Articles</a><li><a href=/events>小事件 Events</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>gRPC实践案例</h1><p class=meta>发布于 <time datetime=10/24/2016 itemprop=datePublished>10/24/2016</time> · 最后修改时间 <time datetime=2/9/2017 itemprop=dateModified>2/9/2017</time></header><div itemprop=articleBody><p>类似Google这种大公司产出的产品，一般就两种情况，一种是面向小白用户的，如此让G粉簇拥而来找Bug优化产品思路，等到时机成熟再推出正式版或者取消产品，AngularJS就是这一类。还有一种就是Google自己的需求而总结出来的产品，优点什么的我就不吹了，gRPC就是这一类的。<h2 id=%E5%BA%8F%E8%A8%80 tabindex=-1><a href=#%E5%BA%8F%E8%A8%80 class=header-anchor>序言</a></h2><blockquote><p>今年年初的时候我就一直想做一款基于RPC实现组件化搭建网站的一款产品。目的就是为了让各种语言的程序员能以最低沟通、学习代价来进行快速、稳定开发产品。而当初做的时候为了速度摸坑，用了Nodejs来进行开发，做出了<a href=https://github.com/gaubee/GQ>GQ</a>这款产品，自己边用边总结，说真的坑是真的多，JSON是不够用的，还有bytes、流数据等等问题。几个月下来，发现这个东西是个史诗大坑，因为要考虑到各种语言的兼容、使用难易、不同类型组件（数据库组件、流文件处理组件等）通用接口等等问题，迟迟没有拿出一套跨语言的规范来。几乎要放弃。这项目被我搁置。<br>不巧，gRPC出来了。当初心想有搞头，但是当时文档不够健全，让那些爱折腾的人先去探探路吧。<br>现在我作为第二批吃螃蟹的人，上手一试，心中暗叹：厉害了我的Goggle</blockquote><h2 id=%E6%A1%88%E4%BE%8B%E7%AE%80%E4%BB%8B tabindex=-1><a href=#%E6%A1%88%E4%BE%8B%E7%AE%80%E4%BB%8B class=header-anchor>案例简介</a></h2><p>一套基于路由注册的分发服务。这里使用Nodejs来快速上手。<br>服务端：注册HTTP端口，以及gRPC基础服务，通过基础服务，可以注册HTTP请求的处理权。<br>子服务：注册基础服务，实现对HTTP请求的处理。<br>流程如下：<pre><code>HTTP请求--->服务端--/a/b-->子服务1
　　　　　　　　　|--/a/c-->子服务2
　　　　　　　　　+--/a/d-->子服务3
</code></pre><h1 id=%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B tabindex=-1><a href=#%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B class=header-anchor>实现流程</a></h1><blockquote><p>PS:我这里不赘述<strong>XX为什么要这以做</strong>之类的话语，直接上代码，并简单解释代码中的重点。这个案例没有难点。<br>gRPC的安装省略。<br>使用Nodejs版本v6.9.1。用到一些ES6的语法，不完全兼容v4.*</blockquote><h2 id=proto%E6%96%87%E4%BB%B6 tabindex=-1><a href=#proto%E6%96%87%E4%BB%B6 class=header-anchor>proto文件</a></h2><pre class=language-protobuf><code class=language-protobuf><span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span><br><br><span class="token keyword">option</span> objc_class_prefix <span class="token operator">=</span> <span class="token string">"Gaubee"</span><span class="token punctuation">;</span><br><br><span class="token keyword">package</span> httpserver<span class="token punctuation">;</span><br><br><span class="token comment">// HttpServer服务的定义</span><br><span class="token keyword">service</span> <span class="token class-name">HttpServer</span> <span class="token punctuation">{</span><br>    <span class="token keyword">rpc</span> <span class="token function">BindRoute</span><span class="token punctuation">(</span><span class="token class-name">RouteInfo</span><span class="token punctuation">)</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token class-name">RequestInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br>    <span class="token keyword">rpc</span> <span class="token function">ReturnResponse</span><span class="token punctuation">(</span><span class="token class-name">ResponInfo</span><span class="token punctuation">)</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token class-name">ResponReply</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">message</span> <span class="token class-name">RouteInfo</span> <span class="token punctuation">{</span><br>    <span class="token keyword">enum</span> <span class="token class-name">Method</span> <span class="token punctuation">{</span><br>        GET <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>        POST <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>        PUT <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><br>        DELETE <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token comment">// 注册的路由pathname</span><br>    <span class="token builtin">string</span> path <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>    <span class="token class-name positional-class-name">Method</span> method <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><br>    <span class="token comment">// 是否直接解析query到query中</span><br>    <span class="token builtin">bool</span> is_parse_query <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><br>    <span class="token comment">// 是否解析带有Body的请求</span><br>    <span class="token builtin">bool</span> is_parse_body <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token keyword">message</span> <span class="token class-name">RequestInfo</span> <span class="token punctuation">{</span><br>    <span class="token comment">// 请求的ID，在做响应的时候需要带上</span><br>    <span class="token builtin">string</span> require_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>    <span class="token comment">// 请求链接中的数据</span><br>    <span class="token class-name map">map<span class="token punctuation">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">></span></span> query <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><br>    <span class="token comment">// 请求数据包中的数据</span><br>    <span class="token class-name map">map<span class="token punctuation">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">></span></span> body <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token keyword">message</span> <span class="token class-name">ResponInfo</span><span class="token punctuation">{</span><br>    <span class="token builtin">string</span> require_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>    <span class="token class-name map">map<span class="token punctuation">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">></span></span> response_head <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><br>    <span class="token builtin">string</span> response_data <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><br>    <span class="token builtin">int32</span> statusCode <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token comment">// 返回整个请求的时间信息</span><br><span class="token keyword">message</span> <span class="token class-name">ResponReply</span><span class="token punctuation">{</span><br>    <span class="token comment">// 收到请求，解析请求query、body花费的时间</span><br>    <span class="token builtin">float</span> route_parsed_time <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>    <span class="token comment">// 传输请求数据花费的时间</span><br>    <span class="token builtin">float</span> route_send_time <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><br>    <span class="token comment">// 处理请求至服务端收到数据花费的时间</span><br>    <span class="token builtin">float</span> responsed_time <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><br>    <span class="token comment">// 返回请求结果给客户花费的时间</span><br>    <span class="token builtin">float</span> responsed_send_time <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>以上的proto文件描述了两个接口：<ul><li>BindRoute：实现路由绑定把要绑定的路由写道path中，这里为了简单，我只是进行了字符串相等匹配。BindRoute的回调函数不会马上触发。要等到服务端有HTTP请求的时候，匹配到对应的路由，最后再执行返回。<li>ReturnResponse：BindRoute收到回调后，意味着子服务开始处理HTTP请求，在处理完成后，需要调用此函数来返回处理结果。</ul><p><strong>require_id</strong>是注册基础服务后生成的一次性编号，每一次注册都会生成一个，在收到HTTP请求是，匹配到对应的路由，就要通过这个require_id来发送请求、接受处理结果。<h2 id=%E6%9C%8D%E5%8A%A1%E7%AB%AF tabindex=-1><a href=#%E6%9C%8D%E5%8A%A1%E7%AB%AF class=header-anchor>服务端</a></h2><pre class=language-js><code class=language-js><span class="token string">"use strict"</span><span class="token punctuation">;</span><br><span class="token comment">// PROTO文件路径，按需换成自己的文件路径</span><br><span class="token keyword">const</span> <span class="token constant">PROTO_PATH</span> <span class="token operator">=</span> __dirname <span class="token operator">+</span> <span class="token string">'/../pingpong/http-server.proto'</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> grpc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'grpc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"querystring"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// 动态加载PROTO文件，生成接口</span><br><span class="token keyword">const</span> httpserver <span class="token operator">=</span> grpc<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token constant">PROTO_PATH</span><span class="token punctuation">)</span><span class="token punctuation">.</span>httpserver<span class="token punctuation">;</span><br><br><span class="token comment">/** 路由映射表<br> *  结构为：{ [METHOD:GET|POST|PUT|DELETE] : { [PATHNAME] : Array&lt;String>[require_id,...] } }<br> */</span><br><span class="token keyword">const</span> route_res_list <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">/** require_id对应的路由注册信息与回调函数<br> *  结构为：{ args : 路由注册信息, callback: 回调函数，用于通知子服务来处理HTTP请求 }<br> */</span><br><span class="token keyword">const</span> handleCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">/** require_id对应的HTTP请求<br> *  结构为：{ req : HTTP.Request, res: HTTP.Response }<br> */</span><br><span class="token keyword">const</span> reqresCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// 初始化路由映射表的结构</span><br><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> method <span class="token keyword">in</span> httpserver<span class="token punctuation">.</span>RouteInfo<span class="token punctuation">.</span>Method<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    route_res_list<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/** rgRPC服务：绑定路由<br> *<br> */</span><br><span class="token keyword">function</span> <span class="token function">BindRoute</span><span class="token punctuation">(</span><span class="token parameter">call<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> args <span class="token operator">=</span> call<span class="token punctuation">.</span>request<span class="token punctuation">;</span><br>    <span class="token keyword">const</span> routes <span class="token operator">=</span> route_res_list<span class="token punctuation">[</span>args<span class="token punctuation">.</span>method<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> handles <span class="token operator">=</span> routes<span class="token punctuation">[</span>args<span class="token punctuation">.</span>path<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handles<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        handles <span class="token operator">=</span> routes<span class="token punctuation">[</span>args<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token comment">// 生成require_id</span><br>    <span class="token keyword">const</span> require_id <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// 加入路由映射表</span><br>    handles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>require_id<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// 这里不调用callback，而是等待到收到HTTP请求的时候再执行</span><br>    handleCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>require_id<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>        <span class="token literal-property property">args</span><span class="token operator">:</span> args<span class="token punctuation">,</span><br>        callback<br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/** rgRPC服务：响应HTTP请求<br> *<br> */</span><br><span class="token keyword">function</span> <span class="token function">ReturnResponse</span><span class="token punctuation">(</span><span class="token parameter">call<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> args <span class="token operator">=</span> call<span class="token punctuation">.</span>request<span class="token punctuation">;</span><br>    <span class="token keyword">const</span> require_id <span class="token operator">=</span> args<span class="token punctuation">.</span>require_id<span class="token punctuation">;</span><br>    <span class="token comment">// 取出缓存中的req、res对象</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span><br>        req<span class="token punctuation">,</span><br>        res<br>    <span class="token punctuation">}</span> <span class="token operator">=</span> reqresCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>require_id<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string template-punctuation">`</span><span class="token string">Ref Error:require_id:</span><span class="token interpolation"><span class="token punctuation interpolation-punctuation">${</span>require_id<span class="token punctuation interpolation-punctuation">}</span></span><span class="token string"> no ref.</span><span class="token string template-punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token comment">// 返回数据</span><br>    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>statusCode<span class="token punctuation">,</span> args<span class="token punctuation">.</span>response_head<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>response_data<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// 清除缓存</span><br>    reqresCache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>require_id<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// 返回整个流程的消耗时间，这里为了简化代码没有加统计时间的代码</span><br>    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>        <span class="token literal-property property">route_parsed_time</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">route_send_time</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">responsed_time</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">responsed_send_time</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> grpc_server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">grpc<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    grpc_server<span class="token punctuation">.</span><span class="token function">addProtoService</span><span class="token punctuation">(</span>httpserver<span class="token punctuation">.</span>HttpServer<span class="token punctuation">.</span>service<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>        <span class="token literal-property property">bindRoute</span><span class="token operator">:</span> BindRoute<span class="token punctuation">,</span><br>        <span class="token literal-property property">returnResponse</span><span class="token operator">:</span> ReturnResponse<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// 注册gRPC服务</span><br>    <span class="token function">grpc_server</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'0.0.0.0:50051'</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span>ServerCredentials<span class="token punctuation">.</span><span class="token function">createInsecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    grpc_server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// 注册HTTP服务</span><br><span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> routes <span class="token operator">=</span> route_res_list<span class="token punctuation">[</span>req<span class="token punctuation">.</span>method<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>routes<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">const</span> url_info <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">const</span> handles <span class="token operator">=</span> routes<span class="token punctuation">[</span>url_info<span class="token punctuation">.</span>pathname<span class="token punctuation">]</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>handles <span class="token operator">&&</span> handles<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">const</span> <span class="token punctuation">{</span><br>                <span class="token literal-property property">value</span><span class="token operator">:</span> require_id<span class="token punctuation">,</span><br>                has_key<br>            <span class="token punctuation">}</span> <span class="token operator">=</span> handles<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>has_key<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"no handle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token keyword">return</span><br>            <span class="token punctuation">}</span><br>            <span class="token keyword">const</span> handle <span class="token operator">=</span> handleCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>require_id<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token comment">// 通知客户端处理HTTP请求，并带上HTTP请求的一些数据</span><br>            handle<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>                require_id<span class="token punctuation">,</span><br>                <span class="token comment">// TODO：headers</span><br>                <span class="token literal-property property">query</span><span class="token operator">:</span> handle<span class="token punctuation">.</span>args<span class="token punctuation">.</span>is_parse_query <span class="token operator">?</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>url_info<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>                <span class="token comment">// TODO：body应该改用流数据传输</span><br>                <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token punctuation">(</span>handle<span class="token punctuation">.</span>args<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">"GET"</span> <span class="token operator">&&</span> handle<span class="token punctuation">.</span>args<span class="token punctuation">.</span>is_parse_body<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token comment">// 缓存req、res</span><br>            reqresCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>require_id<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>                req<span class="token punctuation">,</span><br>                res<br>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token comment">// 清除缓存，此require_id已经报废，只用于最后的响应res的处理</span><br>            handleCache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>require_id<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            handles<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>require_id<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">1337</span><span class="token punctuation">,</span> <span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id=%E5%AD%90%E6%9C%8D%E5%8A%A1 tabindex=-1><a href=#%E5%AD%90%E6%9C%8D%E5%8A%A1 class=header-anchor>子服务</a></h2><pre class=language-js><code class=language-js><span class="token keyword">const</span> <span class="token constant">PROTO_PATH</span> <span class="token operator">=</span> __dirname <span class="token operator">+</span> <span class="token string">'/../pingpong/http-server.proto'</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> grpc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'grpc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> httpserver <span class="token operator">=</span> grpc<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token constant">PROTO_PATH</span><span class="token punctuation">)</span><span class="token punctuation">.</span>httpserver<span class="token punctuation">;</span><br><span class="token keyword">const</span> address <span class="token operator">=</span> <span class="token string">'localhost:50051'</span><br><br><span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">httpserver<span class="token punctuation">.</span>HttpServer</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span><span class="token function">createInsecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// 注册路由</span><br>    client<span class="token punctuation">.</span><span class="token function">bindRoute</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">"/QAQ"</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">method</span><span class="token operator">:</span> httpserver<span class="token punctuation">.</span>RouteInfo<span class="token punctuation">.</span>Method<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">is_parse_query</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">is_parse_body</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// 收到路由请求</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token comment">// 返回路由处理结果</span><br>        client<span class="token punctuation">.</span><span class="token function">returnResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>            <span class="token literal-property property">require_id</span><span class="token operator">:</span> response<span class="token punctuation">.</span>require_id<span class="token punctuation">,</span><br>            <span class="token literal-property property">statusCode</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span><br>            <span class="token literal-property property">response_head</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>            <span class="token literal-property property">response_data</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>query<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token comment">// 收到性能统计</span><br>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// 模拟发起请求</span><br>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">var</span> req <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"http://localhost:1337/QAQ?a=a"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> head</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>            <span class="token keyword">var</span> datas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br>            res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                datas<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                <span class="token comment">// 打印结果</span><br>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"request res:"</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>datas<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><hr><h2 id=%E6%80%BB%E7%BB%93 tabindex=-1><a href=#%E6%80%BB%E7%BB%93 class=header-anchor>总结</a></h2><p>以上代码流程只是简单的示例，有一点不好的就是路由的注册变成了一次性，这不能说完全不对。但更优的做法应该改为流数据，这就不需要调用callback来结束服务，而是可以通过流不停地发起请求，流的实践参考官方代码：<a href=https://github.com/grpc/grpc/blob/master/examples/node/dynamic_codegen/route_guide/route_guide_server.js>route_guide</a>。</div><footer></footer></article></main><footer id=footer><div><nav><a href=https://twitter.com/gaubeebangeel rel="me nofollow" target=_blank>Twitter</a> · <a href=https://github.com/gaubee/gaubee.com/tree/main/./src/articles/gRPC实践案例.md rel=nofollow target=_blank>Edit this page on GitHub</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>除非有特别的说明, 该站点所有直接内容都使用许可证：<a href=https://creativecommons.org/licenses/by/4.0/deed.zh>署名 4.0 国际 (CC BY 4.0)</a></small><blockquote><small>本网站不收集任何访问者的行为与信息，不做任何商业运作，仅仅为个人使用</small></blockquote></footer><script src=/js/dark-mode-toggle.mjs type=module></script><script src=/js/time-elements.mjs type=module></script><script src=/js/main.mjs type=module></script>
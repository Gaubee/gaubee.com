<!doctype html><html><head><meta charset="utf-8"><meta name="description" content=""><meta name="keywords" content="Appn, WebComponent, article"><meta name="author" content="Gaubee, gaubeebangeel@gmail.com"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=5"><title>PIXI实现粗虚线绘制</title><link rel="shortcut icon" href="/assets/favicon-wB3RD3gX.ico"><link rel="stylesheet" href="/index.css">  <link rel="stylesheet" crossorigin href="/assets/prism-okaidia-D95GE6Gn.css">
<link rel="manifest" href="/manifest.webmanifest"><script id="vite-plugin-pwa:register-sw" src="/registerSW.js"></script></head><body><header class="bg-ani"><style>.nav{padding:0 2em;border-radius:2em;backdrop-filter:contrast(0.5) brightness(2);width:fit-content;max-width:100%}.nav{display:grid;grid-template-columns:repeat(auto-fit,180px);justify-content:center;gap:12px}.nav>a{display:block;flex:1;font-size:18px;padding:16px;text-align:center}.nav>a{color:#e91e63}@supports (-webkit-background-clip:text){.nav>a{background:-webkit-linear-gradient(#e91e63,#673ab7);color:transparent;-webkit-background-clip:text;-webkit-text-fill-color:transparent}}</style><nav class="nav"><a class="" href="/">Home</a> <a class="target" href="/articles/">Articles</a> <a class="" href="/events/">Events</a> <a class="" href="/timeline/">Timeline</a> <a class="" href="/projects/">Projects</a></nav></header><div id="main-wrapper" class="article-wrapper"><main><h1>PIXI实现粗虚线绘制</h1><p>好久没写博文，今天打卡。 主题关于 canvas 虚线的绘制，或者说是一定路径的无限循环贴图的绘制，比如龙、蛇的身体绘制等等，网上都没有相关的实现，外国论坛也没有，所以索性就总结一下难点重点。</p><p>这里是围绕 PIXI 的接口来实现。</p><p>首先是准备的有：</p><ol><li>一条线的一组点</li><li>要进行无限循环的贴图</li></ol><p>实现需要基于<a href="https://pixijs.github.io/docs/PIXI.mesh.Mesh.html">PIXI.mesh.Mesh</a>这个类来实现。 需要传入的参数有：texture, vertices, uvs, indices。（drawMode 使用原本默认即可）</p><ul><li>texture 贴图对象 PIXI.Texutre</li><li>vertices 顶点对象 Float32Array，默认是[0, 0, 100, 0, 100, 100, 0, 100]</li><li>uvs 顶点贴图信息 Float32Array，0~1，代表贴图两个边缘，默认是[0, 0, 1, 0, 1, 1, 0, 1]</li><li>indices 顶点顺序 Uint16Array，默认是[0，1，3，2]，代表一个长方形的绘制，那么会被绘制成两个三角形，分别是 0,1,2 和 1,3,2 。而这里的顶点顺序则拿去代表 vertices 数据的顺序，简单用程序表示那就是：<code>indices.map((v,i)=&gt;[ indices[i],indices[i+1],indices[i+2] ])</code>，有这个数据我们通常用来把重复点的数据合并成一个重复使用。</li></ul><h2>vertices 的获取</h2><p>看这样一张图来说明 vertices, indices 这两个变量的默认值：</p><p><img src="/assets/vertices-and-indices-umBBz3ZP.png" alt="Figure 1: vertices and indices"></p><p>如图，首先把 vertices 的数据中的顶点 4 个坐标点出，每两个数据为一组数据点 x,y，这里一共四个点。 然后这四个点如何连成三角形？上面提到点的顺序必须是 0,1,2 然后 1,2,3。如果还有更多，那就是 2,3,4，如此下去，就形成三角网状结构。而 indices 参数就是用来指出这四个点的顺序。默认是[0，1，3，2]，那么就得到一下顺序：</p><p><img src="/assets/connect-vertices-B3UZl4cp.png" alt="Figure:connect vertices"></p><p>而 uvs，则是指出这个点在贴图中的百分比，和 vertices 一样，没两个数据为一组数据点 x,y。</p><p>所以根据这个规律，来实现贴图的无限循环。 为了简单，我们这里将 indices 直接定为 0,1,2,3,4,5,6,7,8..... 接下来会涉及到大量算法代码，我不贴出代码了，就说一下重点难点的思路： 其中最重要的是线段加粗算法，比如下图的三个点所组成的线段：</p><p><img src="/assets/point-to-segment-i6vbqE8G.png" alt="Figure:point to segment"></p><p>我们 可以很直接的得出这样的贴图顶点。 这里推荐一种思路：点画圆：</p><p><img src="/assets/circle-to-line-KaWRx6HJ.png" alt="Figure:circle to line"></p><p>如图，除了首位两个点是取与相邻点的法线与圆的交点外，其余的点，取法如图所示，直接取两圆交点所在弧 间点，化成数学就是这样的算法：左右两点的法线所在线上取两点，这两点与中间点的距离相等</p><p><img src="/assets/circle-to-line-math-h5g6T6mL.png" alt="Figure:circle to line"></p><blockquote><p>不过我有一个不是很理解的问题，就是贴图交织的问题，不知道如何解决：如果遇到这种情况呢？</p><p><img src="/assets/texture-mess-up-BcfKHwh-.png" alt="Figure:texture mess up"></p><p>图片估计看得很奇怪，奇怪就够了，因为贴图已经不是按照我想要的交织在一起，因为蛇、龙的身体在扭曲后，并不是后面的贴图把前面的覆盖了，而是把扭曲的部分合并在一起了。这里的问题就是这条线加粗后，如何正确的取到它两边的点。</p></blockquote><h2>uvs 的获取</h2><p>说完 vertices 这个变量的取值方法，还有一个难点就是 uvs 的问题，uvs 取值 0~1，如何是我们需求提到的虚线、蛇、龙等，那么 y 方向的都是 0，1 即可。x 方向就变成要根据点与点的距离来手动计算了。 要注意的是如果在从 0 递增到 1 后，接下来，要进行一次反转，然后才能从 0 再重新开始，如下面图：</p><p><img src="/assets/vertices-order-DgcQR414.png" alt="Figure:vertices order"></p><p>如果不进行反转，那么就会发生 1,0 | 1,1 | 0,0 三个点画了一个三角形，这个三角形明显就是贴图镜像效果，如何避免，我们可以在 1,0 | 1,1 这两个点的坐标上面直接加上 0,0 | 1,0。效果就等于在看不到的地方直接进行了反转，避免镜像贴图的出现，如图：（PS：这里的重复点可以用 indices 来实现）</p><p><img src="/assets/vertices-fixed-order-B6r5yfR-.png" alt="Figure:vertices fixed order"></p><p>还有一个问题就是补点的问题，两点之间的距离不一定，我们要保持贴图的比例，就要确保两 uvs 的值要和两点之间的距离来确定。当 uvs 累计到&gt;=1 的时候，就要在 uvs 为 1 的地方补点。如何实现我就不赘述了，实现不难。 我这里讲一个另外一种脏方法，可以免去补点的问题。就是用 svg 的 path 对象，我们将线绘制到 path 对象上后调用接口就是 getPointAtLength(number)。贴图宽高知道的情况下，可以获取指定长度来取到对应的点的坐标。这样就免去补点的麻烦了。</p><blockquote><h2>实现线的光滑</h2><p>既然用到了 svg，这里顺便贴出点光滑的实现代码：</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getAnchors</span><span class="token punctuation">(</span><span class="token parameter">p1x<span class="token punctuation">,</span> p1y<span class="token punctuation">,</span> p2x<span class="token punctuation">,</span> p2y<span class="token punctuation">,</span> p3x<span class="token punctuation">,</span> p3y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> is_turn <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>p3x <span class="token operator">&lt;</span> p1x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    is_turn <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> l1 <span class="token operator">=</span> <span class="token punctuation">(</span>p2x <span class="token operator">-</span> p1x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
    l2 <span class="token operator">=</span> <span class="token punctuation">(</span>p3x <span class="token operator">-</span> p2x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
    a <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">atan</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p2x <span class="token operator">-</span> p1x<span class="token punctuation">)</span> <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>p2y <span class="token operator">-</span> p1y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    b <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">atan</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p3x <span class="token operator">-</span> p2x<span class="token punctuation">)</span> <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>p2y <span class="token operator">-</span> p3y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  a <span class="token operator">=</span> p1y <span class="token operator">&lt;</span> p2y <span class="token operator">?</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">-</span> a <span class="token operator">:</span> a<span class="token punctuation">;</span>
  b <span class="token operator">=</span> p3y <span class="token operator">&lt;</span> p2y <span class="token operator">?</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">-</span> b <span class="token operator">:</span> b<span class="token punctuation">;</span>
  <span class="token keyword">var</span> alpha <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
    dx1 <span class="token operator">=</span> l1 <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>alpha <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">,</span>
    dy1 <span class="token operator">=</span> l1 <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>alpha <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">,</span>
    dx2 <span class="token operator">=</span> l2 <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>alpha <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span>
    dy2 <span class="token operator">=</span> l2 <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>alpha <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">x1</span><span class="token operator">:</span> p2x <span class="token operator">-</span> dx1 <span class="token operator">*</span> is_turn<span class="token punctuation">,</span>
    <span class="token literal-property property">y1</span><span class="token operator">:</span> p2y <span class="token operator">+</span> dy1 <span class="token operator">*</span> is_turn<span class="token punctuation">,</span>
    <span class="token literal-property property">x2</span><span class="token operator">:</span> p2x <span class="token operator">+</span> dx2 <span class="token operator">*</span> is_turn<span class="token punctuation">,</span>
    <span class="token literal-property property">y2</span><span class="token operator">:</span> p2y <span class="token operator">+</span> dy2 <span class="token operator">*</span> is_turn<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> pathNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElementNS</span><span class="token punctuation">(</span><span class="token string">"http://www.w3.org/2000/svg"</span><span class="token punctuation">,</span> <span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pathNode<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>
  <span class="token string">"d"</span><span class="token punctuation">,</span>
  points
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">point<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
          <span class="token string">"M "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token string">"C "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>y
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> pre_point <span class="token operator">=</span> points<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> nex_point <span class="token operator">=</span> points<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">getAnchors</span><span class="token punctuation">(</span>
          pre_point<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
          pre_point<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
          point<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
          point<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
          nex_point<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
          nex_point<span class="token punctuation">.</span>y
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
          a<span class="token punctuation">.</span>x1 <span class="token operator">+</span>
          <span class="token string">" "</span> <span class="token operator">+</span>
          a<span class="token punctuation">.</span>y1 <span class="token operator">+</span>
          <span class="token string">" "</span> <span class="token operator">+</span>
          point<span class="token punctuation">.</span>x <span class="token operator">+</span>
          <span class="token string">" "</span> <span class="token operator">+</span>
          point<span class="token punctuation">.</span>y <span class="token operator">+</span>
          <span class="token string">" "</span> <span class="token operator">+</span>
          a<span class="token punctuation">.</span>x2 <span class="token operator">+</span>
          <span class="token string">" "</span> <span class="token operator">+</span>
          a<span class="token punctuation">.</span>y2
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//最后一个点</span>
        <span class="token keyword">return</span> point<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></blockquote></main></div><style>footer a{line-height:1}footer nav{display:flex;gap:1rem}</style><footer class="bg-ani"><nav><a target="_blank" href="https://github.com/gaubee/gaubee.com">Github</a> <a target="_blank" href="https://beian.miit.gov.cn/#/Integrated/recordQuery">闽ICP备17026139号-1</a></nav></footer></body></html>
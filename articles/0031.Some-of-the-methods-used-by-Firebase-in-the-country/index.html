<!doctype html><html><head><meta charset="utf-8"><meta name="description" content=""><meta name="keywords" content="Appn, WebComponent, article"><meta name="author" content="Gaubee, gaubeebangeel@gmail.com"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=5"><title>Firebase在国内使用的一些方法</title><link rel="shortcut icon" href="/assets/favicon-wB3RD3gX.ico"><link rel="stylesheet" href="/index.css">  <link rel="stylesheet" crossorigin href="/assets/prism-okaidia-D95GE6Gn.css">
</head><body><header class="bg-ani"><style>.nav{padding:0 2em;border-radius:2em;backdrop-filter:contrast(0.5) brightness(2);width:fit-content;max-width:100%}.nav{display:grid;grid-template-columns:repeat(auto-fit,180px);justify-content:center;gap:12px}.nav>a{display:block;flex:1;font-size:18px;padding:16px;text-align:center}.nav>a{color:#e91e63}@supports (-webkit-background-clip:text){.nav>a{background:-webkit-linear-gradient(#e91e63,#673ab7);color:transparent;-webkit-background-clip:text;-webkit-text-fill-color:transparent}}</style><nav class="nav"><a class="" href="/">Home</a> <a class="target" href="/articles/">Articles</a> <a class="" href="/events/">Events</a> <a class="" href="/timeline/">Timeline</a> <a class="" href="/projects/">Projects</a></nav></header><div id="main-wrapper" class="article-wrapper"><main><h1>Firebase在国内使用的一些方法</h1><p>Firebase在国内有些地区是可用的，但只是有些，没法保证全国通用，这篇文章谈的是服务端（Node.js）的使用。</p><p>前提是电脑跑起来了代理软件，这个怎么搞我就不说了，代理服务器方面我建议用香港的代理服务器，那就很快很稳了。</p><p>首先是Firebase-tool这个命令行工具，源码中使用的是request这个库，所以只要在源码里头加上<code>proxy</code>属性就行了。</p><p>目前版本来说这个文件是<code>api.js</code>，找到<code>_request</code>这个函数，在里头加上一句：</p><pre class="language-js"><code class="language-js">  options<span class="token punctuation">.</span>proxy <span class="token operator">=</span> <span class="token string">"http://127.0.0.1:8118"</span><span class="token punctuation">;</span></code></pre><hr><p>比较麻烦的是Firbase-admin这个库，用的是原生的http/https这两个核心的，核心服务都是走https的，所以这篇文章主要就谈一谈原生库如何走代理。我已经将这个库整理到<a href="https://github.com/Gaubee/firebase-admin-proxyable">firebase-admin-proxyable</a>这里了，国内用户可以安装这个并看着文档中DEMO的写法来配置自己的代理。</p><ol><li><p>核心原理就是使用<a href="https://nodejs.org/api/http.html#http_class_http_agent">agent</a>这个属性，具体看官方文档。</p></li><li><p>在npm里头，绝大多数的代理，核心都是这个库：<a href="https://www.npmjs.com/package/tunnel-agent">tunnel-agent</a>，点链接进去没文档，没关系，直接看源码，源码就单文件不到300行。</p></li><li><p>然后推荐用<a href="https://www.npmjs.com/package/caw">caw</a>这个库。源码也是很简单的，读过觉得很靠谱，所以才在这里推荐使用。</p></li></ol><p>以上就是相关的核心基本知识了。 下面是实践：</p><hr><h3>第一步</h3><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> caw <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'caw'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"https"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

https<span class="token punctuation">.</span>globalAgent <span class="token operator">=</span> <span class="token function">caw</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:8118"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">protocol</span><span class="token operator">:</span> <span class="token string">'https'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>设置全局代理，agent的只有在keep-alive的情况下才会自动触发，去使用globalAgent。</p><blockquote><p>注意，这里：<code>&quot;http://</code>这个代理的协议头不能少，看源码就知道为什么，因为源码很精简，没有去做那些不必要的智能判断，所以包括后面的<code>protocol: 'https'</code>也不能少，这点很重要。</p></blockquote><h3>第二步</h3><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> admin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./firebase-admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>要把node_modules里头的firebase-admin文件夹拿出来，改源码，当然你也可以手动去跟随维护一个走代理版本的库。</p><h3>第三步</h3><p>找到api-request.js文件中https请求的options的定义，添加以下属性。</p><pre class="language-js"><code class="language-js"><span class="token comment">// firebase-admin\lib\utils\api-request.js</span>
 <span class="token operator">|</span>  <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
 <span class="token operator">|</span>      method<span class="token operator">:</span> httpMethod<span class="token punctuation">,</span>
 <span class="token operator">|</span>      host<span class="token operator">:</span> host<span class="token punctuation">,</span>
 <span class="token operator">|</span>      port<span class="token operator">:</span> port<span class="token punctuation">,</span>
 <span class="token operator">|</span>      path<span class="token operator">:</span> path<span class="token punctuation">,</span>
 <span class="token operator">|</span>      headers<span class="token operator">:</span> headers<span class="token punctuation">,</span>
<span class="token operator">+</span><span class="token operator">|</span>      agent<span class="token operator">:</span> https<span class="token punctuation">.</span>globalAgent<span class="token punctuation">,</span>
 <span class="token operator">|</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>找到credential.js文件中requestAccessToken函数，在函数头部添加以下代码</p><pre class="language-js"><code class="language-js"><span class="token comment">// firebase-admin\lib\auth\credential.js</span>
 <span class="token operator">|</span><span class="token keyword">function</span> <span class="token function">requestAccessToken</span><span class="token punctuation">(</span><span class="token parameter">transit<span class="token punctuation">,</span> options<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span><span class="token operator">|</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>transit <span class="token operator">===</span> https<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token operator">+</span><span class="token operator">|</span>        options<span class="token punctuation">.</span>agent <span class="token operator">=</span> https<span class="token punctuation">.</span>globalAgent<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token operator">|</span>    <span class="token punctuation">}</span>
 <span class="token operator">|</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code></pre><hr><p>2017-8-2补充： 上面说的代理，是针对Google身份校验方面的代理。而在身份校验通过后，就是要开始用<code>wss</code>协议连接到服务器了，这点我补充一下如何配置： 在源码中有这么一段：</p><pre><code>0 == this.Wd.indexOf(&quot;wss://&quot;) ? d.HTTPS_PROXY || d.https_proxy : d.HTTP_PROXY || d.http_proxy;
</code></pre><p>意思是，wss的代理走的不是nodejs的，而是自己的一套，默认从命令行的环境中获取代理参数，所以如果wss连接不稳定，需要走代理的话：</p><pre><code>set https_proxy=http://127.0.0.1:8118
</code></pre><p>注意，这里头<code>http://</code>这个协议前缀一定要加。</p></main></div><style>footer a{line-height:1}footer nav{display:flex;gap:1rem}</style><footer class="bg-ani"><nav><a target="_blank" href="https://github.com/gaubee/gaubee.com">Github</a> <a target="_blank" href="https://beian.miit.gov.cn/#/Integrated/recordQuery">闽ICP备17026139号-1</a></nav></footer></body></html>
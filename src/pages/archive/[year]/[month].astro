---
import { getCollection } from 'astro:content';
import HomeLayout from '../../../layouts/HomeLayout.astro';
import LeftSidebar from '../../../components/LeftSidebar.astro';
import RightSidebar from '../../../components/RightSidebar.astro';
import Card from '../../../components/Card.tsx';

export async function getStaticPaths() {
    const articles = await getCollection('articles');
    const events = await getCollection('events');
    const allPosts = [...articles, ...events];

    const postsByMonth = allPosts.reduce((acc, post) => {
        const year = post.data.date.getFullYear().toString();
        const month = (post.data.date.getMonth() + 1).toString().padStart(2, '0');
        const key = `${year}-${month}`;
        if (!acc.has(key)) {
            acc.set(key, { year, month });
        }
        return acc;
    }, new Map<string, { year: string; month: string }>());

    return Array.from(postsByMonth.values()).map(params => ({
        params,
    }));
}

const { year, month } = Astro.params;

const articles = await getCollection('articles');
const events = await getCollection('events');
const allPosts = [...articles, ...events];
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))];

const filteredPosts = allPosts.filter(post => {
    const postYear = post.data.date.getFullYear().toString();
    const postMonth = (post.data.date.getMonth() + 1).toString().padStart(2, '0');
    return postYear === year && postMonth === month;
});
---
<HomeLayout title={`Archive: ${year}-${month}`}>
    <div slot="left-sidebar">
        <LeftSidebar />
    </div>

    <div slot="main-content">
        <div class="heading-container">
            <h1>Archive: <span>{year}年{month}月</span></h1>
            <p><a href="/">&larr; Back to all posts</a></p>
        </div>

        <div class="feed-container">
            {filteredPosts.map(post => (
                <Card
                    href={`/${post.collection}/${post.slug}/`}
                    title={post.data.title || post.slug}
                    date={post.data.date}
                    type={post.collection as 'article' | 'event'}
                />
            ))}
        </div>
    </div>

    <div slot="right-sidebar">
        <RightSidebar tags={allTags} />
    </div>
</HomeLayout>

<style>
	.feed-container {
		display: flex;
        flex-direction: column;
		gap: 0;
        border-left: 1px solid var(--c-border);
        border-right: 1px solid var(--c-border);
	}
    .heading-container {
        padding: 1rem;
        border-bottom: 1px solid var(--c-border);
    }
    h1 {
        margin: 0;
        font-size: 1.8rem;
    }
    h1 span {
        color: rgb(var(--accent-dark));
    }
    p {
        padding: 0 1rem;
    }
    p a {
        color: var(--c-text);
        text-decoration: none;
    }
    p a:hover {
        text-decoration: underline;
    }
</style>

---
import ContentLayout from "@/layouts/ContentLayout.astro";
import Card from "@/components/Card.tsx";
import { getSiteData } from "@/lib/getSiteData";

export async function getStaticPaths() {
  const { allPosts } = await getSiteData();

  const postsByMonth = allPosts.reduce((acc, post) => {
    const year = post.data.date.getFullYear().toString();
    const month = (post.data.date.getMonth() + 1).toString().padStart(2, "0");
    const key = `${year}-${month}`;
    if (!acc.has(key)) {
      acc.set(key, { year, month });
    }
    return acc;
  }, new Map<string, { year: string; month: string }>());

  return Array.from(postsByMonth.values()).map((params) => ({
    params,
    props: { allPosts }, // Pass allPosts
  }));
}

const { year, month } = Astro.params;
const { allPosts } = Astro.props;

const filteredPosts = allPosts.filter((post) => {
  const postYear = post.data.date.getFullYear().toString();
  const postMonth = (post.data.date.getMonth() + 1).toString().padStart(2, "0");
  return postYear === year && postMonth === month;
});
---

<ContentLayout title={`Archive: ${year}-${month}`}>
  <div class="border-b border-zinc-200 px-4 pb-4 dark:border-zinc-700">
    <h1 class="text-3xl font-bold">
      Archive: <span class="text-sky-600 dark:text-sky-400"
        >{year}年{month}月</span
      >
    </h1>
    <a
      href="/"
      class="mt-2 inline-block text-zinc-600 hover:underline dark:text-zinc-400"
      >&larr; Back to all posts</a
    >
  </div>

  <div
    class="mt-8 flex flex-col border-r border-l border-zinc-200 dark:border-zinc-700"
  >
    {
      filteredPosts.map((post) => (
        <Card
          client:visible
          href={`/${post.collection}/${post.id}/`}
          title={post.data.title || post.id}
          date={post.data.date.toISOString()}
          type={post.collection}
        />
      ))
    }
  </div>
</ContentLayout>

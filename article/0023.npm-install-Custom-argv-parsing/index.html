<!DOCTYPE html>
    <html lang="en">
      <head>
        <link rel="stylesheet" type="text/css" href="/assets/static/renderer_css_index-e8e12f67.B0ujMgz2.css">
        <link rel="stylesheet" type="text/css" href="/assets/static/renderer_Layout-031b266d.CEjdw0pU.css">
        <meta charset="UTF-8" />
        <link rel="icon" href="/img/head.webp" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="Gaubee&#039;s Blogs / Events / Projects" />
        <title>Gaubee&#039;s Site</title>
      </head>
      <body>
        <div id="root"><link rel="preload" as="image" href="/img/head.webp"/><div style="display:flex;max-width:900px;margin:auto"><div style="display:flex;flex-direction:column;justify-content:space-between;max-height:100vh;width:38%;max-width:26em;position:sticky;top:0"><div id="sidebar" style="padding:20px;flex-shrink:0;display:flex;flex-direction:column;line-height:1.8em;border-right:2px solid #eee"><div style="margin-top:20px;margin-bottom:10px"><a href="/"><img src="/img/head.webp" height="64" width="64" alt="logo"/></a></div><a href="/" class="">Timeline</a><a href="/projects" class="">Projects</a><a href="/about" class="">About</a></div><div style="padding:16px"><small>本网站不收集任何访问者的行为与信息，不做任何商业运作，仅仅为个人使用。</small><small style="display:block;margin-top:8px"><a href="https://beian.miit.gov.cn/#/Integrated/recordQuery">闽ICP备17026139号-1</a></small></div></div><div id="page-container"><div id="page-content" style="padding:20px;padding-bottom:50px;min-height:100vh;background-color:#fafafa;color:#333"><style type="text/css">
          main > p {
            text-indent: 1em;
          }
        </style><h1>npm install自定义argv解析</h1><main><h2>问题描述与解决的方向</h2>
<p>问题来着一下这种需求出现的时候：</p>
<p>一个包，要面对不同的用户：Client 与 Server。</p>
<p>由于这个包中 Client 与 Server 共用部分代码，如果要拆分成 Client 包与 Server 包的话，那么就还要有一个公共 Common 包。</p>
<p>所以要实现以下效果：</p>
<p>默认为安装 Client 的包</p>
<pre><code>npm install my_npm_pkg
</code></pre>
<p>增加<code>--server</code>参数为安装 Server 的包</p>
<pre><code>npm instal my_npm_pkg --server
</code></pre>
<h2>参考文档</h2>
<p>在<a href="https://docs.npmjs.com/misc/scripts#environment">ENVIRONMENT</a>环节中有讲到 package.json 文件在 npm 命令运行的时候，相关的配置以及参数会被拍扁，变成环境变量。</p>
<p><img src="/img/npm-install-with-argv/package-json-vars.png" alt="image"></p>
<p>其中就包括这个字段：<code>npm_config_argv</code>
这个是一个 JSON 数据，里面包含了<code>npm</code>指令执行时的参数：</p>
<pre><code class="language-js">const npm_argv = JSON.parse(process.env.npm_config_argv);
npm_argv instanceof Array; //true  ["npm", "instal", "my_npm_pkg", "--server"]
</code></pre>
<h2>DEMO 代码：</h2>
<p><img src="/img/npm-install-with-argv/demo-capture-1.png" alt="image"></p>
<p><img src="/img/npm-install-with-argv/demo-capture-2.png" alt="image"></p>
<p><img src="/img/npm-install-with-argv/demo-capture-3.png" alt="image"></p>
<h2>解决问题代码：</h2>
<pre><code class="language-js">const exec = require("child_process").exec;
const npm_argv = JSON.parse(process.env.npm_config_argv || "{}");
if (!(npm_argv &#x26;&#x26; npm_argv.original instanceof Array)) {
  throw TypeError("npm argv Error"); // 异常的抛出会终止npm install命令
}
if (npm_argv.original.indexOf("--server") !== -1) {
  console.log("install dependencies: mongodb.");
  const child = exec(`cd ${__dirname} &#x26;&#x26; npm install mongodb`); // 安装依赖
  child.stdout.pipe(process.stdout);
  child.stderr.pipe(process.stderr);
}
</code></pre></main></div></div></div></div>
        <script id="vike_pageContext" type="application/json">{"abortReason":"!undefined","_urlRewrite":null,"_urlRedirect":"!undefined","abortStatusCode":"!undefined","_abortCall":"!undefined","_pageContextInitIsPassedToClient":"!undefined","pageId":"/pages/article/@id","routeParams":{"id":"0023.npm-install-Custom-argv-parsing"},"data":{"article":{"fileEntry":{"path":"/home/runner/work/gaubee.com/gaubee.com/articles/0023.npm-install-Custom-argv-parsing.md","options":{"cwd":"/home/runner/work/gaubee.com/gaubee.com/articles"},"isFile":true,"isDirectory":false},"originMetadata":{"layout":"layouts/article.njk","title":"npm install自定义argv解析","date":"!Date:2016-02-28T08:50:18.000Z","updated":"!Date:2016-02-28T09:51:12.000Z"},"metadata":{"layout":"layouts/article.njk","title":"npm install自定义argv解析","date":"!Date:2016-02-28T08:50:18.000Z","updated":"!Date:2016-02-28T09:51:12.000Z","id":"0023.npm-install-Custom-argv-parsing","createdAt":"!Date:2016-02-28T08:50:18.000Z","updatedAt":"!Date:2016-02-28T09:51:12.000Z","tags":[]},"htmlContent":"\u003ch2>问题描述与解决的方向\u003c/h2>\n\u003cp>问题来着一下这种需求出现的时候：\u003c/p>\n\u003cp>一个包，要面对不同的用户：Client 与 Server。\u003c/p>\n\u003cp>由于这个包中 Client 与 Server 共用部分代码，如果要拆分成 Client 包与 Server 包的话，那么就还要有一个公共 Common 包。\u003c/p>\n\u003cp>所以要实现以下效果：\u003c/p>\n\u003cp>默认为安装 Client 的包\u003c/p>\n\u003cpre>\u003ccode>npm install my_npm_pkg\n\u003c/code>\u003c/pre>\n\u003cp>增加\u003ccode>--server\u003c/code>参数为安装 Server 的包\u003c/p>\n\u003cpre>\u003ccode>npm instal my_npm_pkg --server\n\u003c/code>\u003c/pre>\n\u003ch2>参考文档\u003c/h2>\n\u003cp>在\u003ca href=\"https://docs.npmjs.com/misc/scripts#environment\">ENVIRONMENT\u003c/a>环节中有讲到 package.json 文件在 npm 命令运行的时候，相关的配置以及参数会被拍扁，变成环境变量。\u003c/p>\n\u003cp>\u003cimg src=\"/img/npm-install-with-argv/package-json-vars.png\" alt=\"image\">\u003c/p>\n\u003cp>其中就包括这个字段：\u003ccode>npm_config_argv\u003c/code>\n这个是一个 JSON 数据，里面包含了\u003ccode>npm\u003c/code>指令执行时的参数：\u003c/p>\n\u003cpre>\u003ccode class=\"language-js\">const npm_argv = JSON.parse(process.env.npm_config_argv);\nnpm_argv instanceof Array; //true  [\"npm\", \"instal\", \"my_npm_pkg\", \"--server\"]\n\u003c/code>\u003c/pre>\n\u003ch2>DEMO 代码：\u003c/h2>\n\u003cp>\u003cimg src=\"/img/npm-install-with-argv/demo-capture-1.png\" alt=\"image\">\u003c/p>\n\u003cp>\u003cimg src=\"/img/npm-install-with-argv/demo-capture-2.png\" alt=\"image\">\u003c/p>\n\u003cp>\u003cimg src=\"/img/npm-install-with-argv/demo-capture-3.png\" alt=\"image\">\u003c/p>\n\u003ch2>解决问题代码：\u003c/h2>\n\u003cpre>\u003ccode class=\"language-js\">const exec = require(\"child_process\").exec;\nconst npm_argv = JSON.parse(process.env.npm_config_argv || \"{}\");\nif (!(npm_argv &#x26;&#x26; npm_argv.original instanceof Array)) {\n  throw TypeError(\"npm argv Error\"); // 异常的抛出会终止npm install命令\n}\nif (npm_argv.original.indexOf(\"--server\") !== -1) {\n  console.log(\"install dependencies: mongodb.\");\n  const child = exec(`cd ${__dirname} &#x26;&#x26; npm install mongodb`); // 安装依赖\n  child.stdout.pipe(process.stdout);\n  child.stderr.pipe(process.stderr);\n}\n\u003c/code>\u003c/pre>","markdownContent":"\n## 问题描述与解决的方向\n\n问题来着一下这种需求出现的时候：\n\n一个包，要面对不同的用户：Client 与 Server。\n\n由于这个包中 Client 与 Server 共用部分代码，如果要拆分成 Client 包与 Server 包的话，那么就还要有一个公共 Common 包。\n\n所以要实现以下效果：\n\n默认为安装 Client 的包\n\n```\nnpm install my_npm_pkg\n```\n\n增加`--server`参数为安装 Server 的包\n\n```\nnpm instal my_npm_pkg --server\n```\n\n## 参考文档\n\n在[ENVIRONMENT](https://docs.npmjs.com/misc/scripts#environment)环节中有讲到 package.json 文件在 npm 命令运行的时候，相关的配置以及参数会被拍扁，变成环境变量。\n\n![image](/img/npm-install-with-argv/package-json-vars.png)\n\n其中就包括这个字段：`npm_config_argv`\n这个是一个 JSON 数据，里面包含了`npm`指令执行时的参数：\n\n```js\nconst npm_argv = JSON.parse(process.env.npm_config_argv);\nnpm_argv instanceof Array; //true  [\"npm\", \"instal\", \"my_npm_pkg\", \"--server\"]\n```\n\n## DEMO 代码：\n\n![image](/img/npm-install-with-argv/demo-capture-1.png)\n\n![image](/img/npm-install-with-argv/demo-capture-2.png)\n\n![image](/img/npm-install-with-argv/demo-capture-3.png)\n\n## 解决问题代码：\n\n```js\nconst exec = require(\"child_process\").exec;\nconst npm_argv = JSON.parse(process.env.npm_config_argv || \"{}\");\nif (!(npm_argv && npm_argv.original instanceof Array)) {\n  throw TypeError(\"npm argv Error\"); // 异常的抛出会终止npm install命令\n}\nif (npm_argv.original.indexOf(\"--server\") !== -1) {\n  console.log(\"install dependencies: mongodb.\");\n  const child = exec(`cd ${__dirname} && npm install mongodb`); // 安装依赖\n  child.stdout.pipe(process.stdout);\n  child.stderr.pipe(process.stderr);\n}\n```\n"}}}</script>
        <script src="/assets/entries/entry-client-routing.D4VBVy3c.js" type="module" async></script>
        <link rel="modulepreload" href="/assets/entries/pages_article_-id.h5JipGsp.js" as="script" type="text/javascript">
        <link rel="modulepreload" href="/assets/chunks/chunk-vy2czm8u.js" as="script" type="text/javascript">
        <link rel="modulepreload" href="/assets/chunks/chunk-0HRAW6Xj.js" as="script" type="text/javascript">
      </body>
    </html>
<!DOCTYPE html>
    <html lang="en">
      <head>
        <link rel="stylesheet" type="text/css" href="/assets/static/renderer_css_index-e8e12f67.CaHEwVA7.css">
        <link rel="stylesheet" type="text/css" href="/assets/static/renderer_Layout-031b266d.CEjdw0pU.css">
        <meta charset="UTF-8" />
        <link rel="icon" href="/img/head.webp" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="Gaubee&#039;s Blogs / Events / Projects" />
        <title>Gaubee&#039;s Site</title>
      </head>
      <body>
        <div id="root"><link rel="preload" as="image" href="img/head.webp"/><div style="display:flex;max-width:900px;margin:auto"><div style="display:flex;flex-direction:column;justify-content:space-between;max-height:100vh;width:38%;max-width:26em;position:sticky;top:0"><div id="sidebar" style="padding:20px;flex-shrink:0;display:flex;flex-direction:column;line-height:1.8em;border-right:2px solid #eee"><div style="margin-top:20px;margin-bottom:10px"><a href="/"><img src="img/head.webp" height="64" width="64" alt="logo"/></a></div><a href="/" class="">Timeline</a><a href="/projects" class="">Projects</a><a href="/about" class="">About</a></div><div style="padding:16px"><small>本网站不收集任何访问者的行为与信息，不做任何商业运作，仅仅为个人使用。</small><small style="display:block;margin-top:8px"><a href="https://beian.miit.gov.cn/#/Integrated/recordQuery">闽ICP备17026139号-1</a></small></div></div><div id="page-container"><div id="page-content" style="padding:20px;padding-bottom:50px;min-height:100vh"><h1>gRPC实践案例</h1><main><p>类似Google这种大公司产出的产品，一般就两种情况，一种是面向小白用户的，如此让G粉簇拥而来找Bug优化产品思路，等到时机成熟再推出正式版或者取消产品，AngularJS就是这一类。还有一种就是Google自己的需求而总结出来的产品，优点什么的我就不吹了，gRPC就是这一类的。</p>
<h2>序言</h2>
<blockquote>
<p>今年年初的时候我就一直想做一款基于RPC实现组件化搭建网站的一款产品。目的就是为了让各种语言的程序员能以最低沟通、学习代价来进行快速、稳定开发产品。而当初做的时候为了速度摸坑，用了Nodejs来进行开发，做出了<a href="https://github.com/gaubee/GQ" target="_blank">GQ</a>这款产品，自己边用边总结，说真的坑是真的多，JSON是不够用的，还有bytes、流数据等等问题。几个月下来，发现这个东西是个史诗大坑，因为要考虑到各种语言的兼容、使用难易、不同类型组件（数据库组件、流文件处理组件等）通用接口等等问题，迟迟没有拿出一套跨语言的规范来。几乎要放弃。这项目被我搁置。
不巧，gRPC出来了。当初心想有搞头，但是当时文档不够健全，让那些爱折腾的人先去探探路吧。
现在我作为第二批吃螃蟹的人，上手一试，心中暗叹：厉害了我的Goggle</p>
</blockquote>
<h2>案例简介</h2>
<p>一套基于路由注册的分发服务。这里使用Nodejs来快速上手。
服务端：注册HTTP端口，以及gRPC基础服务，通过基础服务，可以注册HTTP请求的处理权。
子服务：注册基础服务，实现对HTTP请求的处理。
流程如下：</p>
<pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8" tabindex="0"><code class="language-text"><span class="line"><span>HTTP请求--->服务端--/a/b-->子服务1</span></span>
<span class="line"><span>　　　　　　　　　|--/a/c-->子服务2</span></span>
<span class="line"><span>　　　　　　　　　+--/a/d-->子服务3</span></span></code></pre>
<h1>实现流程</h1>
<blockquote>
<p>PS:我这里不赘述<strong>XX为什么要这以做</strong>之类的话语，直接上代码，并简单解释代码中的重点。这个案例没有难点。
gRPC的安装省略。
使用Nodejs版本v6.9.1。用到一些ES6的语法，不完全兼容v4.*</p>
</blockquote>
<h2>proto文件</h2>
<pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8" tabindex="0"><code class="language-protobuf"><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">syntax</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "proto3"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">option</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> objc_class_prefix</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "Gaubee"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">package</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> httpserver</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// HttpServer服务的定义</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">service</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> HttpServer</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    rpc</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> BindRoute</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">RouteInfo</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">returns</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">RequestInfo</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    rpc</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> ReturnResponse</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">ResponInfo</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">returns</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">ResponReply</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">message</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> RouteInfo</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    enum</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Method</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        GET </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        POST </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        PUT </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        DELETE </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 注册的路由pathname</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    string</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> path </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    Method</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> method </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 是否直接解析query到query中</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    bool</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> is_parse_query </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 是否解析带有Body的请求</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    bool</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> is_parse_body </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 4</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">message</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> RequestInfo</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 请求的ID，在做响应的时候需要带上</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    string</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> require_id </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 请求链接中的数据</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    map</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> query </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 请求数据包中的数据</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    map</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> body </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">message</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> ResponInfo</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    string</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> require_id </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    map</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> response_head </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    string</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> response_data </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    int32</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> statusCode </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 4</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// 返回整个请求的时间信息</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">message</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> ResponReply</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 收到请求，解析请求query、body花费的时间</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    float</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> route_parsed_time </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 传输请求数据花费的时间</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    float</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> route_send_time </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 处理请求至服务端收到数据花费的时间</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    float</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> responsed_time </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 返回请求结果给客户花费的时间</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    float</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> responsed_send_time </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 4</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
<p>以上的proto文件描述了两个接口：</p>
<ul>
<li>BindRoute：实现路由绑定把要绑定的路由写道path中，这里为了简单，我只是进行了字符串相等匹配。BindRoute的回调函数不会马上触发。要等到服务端有HTTP请求的时候，匹配到对应的路由，最后再执行返回。</li>
<li>ReturnResponse：BindRoute收到回调后，意味着子服务开始处理HTTP请求，在处理完成后，需要调用此函数来返回处理结果。</li>
</ul>
<p><strong>require_id</strong>是注册基础服务后生成的一次性编号，每一次注册都会生成一个，在收到HTTP请求是，匹配到对应的路由，就要通过这个require_id来发送请求、接受处理结果。</p>
<h2>服务端</h2>
<pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8" tabindex="0"><code class="language-js"><span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">"use strict"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// PROTO文件路径，按需换成自己的文件路径</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> PROTO_PATH</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> __dirname </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> '/../pingpong/http-server.proto'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> grpc</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> require</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'grpc'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> http</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> require</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"http"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> url</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> require</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"url"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> querystring</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> require</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"querystring"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// 动态加载PROTO文件，生成接口</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> httpserver</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> grpc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">load</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">PROTO_PATH</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).httpserver;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">/** 路由映射表</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"> *  结构为：{ [METHOD:GET|POST|PUT|DELETE] : { [PATHNAME] : Array&#x3C;String>[require_id,...] } }</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> route_res_list</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">/** require_id对应的路由注册信息与回调函数</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"> *  结构为：{ args : 路由注册信息, callback: 回调函数，用于通知子服务来处理HTTP请求 }</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> handleCache</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Map</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">/** require_id对应的HTTP请求</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"> *  结构为：{ req : HTTP.Request, res: HTTP.Response }</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> reqresCache</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Map</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// 初始化路由映射表的结构</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">for</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> method </span><span style="color:#D73A49;--shiki-dark:#F97583">in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> httpserver.RouteInfo.Method) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    route_res_list[method] </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {};</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">/** rgRPC服务：绑定路由</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"> *</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">function</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> BindRoute</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">call</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">callback</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> args</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> call.request;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> routes</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> route_res_list[args.method];</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    var</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> handles </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> routes[args.path];</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">!</span><span style="color:#24292E;--shiki-dark:#E1E4E8">handles) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        handles </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> routes[args.path] </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 生成require_id</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> require_id</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Math.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">random</span><span style="color:#24292E;--shiki-dark:#E1E4E8">().</span><span style="color:#6F42C1;--shiki-dark:#B392F0">toString</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">36</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span><span style="color:#6F42C1;--shiki-dark:#B392F0">substr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 加入路由映射表</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    handles.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(require_id);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 这里不调用callback，而是等待到收到HTTP请求的时候再执行</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    handleCache.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(require_id, {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        args: args,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        callback</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">/** rgRPC服务：响应HTTP请求</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"> *</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">function</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> ReturnResponse</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">call</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">callback</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> args</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> call.request;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> require_id</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> args.require_id;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 取出缓存中的req、res对象</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    const</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">        req</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">        res</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    } </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> reqresCache.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(require_id);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">!</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        return</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> callback</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">`Ref Error:require_id:${</span><span style="color:#24292E;--shiki-dark:#E1E4E8">require_id</span><span style="color:#032F62;--shiki-dark:#9ECBFF">} no ref.`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 返回数据</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    res.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">writeHead</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(args.statusCode, args.response_head);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    res.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(args.response_data);</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 清除缓存</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    reqresCache.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">delete</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(require_id);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 返回整个流程的消耗时间，这里为了简化代码没有加统计时间的代码</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    callback</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">null</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        route_parsed_time: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        route_send_time: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        responsed_time: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        responsed_send_time: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">function</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> grpc_server</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> grpc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Server</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    grpc_server.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">addProtoService</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(httpserver.HttpServer.service, {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        bindRoute: BindRoute,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        returnResponse: ReturnResponse,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 注册gRPC服务</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    grpc_server.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">bind</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'0.0.0.0:50051'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, grpc.ServerCredentials.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">createInsecure</span><span style="color:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    grpc_server.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">start</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">main</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// 注册HTTP服务</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> server</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> http.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">createServer</span><span style="color:#24292E;--shiki-dark:#E1E4E8">((</span><span style="color:#E36209;--shiki-dark:#FFAB70">req</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">res</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> routes</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> route_res_list[req.method];</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (routes) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> url_info</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> url.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(req.url);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> handles</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> routes[url_info.pathname];</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (handles </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> handles.size) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            const</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">                value</span><span style="color:#24292E;--shiki-dark:#E1E4E8">: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">require_id</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">                has_key</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            } </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> handles.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">values</span><span style="color:#24292E;--shiki-dark:#E1E4E8">().</span><span style="color:#6F42C1;--shiki-dark:#B392F0">next</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (has_key) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">log</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"no handle"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                return</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> handle</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> handleCache.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(require_id);</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">            // 通知客户端处理HTTP请求，并带上HTTP请求的一些数据</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            handle.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">callback</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">null</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                require_id,</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">                // TODO：headers</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                query: handle.args.is_parse_query </span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Object.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">assign</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({}, querystring.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(url_info.query)) </span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {},</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">                // TODO：body应该改用流数据传输</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                body: (handle.args.method </span><span style="color:#D73A49;--shiki-dark:#F97583">!==</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "GET"</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> handle.args.is_parse_body) </span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {} </span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            });</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">            // 缓存req、res</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            reqresCache.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(require_id, {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                req,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                res</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            });</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">            // 清除缓存，此require_id已经报废，只用于最后的响应res的处理</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            handleCache.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">delete</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(require_id);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            handles.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">delete</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(require_id);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">});</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">server.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">listen</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1337</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"0.0.0.0"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, () </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {});</span></span></code></pre>
<h2>子服务</h2>
<pre class="shiki shiki-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8" tabindex="0"><code class="language-js"><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> PROTO_PATH</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> __dirname </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> '/../pingpong/http-server.proto'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> grpc</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> require</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'grpc'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> http</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> require</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"http"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> httpserver</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> grpc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">load</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">PROTO_PATH</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).httpserver;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> address</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'localhost:50051'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">function</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    var</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> client </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> httpserver.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">HttpServer</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(address, grpc.credentials.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">createInsecure</span><span style="color:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 注册路由</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    client.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">bindRoute</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        path: </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"/QAQ"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        method: httpserver.RouteInfo.Method.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">GET</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        is_parse_query: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">true</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        is_parse_body: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">false</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }, </span><span style="color:#D73A49;--shiki-dark:#F97583">function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">err</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">response</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">        // 收到路由请求</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">log</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(err, response);</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">        // 返回路由处理结果</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        client.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">returnResponse</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            require_id: response.require_id,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            statusCode: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">200</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            response_head: {},</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            response_data: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">JSON</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">stringify</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(response.query)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        }, </span><span style="color:#D73A49;--shiki-dark:#F97583">function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">err</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">response</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">            // 收到性能统计</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">log</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(err, response);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // 模拟发起请求</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    setTimeout</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        var</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> req </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> http.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"http://localhost:1337/QAQ?a=a"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, (</span><span style="color:#E36209;--shiki-dark:#FFAB70">res</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">socket</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">head</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            var</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> datas </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            res.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">on</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"data"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, (</span><span style="color:#E36209;--shiki-dark:#FFAB70">chunk</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                datas.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">push</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(chunk);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            });</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            res.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">on</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"end"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, () </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">                // 打印结果</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">log</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"request res:"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Buffer.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">concat</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(datas).</span><span style="color:#6F42C1;--shiki-dark:#B392F0">toString</span><span style="color:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            });</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        });</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">200</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">main</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span></code></pre>
<hr>
<h2>总结</h2>
<p>以上代码流程只是简单的示例，有一点不好的就是路由的注册变成了一次性，这不能说完全不对。但更优的做法应该改为流数据，这就不需要调用callback来结束服务，而是可以通过流不停地发起请求，流的实践参考官方代码：<a href="https://github.com/grpc/grpc/blob/master/examples/node/dynamic_codegen/route_guide/route_guide_server.js" target="_blank">route_guide</a>。</p>
</main></div></div></div></div>
        <script id="vike_pageContext" type="application/json">{"abortReason":"!undefined","_urlRewrite":null,"_urlRedirect":"!undefined","abortStatusCode":"!undefined","_abortCall":"!undefined","_pageContextInitIsPassedToClient":"!undefined","pageId":"/pages/article/@id","routeParams":{"id":"gRPC-practice-case"},"data":{"article":{"metadata":{"layout":"layouts/article.njk","title":"gRPC实践案例","date":"!Date:2016-10-24T21:39:05.000Z","updated":"!Date:2017-02-09T14:43:25.000Z","id":"gRPC-practice-case","createdAt":"!Date:2016-10-24T21:39:05.000Z","updatedAt":"!Date:2017-02-09T14:43:25.000Z","tags":[]},"htmlContent":"\u003cp>类似Google这种大公司产出的产品，一般就两种情况，一种是面向小白用户的，如此让G粉簇拥而来找Bug优化产品思路，等到时机成熟再推出正式版或者取消产品，AngularJS就是这一类。还有一种就是Google自己的需求而总结出来的产品，优点什么的我就不吹了，gRPC就是这一类的。\u003c/p>\n\u003ch2>序言\u003c/h2>\n\u003cblockquote>\n\u003cp>今年年初的时候我就一直想做一款基于RPC实现组件化搭建网站的一款产品。目的就是为了让各种语言的程序员能以最低沟通、学习代价来进行快速、稳定开发产品。而当初做的时候为了速度摸坑，用了Nodejs来进行开发，做出了\u003ca href=\"https://github.com/gaubee/GQ\" target=\"_blank\">GQ\u003c/a>这款产品，自己边用边总结，说真的坑是真的多，JSON是不够用的，还有bytes、流数据等等问题。几个月下来，发现这个东西是个史诗大坑，因为要考虑到各种语言的兼容、使用难易、不同类型组件（数据库组件、流文件处理组件等）通用接口等等问题，迟迟没有拿出一套跨语言的规范来。几乎要放弃。这项目被我搁置。\n不巧，gRPC出来了。当初心想有搞头，但是当时文档不够健全，让那些爱折腾的人先去探探路吧。\n现在我作为第二批吃螃蟹的人，上手一试，心中暗叹：厉害了我的Goggle\u003c/p>\n\u003c/blockquote>\n\u003ch2>案例简介\u003c/h2>\n\u003cp>一套基于路由注册的分发服务。这里使用Nodejs来快速上手。\n服务端：注册HTTP端口，以及gRPC基础服务，通过基础服务，可以注册HTTP请求的处理权。\n子服务：注册基础服务，实现对HTTP请求的处理。\n流程如下：\u003c/p>\n\u003cpre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\">\u003ccode class=\"language-text\">\u003cspan class=\"line\">\u003cspan>HTTP请求--->服务端--/a/b-->子服务1\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan>　　　　　　　　　|--/a/c-->子服务2\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan>　　　　　　　　　+--/a/d-->子服务3\u003c/span>\u003c/span>\u003c/code>\u003c/pre>\n\u003ch1>实现流程\u003c/h1>\n\u003cblockquote>\n\u003cp>PS:我这里不赘述\u003cstrong>XX为什么要这以做\u003c/strong>之类的话语，直接上代码，并简单解释代码中的重点。这个案例没有难点。\ngRPC的安装省略。\n使用Nodejs版本v6.9.1。用到一些ES6的语法，不完全兼容v4.*\u003c/p>\n\u003c/blockquote>\n\u003ch2>proto文件\u003c/h2>\n\u003cpre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\">\u003ccode class=\"language-protobuf\">\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">syntax\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"proto3\"\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">option\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> objc_class_prefix\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"Gaubee\"\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">package\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\"> httpserver\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">// HttpServer服务的定义\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">service\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> HttpServer\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    rpc\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> BindRoute\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">RouteInfo\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">) \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">returns\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">RequestInfo\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {}\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    rpc\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> ReturnResponse\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">ResponInfo\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">) \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">returns\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">ResponReply\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {}\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">}\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">message\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> RouteInfo\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    enum\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Method\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        GET \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 0\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        POST \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        PUT \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 2\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        DELETE \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 3\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 注册的路由pathname\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    string\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> path \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    Method\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> method \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 2\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 是否直接解析query到query中\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    bool\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> is_parse_query \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 3\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 是否解析带有Body的请求\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    bool\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> is_parse_body \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 4\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">}\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">message\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> RequestInfo\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 请求的ID，在做响应的时候需要带上\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    string\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> require_id \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 请求链接中的数据\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    map\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">string\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">string\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">> query \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 2\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 请求数据包中的数据\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    map\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">string\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">string\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">> body \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 3\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">}\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">message\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> ResponInfo\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">{\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    string\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> require_id \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    map\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">string\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">string\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">> response_head \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 2\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    string\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> response_data \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 3\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    int32\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> statusCode \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 4\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">}\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">// 返回整个请求的时间信息\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">message\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> ResponReply\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">{\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 收到请求，解析请求query、body花费的时间\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    float\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> route_parsed_time \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 传输请求数据花费的时间\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    float\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> route_send_time \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 2\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 处理请求至服务端收到数据花费的时间\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    float\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> responsed_time \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 3\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 返回请求结果给客户花费的时间\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    float\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> responsed_send_time \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 4\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">}\u003c/span>\u003c/span>\u003c/code>\u003c/pre>\n\u003cp>以上的proto文件描述了两个接口：\u003c/p>\n\u003cul>\n\u003cli>BindRoute：实现路由绑定把要绑定的路由写道path中，这里为了简单，我只是进行了字符串相等匹配。BindRoute的回调函数不会马上触发。要等到服务端有HTTP请求的时候，匹配到对应的路由，最后再执行返回。\u003c/li>\n\u003cli>ReturnResponse：BindRoute收到回调后，意味着子服务开始处理HTTP请求，在处理完成后，需要调用此函数来返回处理结果。\u003c/li>\n\u003c/ul>\n\u003cp>\u003cstrong>require_id\u003c/strong>是注册基础服务后生成的一次性编号，每一次注册都会生成一个，在收到HTTP请求是，匹配到对应的路由，就要通过这个require_id来发送请求、接受处理结果。\u003c/p>\n\u003ch2>服务端\u003c/h2>\n\u003cpre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\">\u003ccode class=\"language-js\">\u003cspan class=\"line\">\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"use strict\"\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">// PROTO文件路径，按需换成自己的文件路径\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> PROTO_PATH\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> __dirname \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">+\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\"> '/../pingpong/http-server.proto'\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> grpc\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> require\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">'grpc'\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> http\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> require\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"http\"\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> url\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> require\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"url\"\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> querystring\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> require\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"querystring\"\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">// 动态加载PROTO文件，生成接口\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> httpserver\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> grpc.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">load\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">PROTO_PATH\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">).httpserver;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">/** 路由映射表\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\"> *  结构为：{ [METHOD:GET|POST|PUT|DELETE] : { [PATHNAME] : Array&#x3C;String>[require_id,...] } }\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\"> */\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> route_res_list\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {};\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">/** require_id对应的路由注册信息与回调函数\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\"> *  结构为：{ args : 路由注册信息, callback: 回调函数，用于通知子服务来处理HTTP请求 }\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\"> */\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> handleCache\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> new\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Map\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">();\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">/** require_id对应的HTTP请求\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\"> *  结构为：{ req : HTTP.Request, res: HTTP.Response }\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\"> */\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> reqresCache\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> new\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Map\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">();\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">// 初始化路由映射表的结构\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">for\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">let\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> method \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">in\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> httpserver.RouteInfo.Method) {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    route_res_list[method] \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {};\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">}\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">/** rgRPC服务：绑定路由\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\"> *\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\"> */\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">function\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> BindRoute\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">call\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, \u003c/span>\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">callback\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> args\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> call.request;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> routes\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> route_res_list[args.method];\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    var\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> handles \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> routes[args.path];\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    if\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">!\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">handles) {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        handles \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> routes[args.path] \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> new\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Set\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">();\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 生成require_id\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> require_id\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> Math.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">random\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">().\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">toString\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">36\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">).\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">substr\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">2\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 加入路由映射表\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    handles.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">add\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(require_id);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 这里不调用callback，而是等待到收到HTTP请求的时候再执行\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    handleCache.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">set\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(require_id, {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        args: args,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        callback\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    });\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">}\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">/** rgRPC服务：响应HTTP请求\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\"> *\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\"> */\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">function\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> ReturnResponse\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">call\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, \u003c/span>\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">callback\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> args\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> call.request;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> require_id\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> args.require_id;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 取出缓存中的req、res对象\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    const\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">        req\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">        res\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    } \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> reqresCache.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">get\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(require_id);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    if\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">!\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">res) {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">        return\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> callback\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">`Ref Error:require_id:${\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">require_id\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">} no ref.`\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 返回数据\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    res.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">writeHead\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(args.statusCode, args.response_head);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    res.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">end\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(args.response_data);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 清除缓存\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    reqresCache.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">delete\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(require_id);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 返回整个流程的消耗时间，这里为了简化代码没有加统计时间的代码\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">    callback\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">null\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        route_parsed_time: \u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">0\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        route_send_time: \u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">0\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        responsed_time: \u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">0\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        responsed_send_time: \u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">0\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    });\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">}\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">function\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> main\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">() {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> grpc_server\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> new\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> grpc.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">Server\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">();\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    grpc_server.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">addProtoService\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(httpserver.HttpServer.service, {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        bindRoute: BindRoute,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        returnResponse: ReturnResponse,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    });\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 注册gRPC服务\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    grpc_server.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">bind\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">'0.0.0.0:50051'\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, grpc.ServerCredentials.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">createInsecure\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">());\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    grpc_server.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">start\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">();\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">}\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">main\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">();\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">// 注册HTTP服务\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> server\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> http.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">createServer\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">((\u003c/span>\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">req\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, \u003c/span>\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">res\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">) \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=>\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> routes\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> route_res_list[req.method];\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    if\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (routes) {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">        const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> url_info\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> url.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">parse\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(req.url);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">        const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> handles\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> routes[url_info.pathname];\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">        if\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (handles \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">&#x26;&#x26;\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> handles.size) {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">            const\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">                value\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">: \u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">require_id\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">                has_key\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            } \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> handles.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">values\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">().\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">next\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">();\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">            if\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (has_key) {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">                console.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">log\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"no handle\"\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">                return\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            }\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">            const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> handle\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> handleCache.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">get\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(require_id);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">            // 通知客户端处理HTTP请求，并带上HTTP请求的一些数据\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            handle.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">callback\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">null\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">                require_id,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">                // TODO：headers\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">                query: handle.args.is_parse_query \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">?\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> Object.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">assign\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">({}, querystring.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">parse\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(url_info.query)) \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">:\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {},\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">                // TODO：body应该改用流数据传输\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">                body: (handle.args.method \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">!==\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"GET\"\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> &#x26;&#x26;\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> handle.args.is_parse_body) \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">?\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {} \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">:\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {}\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            });\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">            // 缓存req、res\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            reqresCache.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">set\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(require_id, {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">                req,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">                res\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            });\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">            // 清除缓存，此require_id已经报废，只用于最后的响应res的处理\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            handleCache.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">delete\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(require_id);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            handles.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">delete\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(require_id);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        }\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">});\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">server.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">listen\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">1337\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, \u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"0.0.0.0\"\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, () \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=>\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {});\u003c/span>\u003c/span>\u003c/code>\u003c/pre>\n\u003ch2>子服务\u003c/h2>\n\u003cpre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\">\u003ccode class=\"language-js\">\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> PROTO_PATH\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> __dirname \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">+\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\"> '/../pingpong/http-server.proto'\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> grpc\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> require\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">'grpc'\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> http\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> require\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"http\"\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> httpserver\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> grpc.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">load\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">PROTO_PATH\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">).httpserver;\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">const\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\"> address\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> =\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\"> 'localhost:50051'\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">function\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\"> main\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">() {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">    var\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> client \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\"> new\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> httpserver.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">HttpServer\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(address, grpc.credentials.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">createInsecure\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">());\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 注册路由\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    client.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">bindRoute\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">({\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        path: \u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"/QAQ\"\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        method: httpserver.RouteInfo.Method.\u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">GET\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        is_parse_query: \u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">true\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        is_parse_body: \u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">false\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }, \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">function\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">err\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, \u003c/span>\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">response\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">        // 收到路由请求\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        console.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">log\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(err, response);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">        // 返回路由处理结果\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        client.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">returnResponse\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">({\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            require_id: response.require_id,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            statusCode: \u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">200\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">,\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            response_head: {},\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            response_data: \u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">JSON\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">stringify\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(response.query)\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        }, \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">function\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">err\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, \u003c/span>\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">response\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">            // 收到性能统计\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            console.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">log\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(err, response);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        })\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    });\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">    // 模拟发起请求\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">    setTimeout\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">function\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">() {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">        var\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> req \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> http.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">get\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"http://localhost:1337/QAQ?a=a\"\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, (\u003c/span>\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">res\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, \u003c/span>\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">socket\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, \u003c/span>\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">head\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">) \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=>\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">            var\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> datas \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> []\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            res.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">on\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"data\"\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, (\u003c/span>\u003cspan style=\"color:#E36209;--shiki-dark:#FFAB70\">chunk\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">) \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=>\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">                datas.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">push\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(chunk);\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            });\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            res.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">on\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"end\"\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, () \u003c/span>\u003cspan style=\"color:#D73A49;--shiki-dark:#F97583\">=>\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6A737D;--shiki-dark:#6A737D\">                // 打印结果\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">                console.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">log\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(\u003c/span>\u003cspan style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"request res:\"\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">, Buffer.\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">concat\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">(datas).\u003c/span>\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">toString\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">());\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">            });\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">        });\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }, \u003c/span>\u003cspan style=\"color:#005CC5;--shiki-dark:#79B8FF\">200\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">)\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">}\u003c/span>\u003c/span>\n\u003cspan class=\"line\">\u003c/span>\n\u003cspan class=\"line\">\u003cspan style=\"color:#6F42C1;--shiki-dark:#B392F0\">main\u003c/span>\u003cspan style=\"color:#24292E;--shiki-dark:#E1E4E8\">();\u003c/span>\u003c/span>\u003c/code>\u003c/pre>\n\u003chr>\n\u003ch2>总结\u003c/h2>\n\u003cp>以上代码流程只是简单的示例，有一点不好的就是路由的注册变成了一次性，这不能说完全不对。但更优的做法应该改为流数据，这就不需要调用callback来结束服务，而是可以通过流不停地发起请求，流的实践参考官方代码：\u003ca href=\"https://github.com/grpc/grpc/blob/master/examples/node/dynamic_codegen/route_guide/route_guide_server.js\" target=\"_blank\">route_guide\u003c/a>。\u003c/p>\n","markdownContent":"\n类似Google这种大公司产出的产品，一般就两种情况，一种是面向小白用户的，如此让G粉簇拥而来找Bug优化产品思路，等到时机成熟再推出正式版或者取消产品，AngularJS就是这一类。还有一种就是Google自己的需求而总结出来的产品，优点什么的我就不吹了，gRPC就是这一类的。\n## 序言\n\n> 今年年初的时候我就一直想做一款基于RPC实现组件化搭建网站的一款产品。目的就是为了让各种语言的程序员能以最低沟通、学习代价来进行快速、稳定开发产品。而当初做的时候为了速度摸坑，用了Nodejs来进行开发，做出了[GQ](https://github.com/gaubee/GQ)这款产品，自己边用边总结，说真的坑是真的多，JSON是不够用的，还有bytes、流数据等等问题。几个月下来，发现这个东西是个史诗大坑，因为要考虑到各种语言的兼容、使用难易、不同类型组件（数据库组件、流文件处理组件等）通用接口等等问题，迟迟没有拿出一套跨语言的规范来。几乎要放弃。这项目被我搁置。\n> 不巧，gRPC出来了。当初心想有搞头，但是当时文档不够健全，让那些爱折腾的人先去探探路吧。\n> 现在我作为第二批吃螃蟹的人，上手一试，心中暗叹：厉害了我的Goggle\n## 案例简介\n\n一套基于路由注册的分发服务。这里使用Nodejs来快速上手。\n服务端：注册HTTP端口，以及gRPC基础服务，通过基础服务，可以注册HTTP请求的处理权。\n子服务：注册基础服务，实现对HTTP请求的处理。\n流程如下：\n\n```\nHTTP请求--->服务端--/a/b-->子服务1\n　　　　　　　　　|--/a/c-->子服务2\n　　　　　　　　　+--/a/d-->子服务3\n```\n# 实现流程\n\n> PS:我这里不赘述**XX为什么要这以做**之类的话语，直接上代码，并简单解释代码中的重点。这个案例没有难点。\n> gRPC的安装省略。\n> 使用Nodejs版本v6.9.1。用到一些ES6的语法，不完全兼容v4.*\n## proto文件\n\n``` protobuf\nsyntax = \"proto3\";\n\noption objc_class_prefix = \"Gaubee\";\n\npackage httpserver;\n\n// HttpServer服务的定义\nservice HttpServer {\n    rpc BindRoute(RouteInfo) returns(RequestInfo) {}\n    rpc ReturnResponse(ResponInfo) returns(ResponReply) {}\n}\n\nmessage RouteInfo {\n    enum Method {\n        GET = 0;\n        POST = 1;\n        PUT = 2;\n        DELETE = 3;\n    }\n    // 注册的路由pathname\n    string path = 1;\n    Method method = 2;\n    // 是否直接解析query到query中\n    bool is_parse_query = 3;\n    // 是否解析带有Body的请求\n    bool is_parse_body = 4;\n}\nmessage RequestInfo {\n    // 请求的ID，在做响应的时候需要带上\n    string require_id = 1;\n    // 请求链接中的数据\n    map\u003cstring, string> query = 2;\n    // 请求数据包中的数据\n    map\u003cstring, string> body = 3;\n}\nmessage ResponInfo{\n    string require_id = 1;\n    map\u003cstring, string> response_head = 2;\n    string response_data = 3;\n    int32 statusCode = 4;\n}\n// 返回整个请求的时间信息\nmessage ResponReply{\n    // 收到请求，解析请求query、body花费的时间\n    float route_parsed_time = 1;\n    // 传输请求数据花费的时间\n    float route_send_time = 2;\n    // 处理请求至服务端收到数据花费的时间\n    float responsed_time = 3;\n    // 返回请求结果给客户花费的时间\n    float responsed_send_time = 4;\n}\n```\n\n以上的proto文件描述了两个接口：\n- BindRoute：实现路由绑定把要绑定的路由写道path中，这里为了简单，我只是进行了字符串相等匹配。BindRoute的回调函数不会马上触发。要等到服务端有HTTP请求的时候，匹配到对应的路由，最后再执行返回。\n- ReturnResponse：BindRoute收到回调后，意味着子服务开始处理HTTP请求，在处理完成后，需要调用此函数来返回处理结果。\n\n**require_id**是注册基础服务后生成的一次性编号，每一次注册都会生成一个，在收到HTTP请求是，匹配到对应的路由，就要通过这个require_id来发送请求、接受处理结果。\n## 服务端\n\n``` js\n\"use strict\";\n// PROTO文件路径，按需换成自己的文件路径\nconst PROTO_PATH = __dirname + '/../pingpong/http-server.proto';\nconst grpc = require('grpc');\nconst http = require(\"http\");\nconst url = require(\"url\");\nconst querystring = require(\"querystring\");\n\n// 动态加载PROTO文件，生成接口\nconst httpserver = grpc.load(PROTO_PATH).httpserver;\n\n/** 路由映射表\n *  结构为：{ [METHOD:GET|POST|PUT|DELETE] : { [PATHNAME] : Array\u003cString>[require_id,...] } }\n */\nconst route_res_list = {};\n\n/** require_id对应的路由注册信息与回调函数\n *  结构为：{ args : 路由注册信息, callback: 回调函数，用于通知子服务来处理HTTP请求 }\n */\nconst handleCache = new Map();\n/** require_id对应的HTTP请求\n *  结构为：{ req : HTTP.Request, res: HTTP.Response }\n */\nconst reqresCache = new Map();\n// 初始化路由映射表的结构\nfor (let method in httpserver.RouteInfo.Method) {\n    route_res_list[method] = {};\n}\n\n/** rgRPC服务：绑定路由\n *\n */\nfunction BindRoute(call, callback) {\n    const args = call.request;\n    const routes = route_res_list[args.method];\n    var handles = routes[args.path];\n    if (!handles) {\n        handles = routes[args.path] = new Set();\n    }\n    // 生成require_id\n    const require_id = Math.random().toString(36).substr(2);\n\n    // 加入路由映射表\n    handles.add(require_id);\n\n    // 这里不调用callback，而是等待到收到HTTP请求的时候再执行\n    handleCache.set(require_id, {\n        args: args,\n        callback\n    });\n}\n\n/** rgRPC服务：响应HTTP请求\n *\n */\nfunction ReturnResponse(call, callback) {\n    const args = call.request;\n    const require_id = args.require_id;\n    // 取出缓存中的req、res对象\n    const {\n        req,\n        res\n    } = reqresCache.get(require_id);\n    if (!res) {\n        return callback(`Ref Error:require_id:${require_id} no ref.`);\n    }\n    // 返回数据\n    res.writeHead(args.statusCode, args.response_head);\n    res.end(args.response_data);\n    // 清除缓存\n    reqresCache.delete(require_id);\n\n    // 返回整个流程的消耗时间，这里为了简化代码没有加统计时间的代码\n    callback(null, {\n        route_parsed_time: 0,\n        route_send_time: 0,\n        responsed_time: 0,\n        responsed_send_time: 0,\n    });\n}\n\nfunction main() {\n    const grpc_server = new grpc.Server();\n    grpc_server.addProtoService(httpserver.HttpServer.service, {\n        bindRoute: BindRoute,\n        returnResponse: ReturnResponse,\n    });\n    // 注册gRPC服务\n    grpc_server.bind('0.0.0.0:50051', grpc.ServerCredentials.createInsecure());\n    grpc_server.start();\n}\n\nmain();\n// 注册HTTP服务\nconst server = http.createServer((req, res) => {\n    const routes = route_res_list[req.method];\n    if (routes) {\n        const url_info = url.parse(req.url);\n        const handles = routes[url_info.pathname];\n        if (handles && handles.size) {\n            const {\n                value: require_id,\n                has_key\n            } = handles.values().next();\n            if (has_key) {\n                console.log(\"no handle\");\n                return\n            }\n            const handle = handleCache.get(require_id);\n            // 通知客户端处理HTTP请求，并带上HTTP请求的一些数据\n            handle.callback(null, {\n                require_id,\n                // TODO：headers\n                query: handle.args.is_parse_query ? Object.assign({}, querystring.parse(url_info.query)) : {},\n                // TODO：body应该改用流数据传输\n                body: (handle.args.method !== \"GET\" && handle.args.is_parse_body) ? {} : {}\n            });\n            // 缓存req、res\n            reqresCache.set(require_id, {\n                req,\n                res\n            });\n            // 清除缓存，此require_id已经报废，只用于最后的响应res的处理\n            handleCache.delete(require_id);\n            handles.delete(require_id);\n        }\n    }\n});\nserver.listen(1337, \"0.0.0.0\", () => {});\n```\n## 子服务\n\n``` js\nconst PROTO_PATH = __dirname + '/../pingpong/http-server.proto';\nconst grpc = require('grpc');\nconst http = require(\"http\");\nconst httpserver = grpc.load(PROTO_PATH).httpserver;\nconst address = 'localhost:50051'\n\nfunction main() {\n    var client = new httpserver.HttpServer(address, grpc.credentials.createInsecure());\n    // 注册路由\n    client.bindRoute({\n        path: \"/QAQ\",\n        method: httpserver.RouteInfo.Method.GET,\n        is_parse_query: true,\n        is_parse_body: false,\n    }, function(err, response) {\n        // 收到路由请求\n        console.log(err, response);\n        // 返回路由处理结果\n        client.returnResponse({\n            require_id: response.require_id,\n            statusCode: 200,\n            response_head: {},\n            response_data: JSON.stringify(response.query)\n        }, function(err, response) {\n            // 收到性能统计\n            console.log(err, response);\n        })\n\n    });\n\n    // 模拟发起请求\n    setTimeout(function() {\n        var req = http.get(\"http://localhost:1337/QAQ?a=a\", (res, socket, head) => {\n            var datas = []\n            res.on(\"data\", (chunk) => {\n                datas.push(chunk);\n            });\n            res.on(\"end\", () => {\n                // 打印结果\n                console.log(\"request res:\", Buffer.concat(datas).toString());\n            });\n        });\n    }, 200)\n}\n\nmain();\n```\n\n---\n## 总结\n\n以上代码流程只是简单的示例，有一点不好的就是路由的注册变成了一次性，这不能说完全不对。但更优的做法应该改为流数据，这就不需要调用callback来结束服务，而是可以通过流不停地发起请求，流的实践参考官方代码：[route_guide](https://github.com/grpc/grpc/blob/master/examples/node/dynamic_codegen/route_guide/route_guide_server.js)。\n"}}}</script>
        <script src="/assets/entries/entry-client-routing.yiSdiVxD.js" type="module" async></script>
        <link rel="modulepreload" href="/assets/entries/pages_article_-id.BmaUqteM.js" as="script" type="text/javascript">
        <link rel="modulepreload" href="/assets/chunks/chunk-CDWRLuPF.js" as="script" type="text/javascript">
        <link rel="modulepreload" href="/assets/chunks/chunk-BsHr0IPV.js" as="script" type="text/javascript">
      </body>
    </html>
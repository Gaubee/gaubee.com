{"abortReason":"!undefined","_urlRewrite":null,"_urlRedirect":"!undefined","abortStatusCode":"!undefined","_abortCall":"!undefined","_pageContextInitIsPassedToClient":"!undefined","pageId":"/pages/article/@id","routeParams":{"id":"How-to-start-a-modular-scalable-Web-App"},"data":{"article":{"metadata":{"layout":"layouts/article.njk","title":"「转」如何开始一个模块化可扩展的Web App","date":"!Date:2013-07-02T10:55:20.000Z","updated":"!Date:2013-07-02T11:11:16.000Z","tags":["javascript","cogitation","efficiency"],"id":"How-to-start-a-modular-scalable-Web-App","createdAt":"!Date:2013-07-02T10:55:20.000Z","updatedAt":"!Date:2013-07-02T11:11:16.000Z"},"htmlContent":"<p>原文地址：<a href=\"http://avnpc.com/pages/start-a-modular-extensible-webapp\">http://avnpc.com/pages/start-a-modular-extensible-webapp</a>\n作者：<a href=\"https://plus.google.com/104171418568283484752/posts\" target=\"_blank\">Allo Vince</a></p>\n<p>虽然从没有认为自己是一个前端开发者，但不知不觉中也积累下了一些前端开发的经验。正巧之前碰到一道面试题，于是就顺便梳理了一下自己关于Web App的一些思路并整理为本文。</p>\n<p>对于很多简单的网站或Web应用来说，引入jQuery以及一些插件，在当前页面内写入简单逻辑已经可以满足大部分需要。但是如果一旦多人开发，应用的复杂程度上升，就会有很多问题开始暴露出来：</p>\n<ul>\n<li>数据源一般都与页面分离，那么App启动一般都需要等待数据源读入。</li>\n<li>UI交互复杂时，需要将逻辑通过面向对象抽象后才能更好的复用。</li>\n<li>功能间一般都存在依赖关系，需要引入支持依赖关系的模块加载器。</li>\n</ul>\n<p>那么如何解决这些问题，就以一个简单的订餐App为例，从零开始一个<a href=\"http://avnpc.com/pages/start-a-modular-extensible-webapp\">模块化可扩展Web App</a>。</p>\n<p>这个简单的App基于HTML5 Boilerplate、requireJS、jQuery Mobile、Underscore.js，后端逻辑用<a href=\"http://www.jstorage.info/\">jStorage</a>模拟实现。完成后的<a href=\"http://allovince.github.com/webapp-startup/\">成品</a>在此。所有代码可以<a href=\"https://github.com/AlloVince/webapp-startup\" target=\"_blank\">在github查看</a>。下文将逐一介绍实现的思路与方法。</p>\n<h2>从选择一个好模板开始</h2>\n<p>开始一个Web项目，HTML的书写总是重中之重，一个好的HTML能从根源上规避大量潜在问题，所以Web App应该全部应用一个标准化的高质量HTML模板，而不是将所有页面交由开发人员自由发挥。</p>\n<p>这里推荐使用<a href=\"http://html5boilerplate.com/\">HTML5 Boilerplate项目</a>作为App的默认模板以及文件路径规范，无论是网站或者富UI的App，都可以采用这个模板作为起步。</p>\n<p>可以使用</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-text\"><span class=\"line\"><span>git clone git://github.com/h5bp/html5-boilerplate.git</span></span></code></pre>\n<p>或者直接下载<a href=\"https://github.com/h5bp/html5-boilerplate\" target=\"_blank\">HTML5 Boilerplate项目代码</a>。HTML5 Boilerplate的文件结构如下，</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-text\"><span class=\"line\"><span>.</span></span>\n<span class=\"line\"><span>├── css</span></span>\n<span class=\"line\"><span>│   ├── main.css</span></span>\n<span class=\"line\"><span>│   └── normalize.css</span></span>\n<span class=\"line\"><span>├── doc</span></span>\n<span class=\"line\"><span>├── img</span></span>\n<span class=\"line\"><span>├── js</span></span>\n<span class=\"line\"><span>│   ├── main.js</span></span>\n<span class=\"line\"><span>│   ├── plugins.js</span></span>\n<span class=\"line\"><span>│   └── vendor</span></span>\n<span class=\"line\"><span>│       ├── jquery.min.js</span></span>\n<span class=\"line\"><span>│       └── modernizr.min.js</span></span>\n<span class=\"line\"><span>├── .htaccess</span></span>\n<span class=\"line\"><span>├── 404.html</span></span>\n<span class=\"line\"><span>├── index.html</span></span>\n<span class=\"line\"><span>├── humans.txt</span></span>\n<span class=\"line\"><span>├── robots.txt</span></span>\n<span class=\"line\"><span>├── crossdomain.xml</span></span>\n<span class=\"line\"><span>├── favicon.ico</span></span>\n<span class=\"line\"><span>└── [apple-touch-icons]</span></span></code></pre>\n<p>从上向下看</p>\n<ul>\n<li><code>css</code> 用于存放css文件，并内置了<a href=\"https://github.com/necolas/normalize.css\" target=\"_blank\">Normalize.css</a>作为默认CSS重置手段（其实Normalize.css不能算是CSS reset）。</li>\n<li><code>doc</code> 存放项目文档</li>\n<li><code>img</code> 存放项目图片</li>\n<li><code>js</code> 存放javascript文件，其中第三方类库推荐放在<code>vendor</code>下</li>\n<li><code>.htaccess</code> 内置了很多对于静态文件在Apache下的优化策略，如果Web服务器不是Apache则可以参考<a href=\"https://github.com/h5bp/server-configs\" target=\"_blank\">其他Web服务器配置优化</a>。</li>\n<li><code>404.html</code> 默认的404页面，</li>\n<li><code>index.html</code> 项目模板</li>\n<li><code>humans.txt</code> 相对于面向机器人的<code>robots.txt</code>，humans.txt更像是小幽默，这在里可以写关于项目/团队的介绍，或者放置一些彩蛋给那些喜欢对你的应用刨根问底的用户们。</li>\n<li><code>robots.txt</code> 用于告诉搜索引擎蜘蛛爬行规则</li>\n<li><code>crossdomain.xml</code> 用于配置<a href=\"http://www.adobe.com/devnet/articles/crossdomain_policy_file_spec.html\">Flash的跨域策略</a></li>\n<li><code>favicon.ico</code> <code>apple-touch-icon.png</code>等小图标。</li>\n</ul>\n<p>如果是一个主要面向移动设备，还有更具针对性的<a href=\"http://html5boilerplate.com/mobile/\">Mobile Boilerplate</a>可供参考。</p>\n<h2>制定统一的编码规范</h2>\n<p>在正式开始编码之前，无论是多大规模的应用，多少人的团队，一定要有一个统一的规范，才能保证后续的开发不会乱套。</p>\n<p>前端规范其实又要分为三部分：HTML、CSS、Javascript应该分别有自己的规范。HTML/CSS主要约定id/class的命名规则、属性的书写顺序。JavaScript可能需要细化到缩进、编码风格、面向对象写法等等。</p>\n<p>最省事的方法当然还是参考已有的规范，比如<a href=\"http://google-styleguide.googlecode.com/svn/trunk/htmlcssguide.xml\">Google的HTML/CSS风格指南</a>、<a href=\"http://google-styleguide.googlecode.com/svn/trunk/javascriptguide.xml\">Google的Javascript编码指南</a>等等。</p>\n<h2>HTML篇</h2>\n<p>HTML5 Boilerplate的模板核心部分不过30行，但是每一行都可谓千锤百炼，可以用最小的消耗解决一些前端的顽固问题：</p>\n<h3>使用条件注释区分IE浏览器</h3>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-html\"><span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;!</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">DOCTYPE</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> html</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">&#x3C;!--[if lt IE 7]>      &#x3C;html class=\"no-js lt-ie9 lt-ie8 lt-ie7\"> &#x3C;![endif]--></span></span>\n<span class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">&#x3C;!--[if IE 7]>         &#x3C;html class=\"no-js lt-ie9 lt-ie8\"> &#x3C;![endif]--></span></span>\n<span class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">&#x3C;!--[if IE 8]>         &#x3C;html class=\"no-js lt-ie9\"> &#x3C;![endif]--></span></span>\n<span class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">&#x3C;!--[if gt IE 8]>&#x3C;!--></span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> &#x3C;</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">html</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> class</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"no-js\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">> </span><span style=\"color:#6A737D;--shiki-dark:#6A737D\">&#x3C;!--&#x3C;![endif]--></span></span></code></pre>\n<p>之所以要这样写</p>\n<ul>\n<li>可以使用class作为全局条件区分低版本的IE浏览器并进行调整，这显然要优于使用CSS Hack。</li>\n<li>可以避免<a href=\"http://webforscher.wordpress.com/2010/05/20/ie-6-slowing-down-ie-8/\">IE6条件注释引起的高版本IE文件阻塞问题</a>，原文的解决方法是在前面加一个空白的条件注释，但是这里显然将原本无用空白的条件注释变得有意义了。</li>\n<li>仍然可以通过HTML验证。</li>\n<li>与Modernizr等特征检测类库使用相同的class，更具备通用性。</li>\n</ul>\n<p><code>no-js</code>标签是需要与Modernizr等类库配合使用的，如果你不想在项目中引入Modernizr，需要在Head部分加入一行使<code>no-js</code>标签变为<code>js</code>，代码来自<a href=\"http://paulirish.com/2009/avoiding-the-fouc-v3/\">Avoiding the FOUC</a>：</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-html\"><span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> &#x3C;</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">script</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">>(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">H</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">){</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">H</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.className</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">H</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.className.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">replace</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">/</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">\\b</span><span style=\"color:#032F62;--shiki-dark:#DBEDFF\">no-js</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">\\b</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">/</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">,</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'js'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)})(document.documentElement)&#x3C;/</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">script</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">></span></span></code></pre>\n<p>通过上面的条件注释，就可以在CSS中针对不同情况分别处理</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-text\"><span class=\"line\"><span>.lt-ie7 {} /* IE6等版本时 */</span></span>\n<span class=\"line\"><span>.no-js {} /* JavaScript没有启用时 */</span></span></code></pre>\n<h3>meta标签的书写顺序</h3>\n<p>为了让浏览器识别正确的编码，meta charset标签应该先于title标签出现。</p>\n<p>meta X-UA-Compatible标签可以指定IE8以上版本浏览器以最高级模式渲染文档，同时如果已经安装<a href=\"http://www.google.com/chromeframe?quickenable=true\">Google Chrome Frame</a>则直接使用Chrome Frame渲染。而指定渲染模式的<a href=\"http://msdn.microsoft.com/en-us/library/cc288325%28VS.85%29.aspx\">meta X-UA-Compatible标签同样需要优先出现</a></p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-html\"><span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">meta</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> charset</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"utf-8\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">meta</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> http-equiv</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"X-UA-Compatible\"</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> content</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"IE=edge,chrome=1\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">title</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">>&#x3C;/</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">title</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">></span></span></code></pre>\n<h3>设置移动设备显示窗口宽度</h3>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-html\"><span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">meta</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> name</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"viewport\"</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> content</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"width=device-width\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">></span></span></code></pre>\n<p>这是移动设备专属的标签，具体设置需要根据项目实际情况调整。</p>\n<h3>使用Modernizr做浏览器差异检测</h3>\n<p><a href=\"http://modernizr.com/\">Modernizr</a>常做前端的应该都不陌生。引入Modernizr后，html标签的<code>no-js</code>将会被自动替换为<code>js</code>，同时Modernizr会向html标签添加代表版本检测结果的class。</p>\n<p>对于低版本浏览器的向上兼容需要根据项目实际需求处理，Modernizr也非常周到的给出的<a href=\"https://github.com/Modernizr/Modernizr/wiki/HTML5-Cross-browser-Polyfills\" target=\"_blank\">绝大多数HTML5功能的兼容方法</a>。</p>\n<h2>CSS篇</h2>\n<h3>CSS重置及增强功能</h3>\n<p>HTML5 Boilerplate选择<a href=\"https://github.com/necolas/normalize.css\" target=\"_blank\">Normalize.css</a>重置CSS。如果项目计划引入Twitter Bootstrap、YUI 3这些前端框架的话则可以移除，因为这些框架已经内置了Normalize.css。</p>\n<p>同时HTML5 Boilerplate又引入了一个main.css，内置了一些基本的排版样式以及打印样式。</p>\n<h3>使用LESS或Sass生成CSS</h3>\n<p>在复杂应用中，如果还手写CSS的话将是一件痛苦的事情，大量的class前缀，复用样式需要来回copy等等。为了更好的扩展性，这里建议在项目中引入<a href=\"http://lesscss.org/\">LESS</a>或<a href=\"http://sass-lang.com/\">Sass</a>。这代表着：</p>\n<ul>\n<li>支持变量与简单运算</li>\n<li>支持CSS片段复用</li>\n<li>class/id样式嵌套</li>\n</ul>\n<p>等一些更像是编程语言的特性。这对于提高开发效率是效果非常明显的。</p>\n<p>以LESS为例，简单介绍一下LESS在Windows下如何应用到这个项目中：</p>\n<ul>\n<li>下载<a href=\"http://nodejs.org/\">Nodejs</a>并安装，nodejs会自动将自己加入系统路径。</li>\n<li>在cmd运行</li>\n</ul>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-text\"><span class=\"line\"><span>npm install -g less</span></span></code></pre>\n<ul>\n<li>然后就可以通过lessc指令将less源文件编译为css</li>\n</ul>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-text\"><span class=\"line\"><span>lessc avnpc.less avnpc.css</span></span></code></pre>\n<ul>\n<li>如果不使用nodeJs作为后端，最好在写LESS时采用watch模式，每次保存自动编译为css。这里需要安装一个辅助模块recess：</li>\n</ul>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-text\"><span class=\"line\"><span>npm install -g recess</span></span></code></pre>\n<p>然后运行watch</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-text\"><span class=\"line\"><span>recess avnpc.less:avnpc.css --watch</span></span></code></pre>\n<h2>Javascript篇</h2>\n<h3>使用requireJS按需加载</h3>\n<p>模块加载器的概念可能稍微接触过前端开发的童鞋都不会陌生，通过模块加载器可以有效的解决这些问题：</p>\n<ul>\n<li>JS文件的依赖关系。</li>\n<li>通过异步加载优化script标签引起的阻塞问题</li>\n<li>可以简单的以文件为单位将功能模块化并实现复用</li>\n</ul>\n<p>主流的JS模块加载器有<a href=\"http://requirejs.org/\">requireJS</a>，<a href=\"http://seajs.org/docs/\">SeaJS</a>等，加载器之间可能会因为遵循的规范不同有微妙的差别，从纯用户的角度出发，之所以选requireJS而不是SeaJS主要是因为：</p>\n<ul>\n<li>功能实现上两者相差无几，没有明显的性能差异或重大问题。</li>\n<li>文档丰富程度上，requireJS远远好于SeaJS，就拿最简单的加载jQuery和jQuery插件这回事，虽然两者的实现方法相差无几，但requireJS就有可以直接拿来用的Demo，SeaJS还要读文档自己慢慢折腾。一些问题的解决上，requireJS为关键词也更容易找到答案。</li>\n</ul>\n<h4>requireJS 加载jQuery + jQuery插件</h4>\n<p>可能对于一般Web App来说，引入jQuery及相关插件的概率是最大的，requireJS也亲切的给出了相应的解决方案及<a href=\"http://requirejs.org/docs/jquery.html\">动态加载jQuery及插件</a>的文档及<a href=\"http://requirejs.org/docs/download.html#samplejquery\">实例代码</a>。</p>\n<p>在最新的jQuery1.9.X中，jQuery已经在最后直接将自己注册为一个<a href=\"https://github.com/amdjs/amdjs-api/wiki/AMD\" target=\"_blank\">AMD模块</a>，即是说可以直接被requireJS作为模块加载。如果是加载旧版的jQuery有两种方法：</p>\n<p><strong>1. 让jQuery先于requireJS加载</strong></p>\n<p><strong>2. 对jQuery代码稍做一点处理，在jQuery代码包裹一句：</strong></p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-js\"><span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">define</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">([</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"jquery\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">], </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">$</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">    // $ is guaranteed to be jQuery now */</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">});</span></span></code></pre>\n<p>requireJS的示例中，直接将requireJS与jQuery合并为一个文件，如果是采用jQuery作为核心库的话推荐这种做法。</p>\n<p>同样对于jQuery插件来说也有两种方法</p>\n<p><strong>1. 在插件外包裹代码</strong></p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-js\"><span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">define</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">([</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"jquery\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">], </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">$</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">){</span></span>\n<span class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">     // Put here the plugin code. </span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">});</span></span></code></pre>\n<p><strong>2. 在使用reuqireJS代码加载前注册插件（比如在main.js）中</strong></p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-js\"><span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">requirejs.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">config</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">({</span></span>\n<span class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">    \"shim\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: {</span></span>\n<span class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">        \"jquery-cookie\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">  : [</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"jquery\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">});</span></span></code></pre>\n<h4>requireJS加载第三方类库</h4>\n<p>在实例的App中还用到了jQuery以外的第三方类库，如果类库不是一个标准的AMD模块而又不想更改这些类库的代码，同样需要提前进行定义：</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-js\"><span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">require.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">config</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">({</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">      paths: {</span></span>\n<span class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">            'underscore'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'vendor/underscore'</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">      },</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">      shim: {</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">          underscore: {</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">              exports: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'_'</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">          }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">      }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">});</span></span></code></pre>\n<h4>CSS文件的模块化处理</h4>\n<p>在requireJS中，模块的概念仅限于JS文件，如果需要加载图片、JSON等非JS文件，requireJS实现了一系列<a href=\"http://requirejs.org/docs/plugins.html\">加载插件</a>。</p>\n<p>但是遗憾的是requireJS官方没有对CSS进行模块化处理，而我们在实际项目中却往往能遇到一些场景，比如一个轮播的图片展示栏，比如高级编辑器等等。几乎所有的富UI组件都会由JS与CSS两部分构成，而CSS之间也存在着模块的概念以及依赖关系。</p>\n<p>为了更好的与requireJS整合，这里采用<a href=\"https://github.com/guybedford/require-css\" target=\"_blank\">require-css</a>来解决CSS的模块化与依赖问题。</p>\n<p>require-css是一个requireJS插件，下载后将<code>css.js</code>与<code>normalize.js</code>放于main.js同级即可默认被加载，比如在我们的项目中需要加载jQuery Mobile的css文件，那么可以直接这样调用：</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-js\"><span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">require</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">([</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'jquery'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'css!../css/jquery.mobile-1.3.0.min.css'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">], </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">$</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">});</span></span></code></pre>\n<p>不过由于这个CSS本质上是属于jQuery Mobile模块的一部分，更好的做法是将这个CSS文件的定义放在jQuery Mobile的依赖关系中，最终我们的requireJS定义部分为：</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-js\"><span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">require.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">config</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">({</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">      paths: {</span></span>\n<span class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">            'jquerymobile'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'vendor/jquery.mobile-1.3.0'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">            'jstorage'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> : </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'vendor/jstorage'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">            'underscore'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'vendor/underscore'</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">      },</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">      shim: {</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">          jquerymobile : {</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            deps: [</span></span>\n<span class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">                'css!../css/jquery.mobile-1.3.0.min.css'</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            ]</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">          },</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">          underscore: {</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">              exports: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'_'</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">          }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">      }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">});</span></span></code></pre>\n<p>在使用模块时，只需要：</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-js\"><span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">require</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">([</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'jquery'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'underscore'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'jquerymobile'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'jstorage'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">], </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">$</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">_</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">});</span></span></code></pre>\n<p>jQuery Mobile的CSS文件就会被自动加载，这样CSS与JS就被整合为一个模块了。同理其他有复杂依赖关系的模块也可以做类似处理，requireJS会解决依赖关系的逻辑。</p>\n<h3>数据源的加载与等待</h3>\n<p>Web App一般都会动态加载后端的数据，数据格式一般可以是JSON、JSONP也可以直接是一个JS变量。这里以JS变量为例</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-js\"><span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> restaurants </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> [</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    {</span></span>\n<span class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">        \"name\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"KFC\"</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    {</span></span>\n<span class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">        \"name\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"7-11\"</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    {</span></span>\n<span class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">        \"name\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"成都小吃\"</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">]</span></span></code></pre>\n<p>载入这段数据:</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-js\"><span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">$.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">getScript</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'data/restaurants.json'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">e</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">){</span></span>\n<span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> data </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> window.restaurants;</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">    alert</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(data[</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">0</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">].name); </span><span style=\"color:#6A737D;--shiki-dark:#6A737D\">//KFC</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">});</span></span></code></pre>\n<p>单一的数据源确实很简单，但是往往一个应用中会有多个数据源，比如在这个实例App中UI就需要载入用户信息、餐厅信息、订餐信息三种数据后才能工作。如果仅仅靠多层嵌套回调函数的话，可能代码的耦合就非常重了。</p>\n<p>为了解决多个数据加载的问题，我习惯的解决方法是构造一个dataReady事件响应机制。</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-js\"><span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> foodOrder </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">    //数据载入后要执行的函数暂存在这里</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    dataReadyFunc : []</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">    //数据源URL及载入状态</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    , dataSource : [</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        { url : </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'data/restaurants.json'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, ready : </span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">false</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, data : </span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">null</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        { url : </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'data/users.json'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, ready : </span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">false</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, data : </span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">null</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        { url : </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'data/foods.json'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, ready : </span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">false</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, data : </span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">null</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    ]</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">    //检查数据源是否全部载入完毕</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    , </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">isReady</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> : </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(){</span></span>\n<span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> isReady </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> true</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        for</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> key </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">in</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> this</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.dataSource){</span></span>\n<span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">            if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">this</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.dataSource[key].ready </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!==</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> true</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">){</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                isReady </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> false</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        return</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> isReady;</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">    //数据源全部加载完毕，则逐一运行dataReadyFunc中存放的函数</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    , </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">callReady</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> : </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(){</span></span>\n<span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">true</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> ===</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> this</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">isReady</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()){</span></span>\n<span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">            for</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> key </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">in</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> this</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.dataReadyFunc){</span></span>\n<span class=\"line\"><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">                this</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.dataReadyFunc[key]();</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">    //供外部调用，会将外部输入的函数暂存在dataReadyFunc中</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    , </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">dataReady</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> : </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">func</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">){</span></span>\n<span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">typeof</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> func </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!==</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> 'function'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">            return</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> false</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        } </span></span>\n<span class=\"line\"><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">        this</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.dataReadyFunc.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">push</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(func);</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    , </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">init</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> : </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(){</span></span>\n<span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> self </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> this</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        var</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> _initElement</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> =</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">key</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">url</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">){</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            $.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">getScript</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(url, </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">e</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">){</span></span>\n<span class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">                //每次载入数据后，将数据存放于dataSource中，将ready状态置为true，并调用callReady</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                self.dataSource[key].data </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> window[key];</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                self.dataSource[key].ready </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> true</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                self.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">callReady</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            });</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        for</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> key </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">in</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> this</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.dataSource){</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">            _initElement</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(key, </span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">this</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.dataSource[key].url);</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span></code></pre>\n<p>用法为</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-js\"><span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">foodOrder.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">dataReady</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(){</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">   alert</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);     </span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">});</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">foodOrder.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">init</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">();</span></span></code></pre>\n<p>dataReady内的alert将会在所有数据载入完毕后开始执行。</p>\n<p>这段处理的逻辑并不复杂，将所有要执行的方法通过dataReady暂存起来，等待数据全部加载完毕后再执行，更加复杂的场景此方法仍然通用。</p>\n<h3>使用JS模板引擎</h3>\n<p>数据载入后，最终都会以某种形式显示在页面上。简单情况，我们可能会这样做：</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-js\"><span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">$</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'body'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">).</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">append</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'&#x3C;div>'</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> data.name </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">+</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> '&#x3C;/div>'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span></code></pre>\n<p>如果页面逻辑一旦复杂，比如需要有if判断或者多层循环时，这种连接字符串的方式就相形见绌了，而这也就催生出了JS模板引擎。</p>\n<p>主流的JS模板引擎有<a href=\"http://documentcloud.github.com/underscore/\">underscore.js</a>，<a href=\"http://jade-lang.com/\">Jade</a>，<a href=\"http://embeddedjs.com/\">EJS</a>等等，可以<a href=\"http://engineering.linkedin.com/frontend/client-side-templating-throwdown-mustache-handlebars-dustjs-and-more\">横向对比一下这些JS模板引擎的优缺点</a>。</p>\n<p>对于相对简单的页面逻辑（只需要支持if和for/each）来说，我更倾向选用轻巧的underscore.js或者<a href=\"https://github.com/blueimp/JavaScript-Templates\" target=\"_blank\">JavaScript Templates</a>。</p>\n<p>在当前例子中，使用underscore.js生成列表就非常简单了，页面模板为：</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-html\"><span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">ul</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> data-role</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"listview\"</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> data-inset</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"true\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">script</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> id</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"tmpl-restaurants\"</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> type</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"text/template\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    &#x3C;% _.each(data, function(restaurant) { %></span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        &#x3C;</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">li</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            &#x3C;</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">a</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> href</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"#\"</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> data-rel</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"back\"</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> data-value</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"&#x3C;%- restaurant.name%>\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">>&#x3C;%- restaurant.name%>&#x3C;/</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">a</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        &#x3C;/</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">li</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    &#x3C;% }); %></span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;/</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">script</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;/</span><span style=\"color:#22863A;--shiki-dark:#85E89D\">ul</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">></span></span></code></pre>\n<p>调用引擎</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-js\"><span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">$</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"#tmpl-restaurants\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">).</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">replaceWith</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    _.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">template</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">$</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"#tmpl-restaurants\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">).</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">html</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(), {</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        data : restaurants</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span></code></pre>\n<h3>面向对象与模块化</h3>\n<p>通过上面这些工具的组合，我们有了模块的概念，有了模板引擎，有数据的加载。最终还是要通过javascript将这一切组织在一起并加入应用所需要的逻辑。为了能最大限度的复用代码，用面向对象的方式去组织内容是比较好的选择。</p>\n<p>JavaScript虽然原生并不支持面向对象，但是依然可以通过很多方式模拟出面向对象的特性。例子中采用了我个人比较喜欢的一种方式是：</p>\n<pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code class=\"language-js\"><span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">var</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> foodOrder</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> =</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">ui</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">options</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">){</span></span>\n<span class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">    //构造函数</span></span>\n<span class=\"line\"><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">    this</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">init</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(ui, options);</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">foodOrder</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">prototype</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> =</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">   defaultUI :  {</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">       form : </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'#form-order'</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">   }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">   , defaultOptions : {</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">       debug : </span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">false</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">   }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">   , </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">init</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> : </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">ui</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">options</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">){</span></span>\n<span class=\"line\"><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">       this</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.ui </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> $.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">extend</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">({}, </span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">this</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.defaultUI, ui);</span></span>\n<span class=\"line\"><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">       this</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.options </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> $.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">extend</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">({}, </span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">this</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">.defaultOptions, options);</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">   }</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> order </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> new</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> foodOrder</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">({</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    form : </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'#real-form'</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}, {</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    debug : </span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">true</span></span>\n<span class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">});</span></span></code></pre>\n<p>将页面的UI元素以及配置项目抽象出来，在实际构造对象时则可以通过入口参数复写，可以分离整个项目的逻辑与UI，使处理的方式更加灵活。</p>\n<hr>\n<p><strong>2013-07-02 19:08:09</strong></p>\n","markdownContent":"\n原文地址：[http://avnpc.com/pages/start-a-modular-extensible-webapp](http://avnpc.com/pages/start-a-modular-extensible-webapp)\n作者：[Allo Vince](https://plus.google.com/104171418568283484752/posts)\n\n虽然从没有认为自己是一个前端开发者，但不知不觉中也积累下了一些前端开发的经验。正巧之前碰到一道面试题，于是就顺便梳理了一下自己关于Web App的一些思路并整理为本文。\n\n对于很多简单的网站或Web应用来说，引入jQuery以及一些插件，在当前页面内写入简单逻辑已经可以满足大部分需要。但是如果一旦多人开发，应用的复杂程度上升，就会有很多问题开始暴露出来：\n- 数据源一般都与页面分离，那么App启动一般都需要等待数据源读入。\n- UI交互复杂时，需要将逻辑通过面向对象抽象后才能更好的复用。\n- 功能间一般都存在依赖关系，需要引入支持依赖关系的模块加载器。\n\n那么如何解决这些问题，就以一个简单的订餐App为例，从零开始一个[模块化可扩展Web App](http://avnpc.com/pages/start-a-modular-extensible-webapp)。\n\n这个简单的App基于HTML5 Boilerplate、requireJS、jQuery Mobile、Underscore.js，后端逻辑用[jStorage](http://www.jstorage.info/)模拟实现。完成后的[成品](http://allovince.github.com/webapp-startup/)在此。所有代码可以[在github查看](https://github.com/AlloVince/webapp-startup)。下文将逐一介绍实现的思路与方法。\n## 从选择一个好模板开始\n\n开始一个Web项目，HTML的书写总是重中之重，一个好的HTML能从根源上规避大量潜在问题，所以Web App应该全部应用一个标准化的高质量HTML模板，而不是将所有页面交由开发人员自由发挥。\n\n这里推荐使用[HTML5 Boilerplate项目](http://html5boilerplate.com/)作为App的默认模板以及文件路径规范，无论是网站或者富UI的App，都可以采用这个模板作为起步。\n\n可以使用\n\n```\ngit clone git://github.com/h5bp/html5-boilerplate.git\n```\n\n或者直接下载[HTML5 Boilerplate项目代码](https://github.com/h5bp/html5-boilerplate)。HTML5 Boilerplate的文件结构如下，\n\n```\n.\n├── css\n│   ├── main.css\n│   └── normalize.css\n├── doc\n├── img\n├── js\n│   ├── main.js\n│   ├── plugins.js\n│   └── vendor\n│       ├── jquery.min.js\n│       └── modernizr.min.js\n├── .htaccess\n├── 404.html\n├── index.html\n├── humans.txt\n├── robots.txt\n├── crossdomain.xml\n├── favicon.ico\n└── [apple-touch-icons]\n```\n\n从上向下看\n- `css` 用于存放css文件，并内置了[Normalize.css](https://github.com/necolas/normalize.css)作为默认CSS重置手段（其实Normalize.css不能算是CSS reset）。\n- `doc` 存放项目文档\n- `img` 存放项目图片\n- `js` 存放javascript文件，其中第三方类库推荐放在`vendor`下\n- `.htaccess` 内置了很多对于静态文件在Apache下的优化策略，如果Web服务器不是Apache则可以参考[其他Web服务器配置优化](https://github.com/h5bp/server-configs)。\n- `404.html` 默认的404页面，\n- `index.html` 项目模板\n- `humans.txt` 相对于面向机器人的`robots.txt`，humans.txt更像是小幽默，这在里可以写关于项目/团队的介绍，或者放置一些彩蛋给那些喜欢对你的应用刨根问底的用户们。\n- `robots.txt` 用于告诉搜索引擎蜘蛛爬行规则\n- `crossdomain.xml` 用于配置[Flash的跨域策略](http://www.adobe.com/devnet/articles/crossdomain_policy_file_spec.html)\n- `favicon.ico` `apple-touch-icon.png`等小图标。\n\n如果是一个主要面向移动设备，还有更具针对性的[Mobile Boilerplate](http://html5boilerplate.com/mobile/)可供参考。\n## 制定统一的编码规范\n\n在正式开始编码之前，无论是多大规模的应用，多少人的团队，一定要有一个统一的规范，才能保证后续的开发不会乱套。\n\n前端规范其实又要分为三部分：HTML、CSS、Javascript应该分别有自己的规范。HTML/CSS主要约定id/class的命名规则、属性的书写顺序。JavaScript可能需要细化到缩进、编码风格、面向对象写法等等。\n\n最省事的方法当然还是参考已有的规范，比如[Google的HTML/CSS风格指南](http://google-styleguide.googlecode.com/svn/trunk/htmlcssguide.xml)、[Google的Javascript编码指南](http://google-styleguide.googlecode.com/svn/trunk/javascriptguide.xml)等等。\n## HTML篇\n\nHTML5 Boilerplate的模板核心部分不过30行，但是每一行都可谓千锤百炼，可以用最小的消耗解决一些前端的顽固问题：\n### 使用条件注释区分IE浏览器\n\n``` html\n<!DOCTYPE html>\n<!--[if lt IE 7]>      <html class=\"no-js lt-ie9 lt-ie8 lt-ie7\"> <![endif]-->\n<!--[if IE 7]>         <html class=\"no-js lt-ie9 lt-ie8\"> <![endif]-->\n<!--[if IE 8]>         <html class=\"no-js lt-ie9\"> <![endif]-->\n<!--[if gt IE 8]><!--> <html class=\"no-js\"> <!--<![endif]-->\n```\n\n之所以要这样写\n- 可以使用class作为全局条件区分低版本的IE浏览器并进行调整，这显然要优于使用CSS Hack。\n- 可以避免[IE6条件注释引起的高版本IE文件阻塞问题](http://webforscher.wordpress.com/2010/05/20/ie-6-slowing-down-ie-8/)，原文的解决方法是在前面加一个空白的条件注释，但是这里显然将原本无用空白的条件注释变得有意义了。\n- 仍然可以通过HTML验证。\n- 与Modernizr等特征检测类库使用相同的class，更具备通用性。\n\n`no-js`标签是需要与Modernizr等类库配合使用的，如果你不想在项目中引入Modernizr，需要在Head部分加入一行使`no-js`标签变为`js`，代码来自[Avoiding the FOUC](http://paulirish.com/2009/avoiding-the-fouc-v3/)：\n\n``` html\n <script>(function(H){H.className=H.className.replace(/\\bno-js\\b/,'js')})(document.documentElement)</script>\n```\n\n通过上面的条件注释，就可以在CSS中针对不同情况分别处理\n\n```\n.lt-ie7 {} /* IE6等版本时 */\n.no-js {} /* JavaScript没有启用时 */\n```\n### meta标签的书写顺序\n\n为了让浏览器识别正确的编码，meta charset标签应该先于title标签出现。\n\nmeta X-UA-Compatible标签可以指定IE8以上版本浏览器以最高级模式渲染文档，同时如果已经安装[Google Chrome Frame](http://www.google.com/chromeframe?quickenable=true)则直接使用Chrome Frame渲染。而指定渲染模式的[meta X-UA-Compatible标签同样需要优先出现](http://msdn.microsoft.com/en-us/library/cc288325%28VS.85%29.aspx)\n\n``` html\n<meta charset=\"utf-8\">\n<meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\">\n<title></title>\n```\n### 设置移动设备显示窗口宽度\n\n``` html\n<meta name=\"viewport\" content=\"width=device-width\">\n```\n\n这是移动设备专属的标签，具体设置需要根据项目实际情况调整。\n### 使用Modernizr做浏览器差异检测\n\n[Modernizr](http://modernizr.com/)常做前端的应该都不陌生。引入Modernizr后，html标签的`no-js`将会被自动替换为`js`，同时Modernizr会向html标签添加代表版本检测结果的class。\n\n对于低版本浏览器的向上兼容需要根据项目实际需求处理，Modernizr也非常周到的给出的[绝大多数HTML5功能的兼容方法](https://github.com/Modernizr/Modernizr/wiki/HTML5-Cross-browser-Polyfills)。\n## CSS篇\n### CSS重置及增强功能\n\nHTML5 Boilerplate选择[Normalize.css](https://github.com/necolas/normalize.css)重置CSS。如果项目计划引入Twitter Bootstrap、YUI 3这些前端框架的话则可以移除，因为这些框架已经内置了Normalize.css。\n\n同时HTML5 Boilerplate又引入了一个main.css，内置了一些基本的排版样式以及打印样式。\n### 使用LESS或Sass生成CSS\n\n在复杂应用中，如果还手写CSS的话将是一件痛苦的事情，大量的class前缀，复用样式需要来回copy等等。为了更好的扩展性，这里建议在项目中引入[LESS](http://lesscss.org/)或[Sass](http://sass-lang.com/)。这代表着：\n- 支持变量与简单运算\n- 支持CSS片段复用\n- class/id样式嵌套\n\n等一些更像是编程语言的特性。这对于提高开发效率是效果非常明显的。\n\n以LESS为例，简单介绍一下LESS在Windows下如何应用到这个项目中：\n- 下载[Nodejs](http://nodejs.org/)并安装，nodejs会自动将自己加入系统路径。\n- 在cmd运行\n\n```\nnpm install -g less\n```\n- 然后就可以通过lessc指令将less源文件编译为css\n\n```\nlessc avnpc.less avnpc.css\n```\n- 如果不使用nodeJs作为后端，最好在写LESS时采用watch模式，每次保存自动编译为css。这里需要安装一个辅助模块recess：\n\n```\nnpm install -g recess\n```\n\n然后运行watch\n\n```\nrecess avnpc.less:avnpc.css --watch\n```\n## Javascript篇\n### 使用requireJS按需加载\n\n模块加载器的概念可能稍微接触过前端开发的童鞋都不会陌生，通过模块加载器可以有效的解决这些问题：\n- JS文件的依赖关系。\n- 通过异步加载优化script标签引起的阻塞问题\n- 可以简单的以文件为单位将功能模块化并实现复用\n\n主流的JS模块加载器有[requireJS](http://requirejs.org/)，[SeaJS](http://seajs.org/docs/)等，加载器之间可能会因为遵循的规范不同有微妙的差别，从纯用户的角度出发，之所以选requireJS而不是SeaJS主要是因为：\n- 功能实现上两者相差无几，没有明显的性能差异或重大问题。\n- 文档丰富程度上，requireJS远远好于SeaJS，就拿最简单的加载jQuery和jQuery插件这回事，虽然两者的实现方法相差无几，但requireJS就有可以直接拿来用的Demo，SeaJS还要读文档自己慢慢折腾。一些问题的解决上，requireJS为关键词也更容易找到答案。\n#### requireJS 加载jQuery + jQuery插件\n\n可能对于一般Web App来说，引入jQuery及相关插件的概率是最大的，requireJS也亲切的给出了相应的解决方案及[动态加载jQuery及插件](http://requirejs.org/docs/jquery.html)的文档及[实例代码](http://requirejs.org/docs/download.html#samplejquery)。\n\n在最新的jQuery1.9.X中，jQuery已经在最后直接将自己注册为一个[AMD模块](https://github.com/amdjs/amdjs-api/wiki/AMD)，即是说可以直接被requireJS作为模块加载。如果是加载旧版的jQuery有两种方法：\n\n**1. 让jQuery先于requireJS加载**\n\n**2. 对jQuery代码稍做一点处理，在jQuery代码包裹一句：**\n\n``` js\ndefine([\"jquery\"], function($) {\n    // $ is guaranteed to be jQuery now */\n});\n```\n\nrequireJS的示例中，直接将requireJS与jQuery合并为一个文件，如果是采用jQuery作为核心库的话推荐这种做法。\n\n同样对于jQuery插件来说也有两种方法\n\n**1. 在插件外包裹代码**\n\n``` js\ndefine([\"jquery\"], function($){\n     // Put here the plugin code. \n});\n```\n\n**2. 在使用reuqireJS代码加载前注册插件（比如在main.js）中**\n\n``` js\nrequirejs.config({\n    \"shim\": {\n        \"jquery-cookie\"  : [\"jquery\"]\n    }\n});\n```\n#### requireJS加载第三方类库\n\n在实例的App中还用到了jQuery以外的第三方类库，如果类库不是一个标准的AMD模块而又不想更改这些类库的代码，同样需要提前进行定义：\n\n``` js\nrequire.config({\n      paths: {\n            'underscore': 'vendor/underscore'\n      },\n      shim: {\n          underscore: {\n              exports: '_'\n          }\n      }\n});\n```\n#### CSS文件的模块化处理\n\n在requireJS中，模块的概念仅限于JS文件，如果需要加载图片、JSON等非JS文件，requireJS实现了一系列[加载插件](http://requirejs.org/docs/plugins.html)。\n\n但是遗憾的是requireJS官方没有对CSS进行模块化处理，而我们在实际项目中却往往能遇到一些场景，比如一个轮播的图片展示栏，比如高级编辑器等等。几乎所有的富UI组件都会由JS与CSS两部分构成，而CSS之间也存在着模块的概念以及依赖关系。\n\n为了更好的与requireJS整合，这里采用[require-css](https://github.com/guybedford/require-css)来解决CSS的模块化与依赖问题。\n\nrequire-css是一个requireJS插件，下载后将`css.js`与`normalize.js`放于main.js同级即可默认被加载，比如在我们的项目中需要加载jQuery Mobile的css文件，那么可以直接这样调用：\n\n``` js\nrequire(['jquery', 'css!../css/jquery.mobile-1.3.0.min.css'], function($) {\n});\n```\n\n不过由于这个CSS本质上是属于jQuery Mobile模块的一部分，更好的做法是将这个CSS文件的定义放在jQuery Mobile的依赖关系中，最终我们的requireJS定义部分为：\n\n``` js\nrequire.config({\n      paths: {\n            'jquerymobile': 'vendor/jquery.mobile-1.3.0',\n            'jstorage' : 'vendor/jstorage',\n            'underscore': 'vendor/underscore'\n      },\n      shim: {\n          jquerymobile : {\n            deps: [\n                'css!../css/jquery.mobile-1.3.0.min.css'\n            ]\n          },\n          underscore: {\n              exports: '_'\n          }\n      }\n});\n```\n\n在使用模块时，只需要：\n\n``` js\nrequire(['jquery', 'underscore', 'jquerymobile', 'jstorage'], function($, _) {\n});\n```\n\njQuery Mobile的CSS文件就会被自动加载，这样CSS与JS就被整合为一个模块了。同理其他有复杂依赖关系的模块也可以做类似处理，requireJS会解决依赖关系的逻辑。\n### 数据源的加载与等待\n\nWeb App一般都会动态加载后端的数据，数据格式一般可以是JSON、JSONP也可以直接是一个JS变量。这里以JS变量为例\n\n``` js\nvar restaurants = [\n    {\n        \"name\": \"KFC\"\n    },\n    {\n        \"name\": \"7-11\"\n    },\n    {\n        \"name\": \"成都小吃\"\n    }\n]\n```\n\n载入这段数据:\n\n``` js\n$.getScript('data/restaurants.json', function(e){\n    var data = window.restaurants;\n    alert(data[0].name); //KFC\n});\n```\n\n单一的数据源确实很简单，但是往往一个应用中会有多个数据源，比如在这个实例App中UI就需要载入用户信息、餐厅信息、订餐信息三种数据后才能工作。如果仅仅靠多层嵌套回调函数的话，可能代码的耦合就非常重了。\n\n为了解决多个数据加载的问题，我习惯的解决方法是构造一个dataReady事件响应机制。\n\n``` js\nvar foodOrder = {\n\n    //数据载入后要执行的函数暂存在这里\n    dataReadyFunc : []\n\n    //数据源URL及载入状态\n    , dataSource : [\n        { url : 'data/restaurants.json', ready : false, data : null },\n        { url : 'data/users.json', ready : false, data : null },\n        { url : 'data/foods.json', ready : false, data : null }\n    ]\n\n    //检查数据源是否全部载入完毕\n    , isReady : function(){\n        var isReady = true;\n        for(var key in this.dataSource){\n            if(this.dataSource[key].ready !== true){\n                isReady = false;\n            }\n        }\n        return isReady;\n    }\n\n    //数据源全部加载完毕，则逐一运行dataReadyFunc中存放的函数\n    , callReady : function(){\n        if(true === this.isReady()){\n            for(var key in this.dataReadyFunc){\n                this.dataReadyFunc[key]();\n            }\n        }\n    }\n\n    //供外部调用，会将外部输入的函数暂存在dataReadyFunc中\n    , dataReady : function(func){\n        if (typeof func !== 'function') {\n            return false;\n        } \n        this.dataReadyFunc.push(func);\n    }\n\n    , init : function(){\n        var self = this;\n        var _initElement = function(key, url){\n            $.getScript(url, function(e){\n                //每次载入数据后，将数据存放于dataSource中，将ready状态置为true，并调用callReady\n                self.dataSource[key].data = window[key];\n                self.dataSource[key].ready = true;\n                self.callReady();\n            });\n        }\n        for(var key in this.dataSource){\n            _initElement(key, this.dataSource[key].url);\n        }\n    }\n}\n```\n\n用法为\n\n``` js\nfoodOrder.dataReady(function(){\n   alert(1);     \n});\nfoodOrder.init();\n```\n\ndataReady内的alert将会在所有数据载入完毕后开始执行。\n\n这段处理的逻辑并不复杂，将所有要执行的方法通过dataReady暂存起来，等待数据全部加载完毕后再执行，更加复杂的场景此方法仍然通用。\n### 使用JS模板引擎\n\n数据载入后，最终都会以某种形式显示在页面上。简单情况，我们可能会这样做：\n\n``` js\n$('body').append('<div>' + data.name + '</div>');\n```\n\n如果页面逻辑一旦复杂，比如需要有if判断或者多层循环时，这种连接字符串的方式就相形见绌了，而这也就催生出了JS模板引擎。\n\n主流的JS模板引擎有[underscore.js](http://documentcloud.github.com/underscore/)，[Jade](http://jade-lang.com/)，[EJS](http://embeddedjs.com/)等等，可以[横向对比一下这些JS模板引擎的优缺点](http://engineering.linkedin.com/frontend/client-side-templating-throwdown-mustache-handlebars-dustjs-and-more)。\n\n对于相对简单的页面逻辑（只需要支持if和for/each）来说，我更倾向选用轻巧的underscore.js或者[JavaScript Templates](https://github.com/blueimp/JavaScript-Templates)。\n\n在当前例子中，使用underscore.js生成列表就非常简单了，页面模板为：\n\n``` html\n<ul data-role=\"listview\" data-inset=\"true\">\n<script id=\"tmpl-restaurants\" type=\"text/template\">\n    <% _.each(data, function(restaurant) { %>\n        <li>\n            <a href=\"#\" data-rel=\"back\" data-value=\"<%- restaurant.name%>\"><%- restaurant.name%></a>\n        </li>\n    <% }); %>\n</script>\n</ul>\n```\n\n调用引擎\n\n``` js\n$(\"#tmpl-restaurants\").replaceWith(\n    _.template($(\"#tmpl-restaurants\").html(), {\n        data : restaurants\n    })\n);\n```\n### 面向对象与模块化\n\n通过上面这些工具的组合，我们有了模块的概念，有了模板引擎，有数据的加载。最终还是要通过javascript将这一切组织在一起并加入应用所需要的逻辑。为了能最大限度的复用代码，用面向对象的方式去组织内容是比较好的选择。\n\nJavaScript虽然原生并不支持面向对象，但是依然可以通过很多方式模拟出面向对象的特性。例子中采用了我个人比较喜欢的一种方式是：\n\n``` js\nvar foodOrder = function(ui, options){\n    //构造函数\n    this.init(ui, options);\n}\nfoodOrder.prototype = {\n   defaultUI :  {\n       form : '#form-order'\n   }\n   , defaultOptions : {\n       debug : false\n   }\n   , init : function(ui, options){\n       this.ui = $.extend({}, this.defaultUI, ui);\n       this.options = $.extend({}, this.defaultOptions, options);\n   }\n}\nvar order = new foodOrder({\n    form : '#real-form'\n}, {\n    debug : true\n});\n```\n\n将页面的UI元素以及配置项目抽象出来，在实际构造对象时则可以通过入口参数复写，可以分离整个项目的逻辑与UI，使处理的方式更加灵活。\n\n---\n\n**2013-07-02 19:08:09**\n"}}}